# 图书APP用户模块设计文档

## 1. 概述

本文档详细描述了图书APP用户模块的设计方案，包括数据库表结构、字段说明、索引设计和业务逻辑。

**应用场景**: 图书阅读、借阅、购买、评论、书单分享等功能的用户管理系统。

---

## 2. 数据库表设计

### 2.1 用户基础信息表 (users)

存储用户的核心认证和基础信息。

```sql
CREATE TABLE users (
    -- 主键和基础标识
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '用户ID',
    uuid VARCHAR(36) UNIQUE NOT NULL COMMENT '用户UUID，全局唯一标识',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT '用户名，用于登录',

    -- 认证信息
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希值（bcrypt加密）',
    phone_number VARCHAR(20) UNIQUE COMMENT '手机号（加密存储）',
    phone_verified BOOLEAN DEFAULT FALSE COMMENT '手机号是否已验证',
    email VARCHAR(100) UNIQUE COMMENT '邮箱地址',
    email_verified BOOLEAN DEFAULT FALSE COMMENT '邮箱是否已验证',

    -- 账户状态
    status TINYINT DEFAULT 1 COMMENT '账户状态：1-正常 2-冻结 3-注销 4-待激活',
    is_verified BOOLEAN DEFAULT FALSE COMMENT '是否实名认证',

    -- 角色和权限
    role ENUM('user', 'admin', 'super_admin', 'vip') DEFAULT 'user' COMMENT '用户角色',

    -- 会员信息
    member_level TINYINT DEFAULT 0 COMMENT '会员等级：0-普通 1-铜牌 2-银牌 3-金牌 4-钻石',
    member_expire_at DATETIME COMMENT '会员到期时间',

    -- 安全信息
    failed_login_attempts INT DEFAULT 0 COMMENT '连续登录失败次数',
    locked_until DATETIME COMMENT '账户锁定截止时间',
    last_login_at DATETIME COMMENT '最后登录时间',
    last_login_ip VARCHAR(45) COMMENT '最后登录IP（支持IPv6）',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME COMMENT '删除时间（软删除）',

    -- 索引
    INDEX idx_username (username),
    INDEX idx_phone (phone_number),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_created_at (created_at),
    INDEX idx_deleted_at (deleted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户基础信息表';
```

---

### 2.2 用户详细资料表 (user_profiles)

存储用户的详细个人资料信息，与用户表一对一关系。

```sql
CREATE TABLE user_profiles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '资料ID',
    user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 个人信息
    nickname VARCHAR(50) COMMENT '昵称/显示名称',
    real_name VARCHAR(50) COMMENT '真实姓名（加密存储）',
    avatar_url VARCHAR(255) COMMENT '头像URL',
    gender TINYINT COMMENT '性别：0-未知 1-男 2-女',
    birthday DATE COMMENT '生日',

    -- 地理位置
    country VARCHAR(50) COMMENT '国家',
    province VARCHAR(50) COMMENT '省份',
    city VARCHAR(50) COMMENT '城市',
    address VARCHAR(255) COMMENT '详细地址',

    -- 个人描述
    bio TEXT COMMENT '个人简介',
    signature VARCHAR(255) COMMENT '个性签名',

    -- 社交信息
    wechat VARCHAR(50) COMMENT '微信号',
    qq VARCHAR(20) COMMENT 'QQ号',
    weibo VARCHAR(50) COMMENT '微博账号',

    -- 统计数据（图书APP特有）
    followers_count INT DEFAULT 0 COMMENT '粉丝数',
    following_count INT DEFAULT 0 COMMENT '关注数',
    books_read_count INT DEFAULT 0 COMMENT '已读图书数量',
    reading_days INT DEFAULT 0 COMMENT '累计阅读天数',
    reading_minutes INT DEFAULT 0 COMMENT '累计阅读分钟数',
    reviews_count INT DEFAULT 0 COMMENT '发表书评数',
    book_lists_count INT DEFAULT 0 COMMENT '创建书单数',
    points INT DEFAULT 0 COMMENT '阅读积分',
    balance DECIMAL(10, 2) DEFAULT 0.00 COMMENT '账户余额',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_nickname (nickname),
    INDEX idx_city (city)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户详细资料表';
```

---

### 2.3 第三方登录绑定表 (user_oauth_bindings)

存储用户与第三方平台（微信、QQ、Apple等）的绑定关系。

```sql
CREATE TABLE user_oauth_bindings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '绑定ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 第三方平台信息
    provider VARCHAR(20) NOT NULL COMMENT '第三方平台：wechat/qq/apple/google等',
    provider_user_id VARCHAR(100) NOT NULL COMMENT '第三方平台的用户ID',
    openid VARCHAR(100) COMMENT '第三方平台OpenID',
    unionid VARCHAR(100) COMMENT '第三方平台UnionID',

    -- 第三方用户信息
    provider_nickname VARCHAR(100) COMMENT '第三方平台昵称',
    provider_avatar VARCHAR(255) COMMENT '第三方平台头像',

    -- 访问令牌
    access_token TEXT COMMENT '访问令牌（加密存储）',
    refresh_token TEXT COMMENT '刷新令牌（加密存储）',
    expires_at DATETIME COMMENT '令牌过期时间',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '绑定时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_provider_openid (provider, openid),
    INDEX idx_user_id (user_id),
    INDEX idx_provider (provider)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='第三方登录绑定表';
```

---

### 2.4 用户设备表 (user_devices)

记录用户登录的设备信息，用于多设备管理和安全监控。

```sql
CREATE TABLE user_devices (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '设备ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 设备信息
    device_id VARCHAR(100) UNIQUE NOT NULL COMMENT '设备唯一标识',
    device_name VARCHAR(100) COMMENT '设备名称',
    device_type VARCHAR(20) COMMENT '设备类型：ios/android/web/desktop',
    os_version VARCHAR(50) COMMENT '操作系统版本',
    app_version VARCHAR(20) COMMENT 'APP版本号',

    -- 设备详情
    brand VARCHAR(50) COMMENT '设备品牌',
    model VARCHAR(50) COMMENT '设备型号',
    screen_resolution VARCHAR(20) COMMENT '屏幕分辨率',

    -- 令牌信息
    push_token VARCHAR(255) COMMENT '推送令牌（用于消息推送）',
    refresh_token VARCHAR(255) UNIQUE COMMENT '刷新令牌',

    -- 登录信息
    last_active_at DATETIME COMMENT '最后活跃时间',
    last_ip VARCHAR(45) COMMENT '最后登录IP',
    login_count INT DEFAULT 1 COMMENT '登录次数',

    -- 状态
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否活跃设备',
    is_trusted BOOLEAN DEFAULT FALSE COMMENT '是否受信任设备',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '首次登录时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_device_id (device_id),
    INDEX idx_last_active (last_active_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户设备表';
```

---

### 2.5 用户偏好设置表 (user_preferences)

存储用户的个性化设置和偏好。

```sql
CREATE TABLE user_preferences (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '设置ID',
    user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 基础设置
    language VARCHAR(10) DEFAULT 'zh-CN' COMMENT '语言偏好',
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai' COMMENT '时区',
    theme VARCHAR(20) DEFAULT 'light' COMMENT '主题：light/dark/auto',

    -- 通知设置
    notification_enabled BOOLEAN DEFAULT TRUE COMMENT '是否启用通知',
    email_notification BOOLEAN DEFAULT TRUE COMMENT '邮件通知',
    sms_notification BOOLEAN DEFAULT FALSE COMMENT '短信通知',
    push_notification BOOLEAN DEFAULT TRUE COMMENT '推送通知',

    -- 隐私设置
    profile_visible BOOLEAN DEFAULT TRUE COMMENT '个人资料是否公开',
    show_online_status BOOLEAN DEFAULT TRUE COMMENT '是否显示在线状态',
    allow_search BOOLEAN DEFAULT TRUE COMMENT '是否允许被搜索',
    allow_friend_request BOOLEAN DEFAULT TRUE COMMENT '是否允许好友请求',

    -- 阅读偏好（图书APP特有）
    font_size TINYINT DEFAULT 16 COMMENT '阅读字体大小',
    font_family VARCHAR(50) DEFAULT 'system' COMMENT '字体样式',
    line_spacing DECIMAL(3, 1) DEFAULT 1.5 COMMENT '行间距',
    page_mode VARCHAR(20) DEFAULT 'scroll' COMMENT '翻页模式：scroll/flip/slide',
    reading_background VARCHAR(20) DEFAULT 'white' COMMENT '阅读背景：white/sepia/night',
    auto_bookmark BOOLEAN DEFAULT TRUE COMMENT '自动保存书签',
    reading_reminder BOOLEAN DEFAULT FALSE COMMENT '阅读提醒',
    preferred_genres JSON COMMENT '偏好的图书分类（JSON数组）',

    -- 内容偏好
    content_filter_level TINYINT DEFAULT 1 COMMENT '内容过滤级别：0-无 1-低 2-中 3-高',
    auto_play_audio BOOLEAN DEFAULT FALSE COMMENT '是否自动播放有声书',
    data_saver_mode BOOLEAN DEFAULT FALSE COMMENT '省流量模式',

    -- 扩展字段（JSON格式）
    extra_settings JSON COMMENT '额外的自定义设置',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户偏好设置表';
```

---

### 2.6 用户登录日志表 (user_login_logs)

记录用户的登录历史，用于安全审计和行为分析。

```sql
CREATE TABLE user_login_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '日志ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 登录信息
    login_type ENUM('password', 'sms', 'email', 'oauth', 'qrcode') NOT NULL COMMENT '登录方式',
    login_status ENUM('success', 'failed', 'blocked') NOT NULL COMMENT '登录状态',
    fail_reason VARCHAR(255) COMMENT '失败原因',

    -- 设备和网络信息
    device_id VARCHAR(100) COMMENT '设备ID',
    device_type VARCHAR(20) COMMENT '设备类型',
    ip_address VARCHAR(45) COMMENT '登录IP地址',
    location VARCHAR(100) COMMENT '登录地理位置',
    user_agent TEXT COMMENT '用户代理字符串',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '登录时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_login_status (login_status),
    INDEX idx_ip_address (ip_address)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户登录日志表';
```

---

### 2.7 用户实名认证表 (user_verifications)

存储用户的实名认证信息。

```sql
CREATE TABLE user_verifications (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '认证ID',
    user_id BIGINT UNIQUE NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 认证信息
    verification_type ENUM('id_card', 'passport', 'business_license') NOT NULL COMMENT '认证类型',
    real_name VARCHAR(50) NOT NULL COMMENT '真实姓名（加密存储）',
    id_number VARCHAR(100) NOT NULL COMMENT '证件号码（加密存储）',

    -- 证件照片
    id_card_front_url VARCHAR(255) COMMENT '证件正面照URL',
    id_card_back_url VARCHAR(255) COMMENT '证件背面照URL',
    face_photo_url VARCHAR(255) COMMENT '人脸照片URL',

    -- 认证状态
    status ENUM('pending', 'approved', 'rejected', 'expired') DEFAULT 'pending' COMMENT '认证状态',
    reject_reason VARCHAR(255) COMMENT '拒绝原因',

    -- 审核信息
    reviewer_id BIGINT COMMENT '审核人ID',
    reviewed_at DATETIME COMMENT '审核时间',

    -- 时间戳
    submitted_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '提交时间',
    approved_at DATETIME COMMENT '通过时间',
    expires_at DATETIME COMMENT '认证过期时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_status (status),
    INDEX idx_submitted_at (submitted_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户实名认证表';
```

---

### 2.8 用户权限表 (user_permissions)

存储用户的详细权限配置。

```sql
CREATE TABLE user_permissions (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '权限ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 权限信息
    permission_key VARCHAR(100) NOT NULL COMMENT '权限键名',
    permission_name VARCHAR(100) COMMENT '权限名称',
    permission_value BOOLEAN DEFAULT TRUE COMMENT '权限值',

    -- 权限范围
    resource_type VARCHAR(50) COMMENT '资源类型',
    resource_id VARCHAR(100) COMMENT '资源ID',

    -- 有效期
    valid_from DATETIME COMMENT '生效时间',
    valid_until DATETIME COMMENT '失效时间',

    -- 授权信息
    granted_by BIGINT COMMENT '授权人ID',
    granted_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '授权时间',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_permission (user_id, permission_key, resource_type, resource_id),
    INDEX idx_permission_key (permission_key),
    INDEX idx_valid_until (valid_until)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户权限表';
```

---

## 3. 表关系图

```
users (用户基础信息表)
  ├── 1:1 → user_profiles (用户详细资料表)
  ├── 1:N → user_oauth_bindings (第三方登录绑定表)
  ├── 1:N → user_devices (用户设备表)
  ├── 1:1 → user_preferences (用户偏好设置表)
  ├── 1:N → user_login_logs (用户登录日志表)
  ├── 1:1 → user_verifications (用户实名认证表)
  └── 1:N → user_permissions (用户权限表)
```

---

## 4. 字段说明

### 4.1 敏感字段加密

以下字段需要加密存储：
- `users.password_hash` - 使用 bcrypt/argon2 加密
- `users.phone_number` - 使用 AES-256 加密
- `user_profiles.real_name` - 使用 AES-256 加密
- `user_verifications.real_name` - 使用 AES-256 加密
- `user_verifications.id_number` - 使用 AES-256 加密
- `user_oauth_bindings.access_token` - 使用 AES-256 加密
- `user_oauth_bindings.refresh_token` - 使用 AES-256 加密

### 4.2 索引设计原则

1. **唯一索引**：username, email, phone_number, device_id
2. **普通索引**：status, created_at, deleted_at（用于软删除查询）
3. **联合索引**：根据实际查询场景添加，如 (user_id, created_at)
4. **外键索引**：所有外键字段自动建立索引

---

## 5. 业务逻辑说明

### 5.1 用户注册流程

1. 检查用户名/手机号/邮箱是否已存在
2. 密码强度验证（至少8位，包含大小写字母和数字）
3. 创建 users 记录
4. 自动创建 user_profiles 记录（初始化默认值）
5. 自动创建 user_preferences 记录（初始化默认偏好）
6. 发送验证邮件/短信
7. 返回注册成功，生成访问令牌

### 5.2 用户登录流程

1. 根据用户名/手机号/邮箱查询用户
2. 验证密码是否正确
3. 检查账户状态（是否冻结/注销）
4. 检查登录失败次数（超过5次锁定30分钟）
5. 记录登录日志（user_login_logs）
6. 更新最后登录时间和IP
7. 创建/更新设备记录（user_devices）
8. 生成访问令牌和刷新令牌
9. 返回登录成功

### 5.3 第三方登录流程

1. 获取第三方平台授权码
2. 使用授权码换取访问令牌
3. 获取第三方用户信息（openid, unionid等）
4. 查询是否已绑定（user_oauth_bindings）
5. 如果已绑定，直接登录
6. 如果未绑定，创建新用户或绑定到现有用户
7. 保存第三方信息到 user_oauth_bindings
8. 生成访问令牌
9. 返回登录成功

### 5.4 实名认证流程

1. 用户上传证件照片
2. 填写真实姓名和证件号码
3. 提交认证申请（创建 user_verifications 记录）
4. 管理员审核（人工或AI）
5. 更新认证状态（approved/rejected）
6. 如果通过，更新 users.is_verified = TRUE
7. 发送通知给用户

### 5.5 账户安全策略

1. **密码策略**：
   - 最少8位，包含大小写字母、数字和特殊字符
   - 定期提醒修改密码（90天）
   - 禁止使用最近5次使用过的密码

2. **登录保护**：
   - 连续5次登录失败锁定账户30分钟
   - 异地登录发送验证码
   - 新设备登录需要验证

3. **会话管理**：
   - 访问令牌有效期：2小时
   - 刷新令牌有效期：30天
   - 支持单设备登录或多设备登录

---

## 6. 性能优化建议

### 6.1 数据库优化

1. **分表策略**：
   - 用户数超过1000万时，考虑按用户ID范围分表
   - 登录日志表按月分表

2. **缓存策略**：
   - 用户基本信息缓存（Redis，TTL: 1小时）
   - 用户权限缓存（Redis，TTL: 30分钟）
   - 会话令牌缓存（Redis，TTL: 与令牌有效期一致）

3. **读写分离**：
   - 主库处理写操作
   - 从库处理读操作（用户资料、日志查询等）

### 6.2 查询优化

```sql
-- 常用查询示例

-- 1. 用户登录查询（使用索引）
SELECT id, uuid, username, password_hash, status, role
FROM users
WHERE username = ? AND deleted_at IS NULL;

-- 2. 获取用户完整信息（关联查询）
SELECT
    u.*,
    p.nickname, p.avatar_url, p.gender, p.bio,
    pf.language, pf.theme, pf.notification_enabled
FROM users u
LEFT JOIN user_profiles p ON u.id = p.user_id
LEFT JOIN user_preferences pf ON u.id = pf.user_id
WHERE u.id = ?;

-- 3. 查询用户登录历史（分页）
SELECT * FROM user_login_logs
WHERE user_id = ?
ORDER BY created_at DESC
LIMIT 10 OFFSET 0;

-- 4. 统计活跃用户（使用索引）
SELECT COUNT(*) FROM users
WHERE last_login_at >= DATE_SUB(NOW(), INTERVAL 30 DAY)
AND status = 1
AND deleted_at IS NULL;
```

---

## 7. 安全与隐私

### 7.1 数据加密

- 敏感字段使用 AES-256-GCM 加密
- 加密密钥定期轮换（每季度）
- 密钥存储在独立的密钥管理服务（KMS）

### 7.2 数据脱敏

API返回数据时脱敏：
```json
{
  "phone_number": "138****5678",
  "email": "u***@example.com",
  "id_number": "3301**********1234"
}
```

### 7.3 隐私合规

- 支持用户数据导出（GDPR要求）
- 支持用户账户注销（软删除 + 数据匿名化）
- 记录数据访问日志（审计用）

---

## 8. API接口设计示例

### 8.1 用户注册
```
POST /api/v1/auth/register
Content-Type: application/json

{
  "username": "testuser",
  "password": "SecureP@ss123",
  "phone_number": "13800138000",
  "email": "test@example.com"
}
```

### 8.2 用户登录
```
POST /api/v1/auth/login
Content-Type: application/json

{
  "username": "testuser",
  "password": "SecureP@ss123",
  "device_id": "device_12345"
}
```

### 8.3 获取用户信息
```
GET /api/v1/users/me
Authorization: Bearer {access_token}
```

### 8.4 更新用户资料
```
PUT /api/v1/users/profile
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "nickname": "新昵称",
  "bio": "这是我的个人简介",
  "city": "上海"
}
```

---

## 9. 数据字典

### 9.1 用户状态枚举

| 值 | 说明 | 描述 |
|---|---|---|
| 1 | 正常 | 账户正常使用 |
| 2 | 冻结 | 账户被冻结，无法登录 |
| 3 | 注销 | 用户主动注销 |
| 4 | 待激活 | 注册后未激活 |

### 9.2 用户角色枚举

| 值 | 说明 | 权限范围 |
|---|---|---|
| user | 普通用户 | 基础功能 |
| vip | VIP用户 | 基础 + 高级功能 |
| admin | 管理员 | 管理后台 |
| super_admin | 超级管理员 | 全部权限 |

### 9.3 会员等级枚举

| 值 | 说明 | 权益 |
|---|---|---|
| 0 | 普通会员 | 基础功能 |
| 1 | 铜牌会员 | 基础 + 折扣 |
| 2 | 银牌会员 | 铜牌 + 优先客服 |
| 3 | 金牌会员 | 银牌 + 专属活动 |
| 4 | 钻石会员 | 全部权益 |

---

## 10. 注意事项

1. **软删除**：所有删除操作使用软删除（设置 deleted_at），不物理删除数据
2. **时区处理**：所有时间字段统一使用 UTC 时间存储，前端显示时转换为用户时区
3. **手机号国际化**：支持国际手机号格式（+86、+1等）
4. **邮箱验证**：使用正则表达式验证邮箱格式
5. **密码重置**：发送重置链接有效期15分钟，使用一次后失效
6. **防刷保护**：同一IP/设备注册限制（每小时最多3个账户）
7. **数据备份**：每日全量备份，实时增量备份

---

## 11. 扩展性考虑

### 11.1 多租户支持

如需支持多租户（企业版），可添加：
```sql
ALTER TABLE users ADD COLUMN tenant_id BIGINT COMMENT '租户ID';
ALTER TABLE users ADD INDEX idx_tenant_id (tenant_id);
```

### 11.2 用户标签系统

支持给用户打标签（用户画像）：
```sql
CREATE TABLE user_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    tag_name VARCHAR(50) NOT NULL,
    tag_value VARCHAR(255),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_tag_name (tag_name)
);
```

### 11.3 用户关系表

支持关注/好友功能：
```sql
CREATE TABLE user_relationships (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    target_user_id BIGINT NOT NULL COMMENT '目标用户ID',
    relationship_type ENUM('follow', 'friend', 'block') NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (target_user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_relationship (user_id, target_user_id, relationship_type)
);
```

---

## 12. 图书APP特有扩展表

### 12.1 用户阅读记录表 (user_reading_records)

记录用户的阅读历史和进度。

```sql
CREATE TABLE user_reading_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '记录ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',
    book_id BIGINT NOT NULL COMMENT '图书ID',

    -- 阅读状态
    reading_status ENUM('reading', 'finished', 'abandoned', 'want_to_read') DEFAULT 'reading' COMMENT '阅读状态',
    reading_progress DECIMAL(5, 2) DEFAULT 0.00 COMMENT '阅读进度（百分比）',
    current_page INT DEFAULT 0 COMMENT '当前页码',
    current_chapter_id BIGINT COMMENT '当前章节ID',

    -- 阅读时间
    start_reading_at DATETIME COMMENT '开始阅读时间',
    last_reading_at DATETIME COMMENT '最后阅读时间',
    finished_at DATETIME COMMENT '完成阅读时间',
    reading_duration INT DEFAULT 0 COMMENT '累计阅读时长（分钟）',

    -- 阅读统计
    reading_count INT DEFAULT 1 COMMENT '阅读次数',
    bookmark_count INT DEFAULT 0 COMMENT '书签数量',
    note_count INT DEFAULT 0 COMMENT '笔记数量',

    -- 评分
    rating TINYINT COMMENT '用户评分（1-5星）',
    is_favorite BOOLEAN DEFAULT FALSE COMMENT '是否收藏',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_book (user_id, book_id),
    INDEX idx_user_id (user_id),
    INDEX idx_reading_status (reading_status),
    INDEX idx_last_reading_at (last_reading_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户阅读记录表';
```

### 12.2 用户书签表 (user_bookmarks)

保存用户的阅读书签。

```sql
CREATE TABLE user_bookmarks (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '书签ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',
    book_id BIGINT NOT NULL COMMENT '图书ID',
    chapter_id BIGINT COMMENT '章节ID',

    -- 书签位置
    page_number INT COMMENT '页码',
    position_percentage DECIMAL(5, 2) COMMENT '位置百分比',
    position_text VARCHAR(255) COMMENT '书签位置的文本片段',

    -- 书签信息
    bookmark_name VARCHAR(100) COMMENT '书签名称',
    bookmark_note TEXT COMMENT '书签备注',
    bookmark_color VARCHAR(20) DEFAULT 'yellow' COMMENT '书签颜色',

    -- 类型
    bookmark_type ENUM('auto', 'manual') DEFAULT 'manual' COMMENT '书签类型：自动/手动',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_book (user_id, book_id),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户书签表';
```

### 12.3 用户阅读笔记表 (user_reading_notes)

记录用户的阅读笔记和划线。

```sql
CREATE TABLE user_reading_notes (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '笔记ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',
    book_id BIGINT NOT NULL COMMENT '图书ID',
    chapter_id BIGINT COMMENT '章节ID',

    -- 笔记位置
    page_number INT COMMENT '页码',
    start_position INT COMMENT '开始位置',
    end_position INT COMMENT '结束位置',

    -- 笔记内容
    note_type ENUM('highlight', 'note', 'thought') DEFAULT 'note' COMMENT '笔记类型：划线/笔记/想法',
    highlighted_text TEXT COMMENT '划线的原文',
    note_content TEXT COMMENT '笔记内容',
    note_color VARCHAR(20) DEFAULT 'yellow' COMMENT '标注颜色',

    -- 分享和互动
    is_public BOOLEAN DEFAULT FALSE COMMENT '是否公开',
    likes_count INT DEFAULT 0 COMMENT '点赞数',
    comments_count INT DEFAULT 0 COMMENT '评论数',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME COMMENT '删除时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_book (user_id, book_id),
    INDEX idx_note_type (note_type),
    INDEX idx_is_public (is_public),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户阅读笔记表';
```

### 12.4 用户书单表 (user_book_lists)

用户创建的书单（书籍合集）。

```sql
CREATE TABLE user_book_lists (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '书单ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 书单信息
    list_name VARCHAR(100) NOT NULL COMMENT '书单名称',
    list_description TEXT COMMENT '书单描述',
    cover_image_url VARCHAR(255) COMMENT '书单封面图',

    -- 书单属性
    is_public BOOLEAN DEFAULT TRUE COMMENT '是否公开',
    allow_contribute BOOLEAN DEFAULT FALSE COMMENT '是否允许他人推荐图书',
    list_category VARCHAR(50) COMMENT '书单分类',

    -- 统计数据
    books_count INT DEFAULT 0 COMMENT '图书数量',
    followers_count INT DEFAULT 0 COMMENT '关注数',
    likes_count INT DEFAULT 0 COMMENT '点赞数',
    shares_count INT DEFAULT 0 COMMENT '分享数',
    views_count INT DEFAULT 0 COMMENT '浏览次数',

    -- 排序
    display_order INT DEFAULT 0 COMMENT '显示顺序',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
    deleted_at DATETIME COMMENT '删除时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_is_public (is_public),
    INDEX idx_created_at (created_at),
    INDEX idx_books_count (books_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户书单表';
```

### 12.5 用户书单详情表 (user_book_list_items)

书单中的图书列表。

```sql
CREATE TABLE user_book_list_items (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '项目ID',
    list_id BIGINT NOT NULL COMMENT '书单ID，外键关联user_book_lists.id',
    book_id BIGINT NOT NULL COMMENT '图书ID',

    -- 推荐信息
    recommendation_reason TEXT COMMENT '推荐理由',
    added_by BIGINT COMMENT '添加人ID（允许他人推荐时使用）',

    -- 排序
    display_order INT DEFAULT 0 COMMENT '显示顺序',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '添加时间',

    -- 外键和索引
    FOREIGN KEY (list_id) REFERENCES user_book_lists(id) ON DELETE CASCADE,
    UNIQUE KEY uk_list_book (list_id, book_id),
    INDEX idx_list_id (list_id),
    INDEX idx_book_id (book_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户书单详情表';
```

### 12.6 用户阅读目标表 (user_reading_goals)

用户设置的阅读目标（挑战）。

```sql
CREATE TABLE user_reading_goals (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '目标ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 目标信息
    goal_type ENUM('daily', 'weekly', 'monthly', 'yearly', 'custom') NOT NULL COMMENT '目标类型',
    goal_name VARCHAR(100) COMMENT '目标名称',
    goal_description TEXT COMMENT '目标描述',

    -- 目标数值
    target_books_count INT COMMENT '目标阅读书籍数量',
    target_reading_minutes INT COMMENT '目标阅读分钟数',
    target_pages_count INT COMMENT '目标阅读页数',

    -- 进度
    current_books_count INT DEFAULT 0 COMMENT '当前已读书籍数',
    current_reading_minutes INT DEFAULT 0 COMMENT '当前阅读分钟数',
    current_pages_count INT DEFAULT 0 COMMENT '当前阅读页数',

    -- 时间范围
    start_date DATE NOT NULL COMMENT '开始日期',
    end_date DATE NOT NULL COMMENT '结束日期',

    -- 状态
    status ENUM('in_progress', 'completed', 'failed', 'abandoned') DEFAULT 'in_progress' COMMENT '目标状态',
    completed_at DATETIME COMMENT '完成时间',

    -- 奖励
    reward_points INT DEFAULT 0 COMMENT '完成奖励积分',
    badge_id BIGINT COMMENT '完成获得的徽章ID',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_goal_type (goal_type),
    INDEX idx_status (status),
    INDEX idx_end_date (end_date)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户阅读目标表';
```

### 12.7 用户成就徽章表 (user_achievements)

用户获得的成就和徽章。

```sql
CREATE TABLE user_achievements (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '成就ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 成就信息
    achievement_code VARCHAR(50) NOT NULL COMMENT '成就代码',
    achievement_name VARCHAR(100) COMMENT '成就名称',
    achievement_description TEXT COMMENT '成就描述',
    badge_icon_url VARCHAR(255) COMMENT '徽章图标URL',

    -- 成就等级
    achievement_level TINYINT DEFAULT 1 COMMENT '成就等级',
    achievement_points INT DEFAULT 0 COMMENT '成就积分',

    -- 获得方式
    trigger_type VARCHAR(50) COMMENT '触发类型：read_books/continuous_days/reviews等',
    trigger_value INT COMMENT '触发数值',

    -- 时间戳
    unlocked_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '解锁时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_achievement (user_id, achievement_code),
    INDEX idx_user_id (user_id),
    INDEX idx_achievement_code (achievement_code),
    INDEX idx_unlocked_at (unlocked_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户成就徽章表';
```

### 12.8 用户阅读统计表 (user_reading_statistics)

按时间维度统计用户的阅读数据。

```sql
CREATE TABLE user_reading_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '统计ID',
    user_id BIGINT NOT NULL COMMENT '用户ID，外键关联users.id',

    -- 统计维度
    stat_date DATE NOT NULL COMMENT '统计日期',
    stat_type ENUM('daily', 'weekly', 'monthly', 'yearly') NOT NULL COMMENT '统计类型',

    -- 阅读统计
    books_read INT DEFAULT 0 COMMENT '阅读书籍数',
    chapters_read INT DEFAULT 0 COMMENT '阅读章节数',
    pages_read INT DEFAULT 0 COMMENT '阅读页数',
    reading_minutes INT DEFAULT 0 COMMENT '阅读分钟数',
    reading_sessions INT DEFAULT 0 COMMENT '阅读会话次数',

    -- 互动统计
    reviews_written INT DEFAULT 0 COMMENT '发表书评数',
    notes_created INT DEFAULT 0 COMMENT '创建笔记数',
    bookmarks_added INT DEFAULT 0 COMMENT '添加书签数',
    books_shared INT DEFAULT 0 COMMENT '分享书籍数',

    -- 积分统计
    points_earned INT DEFAULT 0 COMMENT '获得积分',
    achievements_unlocked INT DEFAULT 0 COMMENT '解锁成就数',

    -- 时间戳
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',

    -- 外键和索引
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_stat (user_id, stat_date, stat_type),
    INDEX idx_user_id (user_id),
    INDEX idx_stat_date (stat_date),
    INDEX idx_stat_type (stat_type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='用户阅读统计表';
```

---

## 13. 图书APP表关系扩展图

```
users (用户基础信息表)
  ├── 1:1 → user_profiles (用户详细资料表)
  ├── 1:N → user_oauth_bindings (第三方登录绑定表)
  ├── 1:N → user_devices (用户设备表)
  ├── 1:1 → user_preferences (用户偏好设置表)
  ├── 1:N → user_login_logs (用户登录日志表)
  ├── 1:1 → user_verifications (用户实名认证表)
  ├── 1:N → user_permissions (用户权限表)
  │
  └── 图书APP特有关系
      ├── 1:N → user_reading_records (阅读记录表)
      ├── 1:N → user_bookmarks (书签表)
      ├── 1:N → user_reading_notes (阅读笔记表)
      ├── 1:N → user_book_lists (书单表)
      │   └── 1:N → user_book_list_items (书单详情表)
      ├── 1:N → user_reading_goals (阅读目标表)
      ├── 1:N → user_achievements (成就徽章表)
      └── 1:N → user_reading_statistics (阅读统计表)
```

---

## 14. 图书APP特有业务逻辑

### 14.1 阅读时长统计

每次用户打开图书进行阅读时：
1. 记录开始阅读时间
2. 前端定时上报阅读状态（每30秒）
3. 用户关闭或切换时，计算阅读时长
4. 更新 `user_reading_records.reading_duration`
5. 更新 `user_profiles.reading_minutes`
6. 更新当日的 `user_reading_statistics`

### 14.2 阅读进度自动保存

1. 用户阅读时，每翻一页或滚动到新位置
2. 自动更新 `user_reading_records.current_page` 和 `reading_progress`
3. 如果启用自动书签，创建/更新自动书签
4. 下次打开时，自动跳转到上次阅读位置

### 14.3 阅读目标检查

每日定时任务（凌晨）：
1. 检查所有进行中的阅读目标
2. 更新目标进度（从统计表获取数据）
3. 判断是否完成目标
4. 如果完成，发放奖励（积分、徽章）
5. 如果过期未完成，标记为失败

### 14.4 成就解锁机制

触发条件示例：
- **初出茅庐**: 完成第一本书阅读
- **勤奋读者**: 连续阅读7天
- **阅读达人**: 累计阅读100本书
- **笔记专家**: 创建100条阅读笔记
- **分享之星**: 书单被收藏超过1000次
- **速读高手**: 单日阅读超过300分钟

解锁流程：
1. 用户行为触发（完成阅读、创建笔记等）
2. 检查成就条件（从统计数据判断）
3. 如果满足条件，解锁成就
4. 插入 `user_achievements` 记录
5. 发放积分奖励
6. 推送通知给用户

### 14.5 书单推荐算法

基于用户数据推荐书单：
1. 分析用户的阅读历史（`user_reading_records`）
2. 提取用户偏好类型（`user_preferences.preferred_genres`）
3. 查找包含相似图书的公开书单
4. 按书单热度、匹配度排序推荐
5. 过滤用户已关注的书单

---

## 15. 图书APP API接口扩展示例

### 15.1 开始阅读
```
POST /api/v1/reading/start
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "book_id": 12345,
  "chapter_id": 1
}
```

### 15.2 更新阅读进度
```
PUT /api/v1/reading/progress
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "book_id": 12345,
  "current_page": 156,
  "reading_progress": 45.5,
  "reading_duration_seconds": 1800
}
```

### 15.3 创建阅读笔记
```
POST /api/v1/notes
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "book_id": 12345,
  "chapter_id": 5,
  "page_number": 120,
  "note_type": "highlight",
  "highlighted_text": "这是一段重要的内容",
  "note_content": "我的思考和感悟",
  "note_color": "yellow"
}
```

### 15.4 获取用户阅读统计
```
GET /api/v1/users/me/reading-stats?period=monthly
Authorization: Bearer {access_token}

Response:
{
  "period": "2025-10",
  "books_read": 5,
  "reading_minutes": 2450,
  "reading_days": 18,
  "pages_read": 1280,
  "favorite_genres": ["科幻", "历史", "心理学"],
  "reading_streak": 7
}
```

### 15.5 创建书单
```
POST /api/v1/book-lists
Authorization: Bearer {access_token}
Content-Type: application/json

{
  "list_name": "2025年必读书单",
  "list_description": "精选的年度好书推荐",
  "is_public": true,
  "list_category": "推荐",
  "books": [
    {
      "book_id": 101,
      "recommendation_reason": "这本书改变了我的思维方式"
    },
    {
      "book_id": 102,
      "recommendation_reason": "作者的文笔非常优美"
    }
  ]
}
```

---

## 16. 总结

本图书APP用户模块设计涵盖了：

### 基础功能
- ✅ 完整的用户认证和授权体系
- ✅ 第三方登录集成（微信、QQ、Apple等）
- ✅ 实名认证支持
- ✅ 多设备管理
- ✅ 详细的日志审计
- ✅ 灵活的权限控制
- ✅ 安全与隐私保护

### 图书APP特有功能
- ✅ 阅读记录和进度跟踪
- ✅ 书签和笔记管理
- ✅ 阅读统计和数据分析
- ✅ 书单创建和分享
- ✅ 阅读目标和挑战
- ✅ 成就徽章系统
- ✅ 个性化阅读偏好设置

### 核心表结构（共15张表）

**基础模块（8张表）**：
1. users - 用户基础信息表
2. user_profiles - 用户详细资料表
3. user_oauth_bindings - 第三方登录绑定表
4. user_devices - 用户设备表
5. user_preferences - 用户偏好设置表
6. user_login_logs - 用户登录日志表
7. user_verifications - 用户实名认证表
8. user_permissions - 用户权限表

**图书APP扩展（8张表）**：
1. user_reading_records - 阅读记录表
2. user_bookmarks - 书签表
3. user_reading_notes - 阅读笔记表
4. user_book_lists - 书单表
5. user_book_list_items - 书单详情表
6. user_reading_goals - 阅读目标表
7. user_achievements - 成就徽章表
8. user_reading_statistics - 阅读统计表

### 数据量级参考
- **用户基础表**: 支持千万级用户
- **阅读记录表**: 单用户可能有数百条记录
- **笔记表**: 高频使用，需考虑分表
- **统计表**: 按时间维度存储，定期归档

### 性能考虑
1. 热点数据使用Redis缓存
2. 阅读进度实时更新使用队列异步处理
3. 统计数据定时计算，不实时查询
4. 大表按用户ID或时间分表

可根据实际业务需求进行调整和扩展。

---

**文档版本**: 1.0
**应用类型**: 图书阅读APP
**最后更新**: 2025-10-14
**维护人**: Claude Code
