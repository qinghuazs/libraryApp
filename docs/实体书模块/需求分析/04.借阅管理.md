# 借阅管理需求文档

## 1. 概述

### 1.1 功能定位

借阅管理是实体书管理的重要功能，帮助用户记录书籍的借出与归还情况，避免书籍遗失，同时方便管理个人藏书的流转。

### 1.2 核心价值

- **防止遗忘**：清晰记录每本书借给了谁，何时借出
- **催还提醒**：临近预计归还日期自动提醒
- **历史追溯**：完整的借阅历史记录
- **统计分析**：了解哪些书最受欢迎，哪些朋友借书最多

### 1.3 用户场景

| 场景 | 用户需求 | 解决方案 |
|------|---------|---------|
| 朋友借书 | 记录借给谁、何时借的 | 快速登记借阅信息 |
| 忘记谁借了书 | 查询某本书的借阅状态 | 借阅记录查询 |
| 书借了很久 | 提醒朋友还书 | 自动催还提醒 |
| 朋友还书 | 登记归还 | 扫码或手动归还登记 |
| 查看历史 | 了解过去借出记录 | 借阅历史统计 |

---

## 2. 功能模块

### 2.1 功能架构

```
借阅管理
├─ 借出登记
│  ├─ 快速借出（扫码）
│  ├─ 手工登记
│  └─ 批量借出
├─ 归还登记
│  ├─ 扫码归还
│  ├─ 手工归还
│  └─ 批量归还
├─ 借阅查询
│  ├─ 查看在借书籍
│  ├─ 按借阅人筛选
│  └─ 按时间筛选
├─ 催还提醒
│  ├─ 自动提醒
│  ├─ 手动催还
│  └─ 微信/短信提醒
├─ 借阅历史
│  ├─ 个人借阅记录
│  ├─ 书籍借阅历史
│  └─ 导出报表
└─ 统计分析
   ├─ 借阅次数统计
   ├─ 热门书籍TOP10
   └─ 借阅人排行榜
```

---

## 3. 详细设计

### 3.1 借出登记

#### 3.1.1 快速借出（扫码）

**流程图：**

```
扫描书籍二维码/条形码
          ↓
   系统识别书籍信息
          ↓
   检查书籍当前状态
          ↓
    ┌────┴────┐
    │ 已借出？ │
    └────┬────┘
    是 ↓    ↓ 否
  ┌───────┐  ┌───────────┐
  │ 提示  │  │  选择借阅人│
  │ 错误  │  │  设置归还期│
  └───────┘  │  添加备注  │
             └───────────┘
                   ↓
          ┌────────────────┐
          │  确认借出       │
          │  - 更新书籍状态 │
          │  - 创建借阅记录 │
          │  - 设置提醒     │
          └────────────────┘
```

**UI设计：**

```
┌──────────────────────────────────────┐
│  📚 借出登记          [×]            │
├──────────────────────────────────────┤
│                                      │
│  书籍信息                             │
│  ┌────────┐                          │
│  │        │  《三体》                │
│  │  封面  │  刘慈欣 著                │
│  │  图片  │  重庆出版社               │
│  │        │                          │
│  └────────┘  位置：书房-A01-03-05    │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  借阅信息                             │
│                                      │
│  借阅人 *                             │
│  ┌────────────────────────────────┐ │
│  │ 🔍 搜索或新增联系人        ▾   │ │
│  └────────────────────────────────┘ │
│                                      │
│  常用联系人：                         │
│  ┌─────┬─────┬─────┬─────┐         │
│  │张三 │李四 │王五 │赵六 │         │
│  │ 5次│ 3次│ 2次│ 1次│         │
│  └─────┴─────┴─────┴─────┘         │
│                                      │
│  借出日期 *                           │
│  ┌────────────────────────────────┐ │
│  │ 2025-01-15              ▾      │ │
│  └────────────────────────────────┘ │
│                                      │
│  预计归还日期                         │
│  ┌────────────────────────────────┐ │
│  │ 2025-02-15              ▾      │ │
│  └────────────────────────────────┘ │
│  💡 建议归还期：1个月                 │
│                                      │
│  提醒设置                             │
│  ☑ 到期前3天提醒我                   │
│  ☑ 到期后每周提醒一次                │
│                                      │
│  备注（可选）                         │
│  ┌────────────────────────────────┐ │
│  │ 张三很喜欢科幻小说...          │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 取消 ]             [ 确认借出 ]   │
│                                      │
└──────────────────────────────────────┘
```

#### 3.1.2 联系人管理

**联系人选择器：**

```
┌──────────────────────────────────────┐
│  选择借阅人          [ + 新增 ] [×]  │
├──────────────────────────────────────┤
│                                      │
│  🔍 搜索姓名或备注...                 │
│                                      │
│  常借阅人（按借阅次数排序）           │
│  ┌────────────────────────────────┐ │
│  │ ○ 👤 张三                      │ │
│  │   📱 138****5678               │ │
│  │   📊 已借5次 | 全部已还        │ │
│  ├────────────────────────────────┤ │
│  │ ○ 👤 李四                      │ │
│  │   📱 139****1234               │ │
│  │   📊 已借3次 | 当前在借1本     │ │
│  │   ⚠️  《活着》逾期2天           │ │
│  ├────────────────────────────────┤ │
│  │ ○ 👤 王五                      │ │
│  │   📱 136****9876               │ │
│  │   📊 已借2次 | 全部已还        │ │
│  └────────────────────────────────┘ │
│                                      │
│  全部联系人 (26人)                    │
│  [ A ] [ B ] [ C ] ... [ Z ]         │
│                                      │
│  [ 取消 ]             [ 确定 ]       │
│                                      │
└──────────────────────────────────────┘
```

**新增联系人：**

```
┌──────────────────────────────────────┐
│  新增借阅人          [保存] [取消]   │
├──────────────────────────────────────┤
│                                      │
│  姓名 *                               │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  手机号                               │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  微信号（用于发送催还提醒）           │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  关系/备注                            │
│  ┌────────────────────────────────┐ │
│  │ 同事 / 大学同学 / 朋友等...    │ │
│  └────────────────────────────────┘ │
│                                      │
│  ☑ 从通讯录导入                      │
│                                      │
│  [ 取消 ]             [ 保存 ]       │
│                                      │
└──────────────────────────────────────┘
```

#### 3.1.3 批量借出

```
┌──────────────────────────────────────┐
│  📚 批量借出          [完成]         │
├──────────────────────────────────────┤
│                                      │
│  借阅人：张三                         │
│  借出日期：2025-01-15                 │
│  预计归还：2025-02-15                 │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  已选书籍 (3本)        [ + 添加书籍 ] │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ✅ 三体                        │ │
│  │    刘慈欣 | A01-03-05     [删除]│ │
│  ├────────────────────────────────┤ │
│  │ ✅ 三体Ⅱ·黑暗森林              │ │
│  │    刘慈欣 | A01-03-06     [删除]│ │
│  ├────────────────────────────────┤ │
│  │ ✅ 三体Ⅲ·死神永生              │ │
│  │    刘慈欣 | A01-03-07     [删除]│ │
│  └────────────────────────────────┘ │
│                                      │
│  统一设置：                           │
│  ☑ 到期前3天提醒                     │
│  ☑ 到期后每周提醒                    │
│                                      │
│  备注：                               │
│  ┌────────────────────────────────┐ │
│  │ 三体全集                       │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 取消 ]      [ 确认借出全部 ]      │
│                                      │
└──────────────────────────────────────┘
```

---

### 3.2 归还登记

#### 3.2.1 扫码归还

```
┌──────────────────────────────────────┐
│  📖 归还登记          [×]            │
├──────────────────────────────────────┤
│                                      │
│  书籍信息                             │
│  ┌────────┐                          │
│  │        │  《三体》                │
│  │  封面  │  刘慈欣 著                │
│  │  图片  │                          │
│  └────────┘                          │
│                                      │
│  借阅信息                             │
│  借阅人：张三                         │
│  借出日期：2024-12-15                 │
│  预计归还：2025-01-15                 │
│  借阅天数：31天                       │
│  ⚠️  已逾期：0天                      │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  归还信息                             │
│                                      │
│  实际归还日期                         │
│  ┌────────────────────────────────┐ │
│  │ 2025-01-15 (今天)       ▾      │ │
│  └────────────────────────────────┘ │
│                                      │
│  书籍状态                             │
│  ● 完好  ○ 轻微破损  ○ 严重破损     │
│                                      │
│  评价（可选）                         │
│  ⭐⭐⭐⭐⭐                             │
│  ┌────────────────────────────────┐ │
│  │ 张三很爱惜书，书的状态很好     │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 取消 ]             [ 确认归还 ]   │
│                                      │
└──────────────────────────────────────┘
```

#### 3.2.2 逾期处理

```
┌──────────────────────────────────────┐
│  ⚠️  逾期归还          [×]            │
├──────────────────────────────────────┤
│                                      │
│  《三体》已逾期 15 天归还             │
│                                      │
│  借阅信息                             │
│  借阅人：张三                         │
│  借出日期：2024-11-15                 │
│  预计归还：2024-12-15                 │
│  实际归还：2025-01-15                 │
│  逾期天数：15天                       │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  逾期处理（可选）                     │
│                                      │
│  ○ 无需处理（关系好，不计较）         │
│  ○ 友情提醒（下次注意）              │
│  ● 记录逾期（影响信用评分）           │
│  ○ 自定义处理...                     │
│                                      │
│  备注：                               │
│  ┌────────────────────────────────┐ │
│  │ 张三太忙了，多次催还才还       │ │
│  └────────────────────────────────┘ │
│                                      │
│  💡 该借阅人信用评分将从 ⭐⭐⭐⭐⭐   │
│     降至 ⭐⭐⭐⭐                      │
│                                      │
│  [ 取消 ]             [ 确认归还 ]   │
│                                      │
└──────────────────────────────────────┘
```

#### 3.2.3 批量归还

```
┌──────────────────────────────────────┐
│  📚 批量归还          [完成]         │
├──────────────────────────────────────┤
│                                      │
│  归还人：张三                         │
│  归还日期：2025-01-15                 │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  待归还书籍 (3本)                     │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ☑ 三体                         │ │
│  │    借出：2024-12-15 | 正常     │ │
│  ├────────────────────────────────┤ │
│  │ ☑ 三体Ⅱ·黑暗森林               │ │
│  │    借出：2024-12-15 | 正常     │ │
│  ├────────────────────────────────┤ │
│  │ ☑ 三体Ⅲ·死神永生               │ │
│  │    借出：2024-12-15 | 正常     │ │
│  └────────────────────────────────┘ │
│                                      │
│  统一设置：                           │
│  书籍状态：● 完好  ○ 轻微破损        │
│                                      │
│  评价：⭐⭐⭐⭐⭐                       │
│  ┌────────────────────────────────┐ │
│  │ 三本书都保护得很好             │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 取消 ]      [ 确认归还全部 ]      │
│                                      │
└──────────────────────────────────────┘
```

---

### 3.3 借阅查询

#### 3.3.1 在借书籍列表

```
┌──────────────────────────────────────┐
│  📚 在借书籍 (8本)    [筛选▾] [催还] │
├──────────────────────────────────────┤
│                                      │
│  🔍 搜索书名、借阅人...               │
│                                      │
│  [ 全部 ] [ 即将到期 ] [ 已逾期 ]    │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ⚠️  已逾期 (2本)                │ │
│  ├────────────────────────────────┤ │
│  │ 📖 活着                        │ │
│  │    余华                        │ │
│  │    借阅人：李四 📱              │ │
│  │    借出：2024-11-20             │ │
│  │    预计归还：2024-12-20         │ │
│  │    ⚠️  已逾期 26天              │ │
│  │    [ 催还 ] [ 登记归还 ]        │ │
│  ├────────────────────────────────┤ │
│  │ 📖 白夜行                      │ │
│  │    东野圭吾                    │ │
│  │    借阅人：王五 📱              │ │
│  │    借出：2024-12-01             │ │
│  │    预计归还：2025-01-01         │ │
│  │    ⚠️  已逾期 14天              │ │
│  │    [ 催还 ] [ 登记归还 ]        │ │
│  └────────────────────────────────┘ │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ⏰ 即将到期 (3本)               │ │
│  ├────────────────────────────────┤ │
│  │ 📖 三体                        │ │
│  │    刘慈欣                      │ │
│  │    借阅人：张三 📱              │ │
│  │    借出：2024-12-15             │ │
│  │    预计归还：2025-01-15 (今天)  │ │
│  │    [ 提醒 ] [ 登记归还 ]        │ │
│  └────────────────────────────────┘ │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ✅ 正常 (3本)                  │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

#### 3.3.2 按借阅人查询

```
┌──────────────────────────────────────┐
│  👤 借阅人：张三      [详情] [催还]  │
├──────────────────────────────────────┤
│                                      │
│  联系方式                             │
│  📱 138****5678                      │
│  💬 微信：zhangsan123                │
│                                      │
│  借阅统计                             │
│  总借阅次数：5次                      │
│  当前在借：1本                        │
│  历史已还：4本                        │
│  逾期次数：0次                        │
│  信用评分：⭐⭐⭐⭐⭐                   │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  当前在借书籍 (1本)                   │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 📖 三体                        │ │
│  │    刘慈欣                      │ │
│  │    借出：2024-12-15             │ │
│  │    预计归还：2025-01-15 (今天)  │ │
│  │    状态：⏰ 今天到期            │ │
│  │    [ 提醒 ] [ 登记归还 ]        │ │
│  └────────────────────────────────┘ │
│                                      │
│  历史借阅记录 (4本)    [ 查看全部 ]   │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ✅ 活着                        │ │
│  │    借：2024-10-01 ~ 还：10-25   │ │
│  │    借阅天数：24天 (正常)        │ │
│  ├────────────────────────────────┤ │
│  │ ✅ 白夜行                      │ │
│  │    借：2024-08-10 ~ 还：09-05   │ │
│  │    借阅天数：26天 (正常)        │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

---

### 3.4 催还提醒

#### 3.4.1 自动提醒规则

| 提醒时机 | 触发条件 | 提醒方式 | 提醒内容 |
|---------|---------|---------|---------|
| 到期前提醒 | 距离预计归还日期3天 | App推送 + 微信 | "您借阅的《三体》将于3天后到期" |
| 到期当天提醒 | 预计归还日期当天 | App推送 + 微信 | "您借阅的《三体》今天到期，请及时归还" |
| 逾期提醒 | 逾期第1、7、14天 | App推送 + 微信 + 短信 | "您借阅的《三体》已逾期X天，请尽快归还" |

#### 3.4.2 手动催还

```
┌──────────────────────────────────────┐
│  🔔 催还提醒                          │
├──────────────────────────────────────┤
│                                      │
│  催还对象：李四                       │
│  逾期书籍：2本                        │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  书籍列表                             │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ☑ 活着 (逾期26天)              │ │
│  │ ☑ 百年孤独 (逾期12天)          │ │
│  └────────────────────────────────┘ │
│                                      │
│  提醒方式                             │
│  ☑ App内推送                         │
│  ☑ 微信消息                          │
│  ☐ 短信通知 (0.1元/条)               │
│                                      │
│  提醒模板                             │
│  ┌────────────────────────────────┐ │
│  │ 【友情提醒】                   │ │
│  │                                │ │
│  │ 嗨，李四！                     │ │
│  │                                │ │
│  │ 你借的以下书籍已逾期，方便的话  │ │
│  │ 请尽快归还哦：                 │ │
│  │                                │ │
│  │ • 活着 (逾期26天)              │ │
│  │ • 百年孤独 (逾期12天)          │ │
│  │                                │ │
│  │ 如已归还，请忽略此消息😊       │ │
│  │                                │ │
│  │ —— 来自你的朋友 [张三]         │ │
│  └────────────────────────────────┘ │
│                                      │
│  语气：● 友好  ○ 正式  ○ 幽默       │
│                                      │
│  [ 取消 ]             [ 发送提醒 ]   │
│                                      │
└──────────────────────────────────────┘
```

#### 3.4.3 催还历史

```
┌──────────────────────────────────────┐
│  📋 催还记录                          │
├──────────────────────────────────────┤
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 2025-01-15 10:30               │ │
│  │ 催还对象：李四                 │ │
│  │ 书籍：活着、百年孤独           │ │
│  │ 方式：App推送 + 微信           │ │
│  │ 状态：✅ 已发送                │ │
│  │ 结果：⏳ 未读                  │ │
│  ├────────────────────────────────┤ │
│  │ 2025-01-08 14:20               │ │
│  │ 催还对象：李四                 │ │
│  │ 书籍：活着、百年孤独           │ │
│  │ 方式：App推送                  │ │
│  │ 状态：✅ 已发送                │ │
│  │ 结果：✅ 已读 (无回复)         │ │
│  ├────────────────────────────────┤ │
│  │ 2025-01-01 09:00               │ │
│  │ 催还对象：李四                 │ │
│  │ 书籍：活着、百年孤独           │ │
│  │ 方式：微信消息                 │ │
│  │ 状态：✅ 已发送                │ │
│  │ 结果：✅ 已读 (回复"好的")     │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 关闭 ]                            │
│                                      │
└──────────────────────────────────────┘
```

---

### 3.5 借阅历史

#### 3.5.1 个人借阅记录

```
┌──────────────────────────────────────┐
│  📊 借阅历史          [导出] [筛选]  │
├──────────────────────────────────────┤
│                                      │
│  时间范围：[2024年▾] [全部月份▾]     │
│  借阅人：[全部▾]  状态：[全部▾]      │
│                                      │
│  总计：23条记录                       │
│  在借：8本 | 已还：15本               │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  2025年1月 (3条)                      │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 📖 三体                        │ │
│  │    借阅人：张三                │ │
│  │    借出：2024-12-15             │ │
│  │    预计：2025-01-15             │ │
│  │    状态：🔴 在借 (今天到期)     │ │
│  ├────────────────────────────────┤ │
│  │ 📖 活着                        │ │
│  │    借阅人：王五                │ │
│  │    借出：2025-01-05             │ │
│  │    归还：2025-01-12             │ │
│  │    状态：✅ 已还 (借阅7天)      │ │
│  │    评价：⭐⭐⭐⭐⭐              │ │
│  └────────────────────────────────┘ │
│                                      │
│  2024年12月 (8条)    [ 展开 ]        │
│  2024年11月 (5条)    [ 展开 ]        │
│  2024年10月 (7条)    [ 展开 ]        │
│                                      │
└──────────────────────────────────────┘
```

#### 3.5.2 书籍借阅历史

```
┌──────────────────────────────────────┐
│  📖 《三体》借阅历史                  │
├──────────────────────────────────────┤
│                                      │
│  ┌────────┐                          │
│  │        │  《三体》                │
│  │  封面  │  刘慈欣 著                │
│  │  图片  │  重庆出版社               │
│  └────────┘                          │
│                                      │
│  借阅统计                             │
│  总借出次数：8次                      │
│  平均借阅天数：23天                   │
│  逾期次数：1次                        │
│  当前状态：🔴 在借中                  │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  借阅记录 (8次)                       │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 第8次 🔴 在借                  │ │
│  │ 借阅人：张三                   │ │
│  │ 借出：2024-12-15               │ │
│  │ 预计归还：2025-01-15 (今天)     │ │
│  │ 当前天数：31天                 │ │
│  ├────────────────────────────────┤ │
│  │ 第7次 ✅ 已还                  │ │
│  │ 借阅人：李四                   │ │
│  │ 借出：2024-10-01               │ │
│  │ 归还：2024-10-25 (正常)        │ │
│  │ 借阅天数：24天                 │ │
│  │ 评价：⭐⭐⭐⭐⭐                 │ │
│  ├────────────────────────────────┤ │
│  │ 第6次 ✅ 已还                  │ │
│  │ 借阅人：王五                   │ │
│  │ 借出：2024-08-15               │ │
│  │ 归还：2024-09-20 ⚠️ 逾期5天     │ │
│  │ 借阅天数：36天                 │ │
│  │ 评价：⭐⭐⭐⭐                   │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 查看更多 ]                        │
│                                      │
└──────────────────────────────────────┘
```

---

### 3.6 统计分析

#### 3.6.1 借阅统计仪表板

```
┌──────────────────────────────────────┐
│  📊 借阅统计          [导出报表]     │
├──────────────────────────────────────┤
│                                      │
│  时间范围：[最近一年▾]                │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  总体概览                             │
│                                      │
│  ┌─────────┬─────────┬─────────┐    │
│  │ 总借出  │ 当前在借│ 总归还  │    │
│  │  245次  │  8本   │  237本  │    │
│  └─────────┴─────────┴─────────┘    │
│  ┌─────────┬─────────┬─────────┐    │
│  │平均天数 │逾期次数 │归还率   │    │
│  │  18天   │  12次  │  96.7%  │    │
│  └─────────┴─────────┴─────────┘    │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  📚 热门书籍 TOP 10                   │
│                                      │
│  1. 三体 (12次) ⭐⭐⭐⭐⭐             │
│  2. 活着 (10次) ⭐⭐⭐⭐⭐             │
│  3. 白夜行 (9次) ⭐⭐⭐⭐⭐            │
│  4. 解忧杂货店 (8次) ⭐⭐⭐⭐⭐        │
│  5. 百年孤独 (7次) ⭐⭐⭐⭐            │
│  6. 嫌疑人X的献身 (6次) ⭐⭐⭐⭐⭐     │
│  7. 追风筝的人 (6次) ⭐⭐⭐⭐          │
│  8. 围城 (5次) ⭐⭐⭐⭐                │
│  9. 房思琪的初恋乐园 (5次) ⭐⭐⭐⭐    │
│  10. 平凡的世界 (5次) ⭐⭐⭐⭐⭐       │
│                                      │
│  [ 查看更多 ]                        │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  👥 借阅人排行榜                      │
│                                      │
│  1. 张三 (18次) ⭐⭐⭐⭐⭐ 零逾期      │
│  2. 李四 (15次) ⭐⭐⭐⭐ 逾期2次       │
│  3. 王五 (12次) ⭐⭐⭐⭐⭐ 零逾期      │
│  4. 赵六 (8次) ⭐⭐⭐⭐⭐ 零逾期       │
│  5. 钱七 (6次) ⭐⭐⭐ 逾期4次          │
│                                      │
│  [ 查看更多 ]                        │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  📈 借阅趋势                          │
│                                      │
│  2024年月度借阅次数：                 │
│  ┌────────────────────────────────┐ │
│  │ 30┤                            │ │
│  │   │   ╭╮                       │ │
│  │ 20┤ ╭╯╰╮  ╭╮                  │ │
│  │   │╭╯  ╰╮╭╯╰╮                 │ │
│  │ 10┼╯    ╰╯  ╰╮                │ │
│  │   │            ╰╮              │ │
│  │  0└─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─┬─   │ │
│  │    1 2 3 4 5 6 7 8 9 10 11 12 │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

#### 3.6.2 数据导出

```
┌──────────────────────────────────────┐
│  📥 导出借阅数据                      │
├──────────────────────────────────────┤
│                                      │
│  导出格式                             │
│  ● Excel (.xlsx)                     │
│  ○ CSV (.csv)                        │
│  ○ PDF 报表 (.pdf)                   │
│                                      │
│  数据范围                             │
│  时间：[最近一年▾]                    │
│  借阅人：[全部▾]                      │
│  状态：☑ 在借 ☑ 已还                 │
│                                      │
│  包含字段                             │
│  ☑ 书籍信息（书名、作者、ISBN）       │
│  ☑ 借阅人信息                        │
│  ☑ 借出日期                          │
│  ☑ 预计归还日期                      │
│  ☑ 实际归还日期                      │
│  ☑ 借阅天数                          │
│  ☑ 逾期情况                          │
│  ☑ 评价备注                          │
│                                      │
│  [ 取消 ]             [ 导出 ]       │
│                                      │
└──────────────────────────────────────┘
```

---

## 4. 数据库设计

### 4.1 借阅记录表

```sql
CREATE TABLE borrow_records (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '借阅记录ID',
    user_id BIGINT NOT NULL COMMENT '书籍所有者ID',
    book_id BIGINT NOT NULL COMMENT '书籍ID',

    -- 借阅人信息
    borrower_id BIGINT NOT NULL COMMENT '借阅人ID',
    borrower_name VARCHAR(50) NOT NULL COMMENT '借阅人姓名',
    borrower_phone VARCHAR(20) COMMENT '借阅人手机号',
    borrower_wechat VARCHAR(50) COMMENT '借阅人微信号',

    -- 借阅信息
    borrow_date DATE NOT NULL COMMENT '借出日期',
    expected_return_date DATE COMMENT '预计归还日期',
    actual_return_date DATE COMMENT '实际归还日期',

    -- 状态
    status ENUM('borrowed', 'returned', 'overdue') NOT NULL DEFAULT 'borrowed',
    is_overdue BOOLEAN GENERATED ALWAYS AS (
        actual_return_date IS NULL AND CURDATE() > expected_return_date
    ) STORED COMMENT '是否逾期（计算字段）',
    overdue_days INT GENERATED ALWAYS AS (
        CASE
            WHEN actual_return_date IS NULL AND CURDATE() > expected_return_date
            THEN DATEDIFF(CURDATE(), expected_return_date)
            WHEN actual_return_date > expected_return_date
            THEN DATEDIFF(actual_return_date, expected_return_date)
            ELSE 0
        END
    ) STORED COMMENT '逾期天数（计算字段）',

    -- 归还信息
    book_condition ENUM('good', 'slight_damage', 'heavy_damage') COMMENT '归还时书籍状态',
    return_rating TINYINT COMMENT '借阅人评分 1-5星',
    return_notes TEXT COMMENT '归还备注',

    -- 提醒记录
    reminder_count INT DEFAULT 0 COMMENT '催还次数',
    last_reminder_at TIMESTAMP NULL COMMENT '最后一次提醒时间',

    -- 其他
    borrow_notes TEXT COMMENT '借出备注',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    -- 索引
    INDEX idx_user (user_id),
    INDEX idx_book (book_id),
    INDEX idx_borrower (borrower_id),
    INDEX idx_status (status),
    INDEX idx_borrow_date (borrow_date),
    INDEX idx_expected_return (expected_return_date),
    INDEX idx_is_overdue (is_overdue)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='借阅记录表';
```

### 4.2 借阅人表

```sql
CREATE TABLE borrowers (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '借阅人ID',
    user_id BIGINT NOT NULL COMMENT '书籍所有者ID',

    -- 基本信息
    name VARCHAR(50) NOT NULL COMMENT '姓名',
    phone VARCHAR(20) COMMENT '手机号',
    wechat VARCHAR(50) COMMENT '微信号',
    email VARCHAR(100) COMMENT '邮箱',

    -- 关系备注
    relationship VARCHAR(100) COMMENT '关系：同事/朋友/家人等',
    notes TEXT COMMENT '备注',

    -- 统计信息（冗余字段，定期更新）
    total_borrow_count INT DEFAULT 0 COMMENT '总借阅次数',
    current_borrow_count INT DEFAULT 0 COMMENT '当前在借数量',
    total_return_count INT DEFAULT 0 COMMENT '总归还次数',
    overdue_count INT DEFAULT 0 COMMENT '逾期次数',
    credit_score DECIMAL(3,1) DEFAULT 5.0 COMMENT '信用评分 1-5分',

    -- 提醒设置
    enable_reminder BOOLEAN DEFAULT TRUE COMMENT '是否启用提醒',
    reminder_methods JSON COMMENT '提醒方式：["app", "wechat", "sms"]',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_user (user_id),
    INDEX idx_name (name),
    INDEX idx_phone (phone)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='借阅人表';
```

### 4.3 催还记录表

```sql
CREATE TABLE reminder_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    borrow_record_id BIGINT NOT NULL COMMENT '借阅记录ID',
    user_id BIGINT NOT NULL COMMENT '书籍所有者ID',
    borrower_id BIGINT NOT NULL COMMENT '借阅人ID',

    -- 提醒信息
    reminder_type ENUM('auto', 'manual') NOT NULL COMMENT '提醒类型',
    reminder_trigger ENUM('before_due', 'on_due', 'overdue') COMMENT '触发时机',
    reminder_methods JSON NOT NULL COMMENT '提醒方式：["app", "wechat", "sms"]',

    -- 提醒内容
    message_content TEXT COMMENT '提醒内容',
    message_tone ENUM('friendly', 'formal', 'humorous') DEFAULT 'friendly',

    -- 发送状态
    send_status ENUM('pending', 'sent', 'failed') DEFAULT 'pending',
    send_time TIMESTAMP NULL COMMENT '发送时间',
    error_message TEXT COMMENT '失败原因',

    -- 阅读状态
    is_read BOOLEAN DEFAULT FALSE COMMENT '是否已读',
    read_time TIMESTAMP NULL COMMENT '阅读时间',
    response_text VARCHAR(500) COMMENT '回复内容',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_borrow_record (borrow_record_id),
    INDEX idx_borrower (borrower_id),
    INDEX idx_send_status (send_status),
    INDEX idx_created (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='催还记录表';
```

---

## 5. API 接口设计

### 5.1 借出登记

```http
POST /api/v1/borrows
Authorization: Bearer {token}
Content-Type: application/json

{
  "book_id": 123,
  "borrower_id": 5,
  "borrow_date": "2025-01-15",
  "expected_return_date": "2025-02-15",
  "borrow_notes": "张三很喜欢科幻小说",
  "enable_reminder": true,
  "reminder_days_before": 3
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "borrow_record_id": 456,
    "book": {
      "id": 123,
      "title": "三体",
      "author": "刘慈欣"
    },
    "borrower": {
      "id": 5,
      "name": "张三",
      "phone": "138****5678"
    },
    "borrow_date": "2025-01-15",
    "expected_return_date": "2025-02-15",
    "status": "borrowed",
    "reminder_scheduled": true
  }
}
```

### 5.2 归还登记

```http
PUT /api/v1/borrows/{borrow_record_id}/return
Authorization: Bearer {token}
Content-Type: application/json

{
  "actual_return_date": "2025-01-15",
  "book_condition": "good",
  "return_rating": 5,
  "return_notes": "书的状态很好"
}
```

### 5.3 查询在借书籍

```http
GET /api/v1/borrows?status=borrowed&sort=expected_return_date
Authorization: Bearer {token}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "total": 8,
    "overdue": 2,
    "due_soon": 3,
    "normal": 3,
    "records": [
      {
        "id": 456,
        "book": {
          "id": 123,
          "title": "三体",
          "author": "刘慈欣",
          "cover_image": "https://..."
        },
        "borrower": {
          "id": 5,
          "name": "张三",
          "phone": "138****5678"
        },
        "borrow_date": "2024-12-15",
        "expected_return_date": "2025-01-15",
        "days_borrowed": 31,
        "is_overdue": false,
        "overdue_days": 0,
        "status": "borrowed"
      }
    ]
  }
}
```

### 5.4 发送催还提醒

```http
POST /api/v1/borrows/{borrow_record_id}/remind
Authorization: Bearer {token}
Content-Type: application/json

{
  "methods": ["app", "wechat"],
  "message_tone": "friendly",
  "custom_message": "嗨，张三！你借的书已经逾期了..."
}
```

### 5.5 借阅统计

```http
GET /api/v1/borrows/statistics?period=last_year
Authorization: Bearer {token}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "overview": {
      "total_borrow_count": 245,
      "current_borrowed": 8,
      "total_returned": 237,
      "return_rate": 96.7,
      "average_days": 18,
      "overdue_count": 12
    },
    "top_books": [
      {
        "book_id": 123,
        "title": "三体",
        "author": "刘慈欣",
        "borrow_count": 12,
        "average_rating": 5.0
      }
    ],
    "top_borrowers": [
      {
        "borrower_id": 5,
        "name": "张三",
        "borrow_count": 18,
        "credit_score": 5.0,
        "overdue_count": 0
      }
    ],
    "monthly_trend": [
      {"month": "2024-01", "borrow_count": 15},
      {"month": "2024-02", "borrow_count": 20}
    ]
  }
}
```

---

## 6. 业务规则

### 6.1 借阅规则

| 规则 | 说明 |
|------|------|
| 同一本书只能借给一人 | 书籍状态为"已借出"时，不可再次借出 |
| 预计归还期默认30天 | 可自定义修改 |
| 逾期自动标记 | 系统每日凌晨自动检查并标记逾期记录 |
| 同一借阅人最多在借10本 | 防止借阅过多导致管理困难 |
| 逾期3次以上降低信用评分 | 信用评分低于3分时给予提示 |

### 6.2 提醒规则

| 提醒类型 | 触发条件 | 默认行为 |
|---------|---------|---------|
| 到期前提醒 | 距离预计归还日期3天 | App推送 |
| 到期当天提醒 | 预计归还日期当天 | App推送 + 微信 |
| 逾期第1天 | 逾期当天 | App推送 + 微信 |
| 逾期第7天 | 逾期7天 | App推送 + 微信 + 短信 |
| 逾期第14天 | 逾期14天 | App推送 + 微信 + 短信 |
| 之后每7天 | 逾期21、28、35天... | App推送 + 微信 |

### 6.3 信用评分算法

```python
def calculate_credit_score(borrower):
    """
    计算借阅人信用评分（满分5分）
    """
    base_score = 5.0

    # 扣分项
    deductions = 0

    # 1. 逾期次数扣分（每次-0.2分，最多扣2分）
    overdue_penalty = min(borrower.overdue_count * 0.2, 2.0)
    deductions += overdue_penalty

    # 2. 当前有逾期书籍（-0.5分）
    if has_current_overdue_books(borrower):
        deductions += 0.5

    # 3. 严重逾期（超过30天）额外扣分（每次-0.3分，最多扣1分）
    severe_overdue_count = count_severe_overdue(borrower)
    severe_penalty = min(severe_overdue_count * 0.3, 1.0)
    deductions += severe_penalty

    # 4. 书籍损坏记录（每次-0.1分，最多扣0.5分）
    damage_penalty = min(borrower.damage_count * 0.1, 0.5)
    deductions += damage_penalty

    # 加分项
    bonuses = 0

    # 1. 零逾期记录且借阅次数>10次（+0.5分）
    if borrower.overdue_count == 0 and borrower.total_borrow_count > 10:
        bonuses += 0.5

    # 2. 平均评分5星（+0.3分）
    if borrower.average_rating >= 5.0 and borrower.total_return_count > 5:
        bonuses += 0.3

    # 计算最终评分
    final_score = base_score - deductions + bonuses
    final_score = max(1.0, min(5.0, final_score))  # 限制在1-5分之间

    return round(final_score, 1)
```

---

## 7. 实施计划

| 阶段 | 任务 | 工期 | 优先级 |
|------|------|------|--------|
| 第1周 | 数据库设计与创建 | 1周 | P0 |
| 第2周 | 借出登记功能 | 1周 | P0 |
| 第3周 | 归还登记功能 | 1周 | P0 |
| 第4周 | 借阅查询功能 | 1周 | P0 |
| 第5周 | 催还提醒功能 | 1周 | P1 |
| 第6周 | 自动提醒定时任务 | 1周 | P1 |
| 第7周 | 借阅历史与统计 | 1周 | P1 |
| 第8周 | 测试与优化 | 1周 | P0 |

---

## 8. 测试用例

| 测试项 | 预期结果 |
|--------|---------|
| 扫码借出 | 成功识别书籍，创建借阅记录 |
| 借出已借出的书 | 提示"该书已借出" |
| 归还登记 | 更新借阅记录，书籍状态变为"可借" |
| 逾期检测 | 自动标记逾期记录 |
| 到期前3天提醒 | 发送提醒消息 |
| 逾期催还 | 发送催还消息 |
| 信用评分计算 | 正确计算借阅人信用评分 |
| 统计报表 | 正确显示借阅统计数据 |

---

**文档版本**: v1.0.0
**创建日期**: 2025-01-15
**更新日期**: 2025-01-15
**文档状态**: ✅ 已完成
**维护人**: 产品经理
