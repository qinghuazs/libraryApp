# 书籍录入管理需求文档

## 1. 概述

### 1.1 功能定位

书籍录入是实体书管理的入口功能，提供多种便捷的录入方式，帮助用户快速建立个人藏书档案。本模块是整个实体书管理系统的基础，录入的数据质量直接影响后续的管理、检索和分析功能。

### 1.2 设计原则

- **多样化录入**：支持扫码、手工、导入、OCR、语音等多种方式
- **智能补全**：自动从多个数据源获取书籍信息
- **查重机制**：防止重复录入同一本书
- **快速便捷**：优化录入流程，减少用户操作步骤
- **容错性强**：支持部分信息录入，后续补充完善

### 1.3 用户痛点

| 痛点 | 解决方案 |
|------|---------|
| 手工录入太慢 | 扫码自动识别 + OCR拍照识别 |
| 信息不全 | 多源数据自动补全（豆瓣、国图、Google Books） |
| 批量录入困难 | Excel导入 + 批量扫码 |
| 重复录入 | 智能查重提醒 |
| 缺封面图片 | 自动抓取封面图 |

---

## 2. 录入方式

### 2.1 录入方式对比

| 录入方式 | 适用场景 | 速度 | 准确度 | 优先级 |
|---------|---------|------|--------|--------|
| 扫码录入 | 带ISBN条码的新书 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐⭐ | P0 |
| 手工录入 | 无条码的旧书、古籍 | ⭐⭐ | ⭐⭐⭐⭐ | P0 |
| Excel导入 | 批量录入已有书单 | ⭐⭐⭐⭐⭐ | ⭐⭐⭐⭐ | P1 |
| OCR识别 | 拍照快速录入 | ⭐⭐⭐⭐ | ⭐⭐⭐ | P1 |
| 语音录入 | 解放双手 | ⭐⭐⭐ | ⭐⭐⭐ | P2 |

### 2.2 录入流程图

```
┌─────────────────────────────────────────┐
│         选择录入方式                     │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────┐  ┌─────────┐  ┌─────────┐│
│  │ 📷扫码  │  │ ✍️手工  │  │ 📊导入  ││
│  └─────────┘  └─────────┘  └─────────┘│
│  ┌─────────┐  ┌─────────┐             │
│  │ 📸OCR   │  │ 🎤语音  │             │
│  └─────────┘  └─────────┘             │
│                                         │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│       自动获取书籍信息                   │
│   (豆瓣/国图/Google Books)              │
└─────────────────────────────────────────┘
           ↓
┌─────────────────────────────────────────┐
│          查重检测                        │
│   (ISBN精确 + 书名模糊)                  │
└─────────────────────────────────────────┘
           ↓
      ┌────┴────┐
      │ 有重复？ │
      └────┬────┘
      是 ↓    ↓ 否
    ┌───────┐  ┌───────────────────────┐
    │ 提示  │  │  补全信息              │
    │ 用户  │  │  - 分类选择            │
    └───────┘  │  - 书架位置            │
               │  - 购买信息            │
               │  - 阅读状态            │
               └───────────────────────┘
                        ↓
               ┌───────────────────────┐
               │   保存到数据库         │
               └───────────────────────┘
                        ↓
               ┌───────────────────────┐
               │   继续录入？           │
               │  [是] / [完成]         │
               └───────────────────────┘
```

---

## 3. 功能详细设计

### 3.1 扫码录入

#### 3.1.1 功能说明

用户通过手机摄像头扫描书籍背面的ISBN条形码，系统自动识别并获取书籍信息。

#### 3.1.2 UI设计

```
┌──────────────────────────────────────┐
│  📷 扫码录入              [?] [×]    │
├──────────────────────────────────────┤
│                                      │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  │                                │ │
│  │         ┌──────────┐          │ │
│  │         │          │          │ │
│  │         │          │          │ │
│  │         │  扫描框  │          │ │
│  │         │          │          │ │
│  │         │          │          │ │
│  │         └──────────┘          │ │
│  │                                │ │
│  │   对准书籍背面的ISBN条码       │ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  💡 提示：                            │
│  • 确保条码清晰可见                  │
│  • 光线充足                          │
│  • 将条码放入扫描框中                │
│                                      │
│  ┌────────────────┐                 │
│  │  💡 打开闪光灯  │                 │
│  └────────────────┘                 │
│  ┌────────────────┐                 │
│  │  📖 手工录入    │                 │
│  └────────────────┘                 │
│                                      │
│  已录入：245本  本次：0本             │
│                                      │
└──────────────────────────────────────┘
```

#### 3.1.3 扫码成功后

```
┌──────────────────────────────────────┐
│  ✅ 识别成功！                        │
├──────────────────────────────────────┤
│                                      │
│  ISBN: 978-7-5366-9293-0            │
│                                      │
│  正在获取书籍信息...                  │
│                                      │
│  ┌──────────────────────────────┐   │
│  │ ████████████░░░░░░░░ 60%     │   │
│  └──────────────────────────────┘   │
│                                      │
│  数据源：                             │
│  ✅ 豆瓣读书                          │
│  ⏳ 国家图书馆                        │
│  ⏳ Google Books                     │
│                                      │
└──────────────────────────────────────┘
```

#### 3.1.4 信息补全页面

```
┌──────────────────────────────────────┐
│  📖 书籍信息           [保存] [取消]  │
├──────────────────────────────────────┤
│                                      │
│  ┌────────┐  《三体》                │
│  │        │  刘慈欣 著                │
│  │  封面  │  重庆出版社               │
│  │  图片  │  2008年1月                │
│  │        │  32.00元                 │
│  └────────┘  [更换封面]              │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  基本信息                             │
│  ISBN: 978-7-5366-9293-0            │
│  装帧: 平装                           │
│  页数: 302页                          │
│                                      │
│  分类 *                               │
│  ┌────────────────────────────────┐ │
│  │ 小说 > 科幻                ▾   │ │
│  └────────────────────────────────┘ │
│  💡 智能推荐：科幻小说 (置信度95%)    │
│                                      │
│  书架位置                             │
│  ┌────────────────────────────────┐ │
│  │ 书房-A01书架-第3层-第5列   ▾   │ │
│  └────────────────────────────────┘ │
│  💡 推荐：已有2本同作者书在此书架     │
│                                      │
│  购买信息（可选）                     │
│  购买日期: [2025-01-15        ▾]    │
│  购买价格: [28.00            元]    │
│  购买渠道: [京东              ▾]    │
│                                      │
│  阅读状态                             │
│  ○ 未读  ○ 在读  ● 已读             │
│                                      │
│  标签（可选）                         │
│  [硬科幻] [雨果奖] [三部曲] [+添加]   │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  内容简介                             │
│  文化大革命如火如荼进行的同时，      │
│  军方探寻外星文明的绝密计划...       │
│  [展开全部]                           │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  [ 保存并继续扫描 ]  [ 保存 ]        │
│                                      │
└──────────────────────────────────────┘
```

#### 3.1.5 批量扫码模式

```
┌──────────────────────────────────────┐
│  📚 批量扫码          [完成] [暂停]  │
├──────────────────────────────────────┤
│                                      │
│  ┌────────────────────────────────┐ │
│  │      扫描框（同单本扫码）       │ │
│  └────────────────────────────────┘ │
│                                      │
│  本次已扫：5本  成功：4本  失败：1本  │
│                                      │
│  最近扫描：                           │
│  ┌────────────────────────────────┐ │
│  │ ✅ 三体          刘慈欣        │ │
│  │ ✅ 活着          余华          │ │
│  │ ✅ 白夜行        东野圭吾      │ │
│  │ ✅ 银河帝国      阿西莫夫      │ │
│  │ ❌ 识别失败      [重试][删除]  │ │
│  └────────────────────────────────┘ │
│                                      │
│  统一设置：                           │
│  书架位置: [书房-A01书架    ▾]      │
│  阅读状态: [未读            ▾]      │
│  购买日期: [2025-01-15      ▾]      │
│                                      │
│  [ 完成并保存全部 ]                  │
│                                      │
└──────────────────────────────────────┘
```

#### 3.1.6 技术实现

**条码识别库选择：**

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| ZXing | 开源免费，识别率高 | 库较大 | ⭐⭐⭐⭐⭐ |
| QuaggaJS | 轻量级，Web友好 | 识别率一般 | ⭐⭐⭐ |
| Dynamsoft | 识别率极高 | 付费 | ⭐⭐⭐⭐ |

**数据源API优先级：**

```javascript
async function getBookInfo(isbn) {
    const sources = [
        { name: '豆瓣读书', api: getDoubanInfo, weight: 0.4 },
        { name: '国家图书馆', api: getNLCInfo, weight: 0.3 },
        { name: 'Google Books', api: getGoogleBooksInfo, weight: 0.2 },
        { name: 'Open Library', api: getOpenLibraryInfo, weight: 0.1 }
    ];

    // 并发请求所有数据源
    const results = await Promise.allSettled(
        sources.map(source => source.api(isbn))
    );

    // 合并数据，优先使用质量高的数据源
    return mergeBookInfo(results, sources);
}

function mergeBookInfo(results, sources) {
    let mergedInfo = {
        title: null,
        author: null,
        publisher: null,
        publishDate: null,
        isbn: null,
        coverImage: null,
        summary: null,
        price: null,
        pages: null,
        category: null
    };

    results.forEach((result, index) => {
        if (result.status === 'fulfilled' && result.value) {
            const data = result.value;
            const weight = sources[index].weight;

            // 优先使用权重高的数据源，或补充缺失字段
            Object.keys(mergedInfo).forEach(key => {
                if (!mergedInfo[key] && data[key]) {
                    mergedInfo[key] = data[key];
                }
            });
        }
    });

    return mergedInfo;
}
```

---

### 3.2 手工录入

#### 3.2.1 功能说明

用于录入无ISBN条码的古籍、内部出版物等特殊书籍。

#### 3.2.2 UI设计

```
┌──────────────────────────────────────┐
│  ✍️ 手工录入          [保存] [取消]  │
├──────────────────────────────────────┤
│                                      │
│  📸 上传封面（可选）                  │
│  ┌────────┐                          │
│  │  +     │  [拍照] [相册] [网络图片]│
│  │        │                          │
│  └────────┘                          │
│                                      │
│  书名 *                               │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  作者 *                               │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  出版社                               │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  出版日期                             │
│  ┌────────────────────────────────┐ │
│  │ 2008年1月              ▾       │ │
│  └────────────────────────────────┘ │
│                                      │
│  ISBN（可选）                         │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│  💡 有ISBN建议使用扫码录入            │
│                                      │
│  定价（元）                           │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  分类 *                               │
│  ┌────────────────────────────────┐ │
│  │ 请选择分类              ▾      │ │
│  └────────────────────────────────┘ │
│                                      │
│  书架位置                             │
│  ┌────────────────────────────────┐ │
│  │ 请选择书架              ▾      │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 智能识别书名 ] （尝试自动获取信息）│
│                                      │
│  [ 保存 ]                            │
│                                      │
└──────────────────────────────────────┘
```

#### 3.2.3 智能识别功能

当用户输入书名后，系统尝试模糊搜索：

```
┌──────────────────────────────────────┐
│  💡 找到相似书籍                      │
├──────────────────────────────────────┤
│                                      │
│  根据书名"三体"找到以下结果：         │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ○ 三体                         │ │
│  │   刘慈欣 / 重庆出版社 / 2008年 │ │
│  │   ISBN: 978-7-5366-9293-0      │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ ○ 三体Ⅱ·黑暗森林               │ │
│  │   刘慈欣 / 重庆出版社 / 2008年 │ │
│  │   ISBN: 978-7-5366-9293-7      │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ ○ 都不是，继续手工录入          │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 确定 ] [ 取消 ]                   │
│                                      │
└──────────────────────────────────────┘
```

---

### 3.3 Excel 批量导入

#### 3.3.1 功能说明

支持从Excel文件批量导入书籍信息，适合已有藏书清单的用户快速建档。

#### 3.3.2 导入流程

```
上传Excel文件
      ↓
  解析表格
      ↓
  字段映射
      ↓
  数据校验
      ↓
  查重检测
      ↓
  预览确认
      ↓
  批量导入
      ↓
  导入报告
```

#### 3.3.3 UI设计

**步骤1：上传文件**

```
┌──────────────────────────────────────┐
│  📊 Excel批量导入     步骤 1/4        │
├──────────────────────────────────────┤
│                                      │
│  上传Excel文件                        │
│                                      │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  │         📄                     │ │
│  │                                │ │
│  │   拖拽文件到这里                │ │
│  │   或点击选择文件                │ │
│  │                                │ │
│  │   支持格式：.xlsx .xls .csv    │ │
│  │   最大支持：10000条记录         │ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  📥 下载模板文件                      │
│  • [标准模板.xlsx]（推荐）            │
│  • [简易模板.xlsx]                   │
│  • [豆瓣导出模板.xlsx]                │
│                                      │
│  💡 提示：                            │
│  • 必填字段：书名、作者               │
│  • 建议字段：ISBN、出版社、分类       │
│  • 自动查重：根据ISBN或书名+作者      │
│                                      │
└──────────────────────────────────────┘
```

**步骤2：字段映射**

```
┌──────────────────────────────────────┐
│  📊 Excel批量导入     步骤 2/4        │
├──────────────────────────────────────┤
│                                      │
│  文件：我的藏书.xlsx (共326行)        │
│                                      │
│  字段映射（请将Excel列映射到系统字段）│
│                                      │
│  ┌────────────────┬────────────────┐│
│  │ Excel列名      │ 映射到         ││
│  ├────────────────┼────────────────┤│
│  │ 书名           │ [书名*     ▾]  ││
│  │ 作者           │ [作者*     ▾]  ││
│  │ ISBN           │ [ISBN      ▾]  ││
│  │ 出版社         │ [出版社    ▾]  ││
│  │ 出版年份       │ [出版日期  ▾]  ││
│  │ 价格           │ [定价      ▾]  ││
│  │ 分类           │ [分类      ▾]  ││
│  │ 备注           │ [不导入    ▾]  ││
│  └────────────────┴────────────────┘│
│                                      │
│  数据预览（前5行）：                  │
│  ┌────────────────────────────────┐ │
│  │书名    │作者    │ISBN          ││
│  ├────────────────────────────────┤ │
│  │三体    │刘慈欣  │978-7-5366... ││
│  │活着    │余华    │978-7-5080... ││
│  │白夜行  │东野圭吾│978-7-5442... ││
│  └────────────────────────────────┘ │
│                                      │
│  ☑ 自动匹配作者（如有多个作者分隔符）│
│  ☑ 启用智能查重                      │
│  ☑ 自动补全书籍信息                  │
│                                      │
│  [ 上一步 ]           [ 下一步 ]     │
│                                      │
└──────────────────────────────────────┘
```

**步骤3：数据校验**

```
┌──────────────────────────────────────┐
│  📊 Excel批量导入     步骤 3/4        │
├──────────────────────────────────────┤
│                                      │
│  数据校验中...                        │
│                                      │
│  ┌──────────────────────────────┐   │
│  │ ████████████████░░░░ 80%     │   │
│  └──────────────────────────────┘   │
│                                      │
│  ✅ 基本校验完成                      │
│  ✅ 查重检测完成                      │
│  ⏳ 自动补全书籍信息... (245/326)     │
│                                      │
└──────────────────────────────────────┘
```

**步骤4：导入预览**

```
┌──────────────────────────────────────┐
│  📊 Excel批量导入     步骤 4/4        │
├──────────────────────────────────────┤
│                                      │
│  导入统计                             │
│  ┌────────────────────────────────┐ │
│  │ 总计：     326 条               │ │
│  │ ✅ 可导入： 298 条               │ │
│  │ ⚠️  重复：   23 条（已标记）     │ │
│  │ ❌ 错误：    5 条                │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 全部 ] [ 可导入 ] [ 重复 ] [ 错误 ]│
│                                      │
│  ┌────────────────────────────────┐ │
│  │状态│书名    │作者    │问题      ││
│  ├────────────────────────────────┤ │
│  │ ✅ │三体    │刘慈欣  │-         ││
│  │ ⚠️  │活着    │余华    │已存在    ││
│  │ ✅ │白夜行  │东野圭吾│-         ││
│  │ ❌ │        │        │书名为空  ││
│  │ ✅ │解忧... │东野圭吾│-         ││
│  └────────────────────────────────┘ │
│                                      │
│  重复处理方式：                       │
│  ○ 跳过重复项                        │
│  ● 更新已有数据                      │
│  ○ 保留为重复项（生成新记录）         │
│                                      │
│  [ 导出错误报告 ]                    │
│  [ 上一步 ]           [ 开始导入 ]   │
│                                      │
└──────────────────────────────────────┘
```

**步骤5：导入结果**

```
┌──────────────────────────────────────┐
│  ✅ 导入完成！                        │
├──────────────────────────────────────┤
│                                      │
│  导入结果                             │
│  ┌────────────────────────────────┐ │
│  │ ✅ 成功导入：  298 本            │ │
│  │ ⚠️  跳过重复：  23 本            │ │
│  │ ❌ 导入失败：   5 本             │ │
│  │                                │ │
│  │ 总耗时：2分18秒                 │ │
│  └────────────────────────────────┘ │
│                                      │
│  自动补全统计：                       │
│  • 补全封面图：256 本                 │
│  • 补全出版社：89 本                  │
│  • 补全ISBN：12 本                   │
│  • 推荐分类：298 本                   │
│                                      │
│  [ 查看导入的书籍 ]                  │
│  [ 下载详细报告.xlsx ]                │
│  [ 完成 ]                            │
│                                      │
└──────────────────────────────────────┘
```

#### 3.3.4 Excel模板格式

**标准模板**

| 列名 | 必填 | 格式 | 示例 |
|------|------|------|------|
| 书名 | ✅ | 文本 | 三体 |
| 作者 | ✅ | 文本，多作者用"/"分隔 | 刘慈欣 |
| ISBN | ⚠️ 建议 | 13位数字 | 978-7-5366-9293-0 |
| 出版社 | - | 文本 | 重庆出版社 |
| 出版日期 | - | YYYY-MM 或 YYYY | 2008-01 |
| 定价 | - | 数字 | 32.00 |
| 页数 | - | 整数 | 302 |
| 分类 | - | 文本，用">"分隔 | 小说>科幻 |
| 书架位置 | - | 文本 | 书房-A01-03-05 |
| 阅读状态 | - | 未读/在读/已读 | 已读 |
| 购买日期 | - | YYYY-MM-DD | 2025-01-15 |
| 购买价格 | - | 数字 | 28.00 |
| 购买渠道 | - | 文本 | 京东 |
| 标签 | - | 文本，用","分隔 | 硬科幻,雨果奖,三部曲 |
| 备注 | - | 文本 | 刘慈欣代表作 |

**CSV格式示例**

```csv
书名,作者,ISBN,出版社,出版日期,定价,分类,阅读状态
三体,刘慈欣,978-7-5366-9293-0,重庆出版社,2008-01,32.00,小说>科幻,已读
活着,余华,978-7-5080-3916-9,作家出版社,2012-08,20.00,文学>其他,已读
白夜行,东野圭吾,978-7-5442-4752-9,南海出版公司,2013-01,39.50,小说>推理,在读
```

---

### 3.4 OCR 拍照识别

#### 3.4.1 功能说明

用户拍摄书籍封面或版权页，系统通过OCR技术自动识别书籍信息。

#### 3.4.2 UI设计

```
┌──────────────────────────────────────┐
│  📸 拍照识别          [?] [×]        │
├──────────────────────────────────────┤
│                                      │
│  请选择拍照目标：                     │
│                                      │
│  ┌────────────────┐ ┌──────────────┐│
│  │                │ │              ││
│  │   📖 书籍封面  │ │  📄 版权页   ││
│  │                │ │              ││
│  │  （识别书名、  │ │ （识别详细   ││
│  │   作者）       │ │  出版信息）  ││
│  │                │ │              ││
│  └────────────────┘ └──────────────┘│
│                                      │
│  ┌────────────────┐ ┌──────────────┐│
│  │                │ │              ││
│  │   📊 目录页    │ │  📷 自由拍摄 ││
│  │                │ │              ││
│  │  （识别目录）  │ │ （识别可见   ││
│  │                │ │  所有文字）  ││
│  │                │ │              ││
│  └────────────────┘ └──────────────┘│
│                                      │
│  💡 提示：                            │
│  • 确保文字清晰可见                  │
│  • 避免反光和阴影                    │
│  • 水平拍摄效果最佳                  │
│                                      │
└──────────────────────────────────────┘
```

#### 3.4.3 拍照页面

```
┌──────────────────────────────────────┐
│  📸 拍摄书籍封面      [拍照] [×]     │
├──────────────────────────────────────┤
│                                      │
│  ┌────────────────────────────────┐ │
│  │                                │ │
│  │                                │ │
│  │                                │ │
│  │         摄像头预览              │ │
│  │                                │ │
│  │     将书籍封面放入框内          │ │
│  │                                │ │
│  │                                │ │
│  │                                │ │
│  └────────────────────────────────┘ │
│                                      │
│  ┌────────────────────────────────┐ │
│  │  💡 闪光灯    📱 翻转    📷 相册 │ │
│  └────────────────────────────────┘ │
│                                      │
│         [ 拍照 ]                     │
│                                      │
└──────────────────────────────────────┘
```

#### 3.4.4 识别结果

```
┌──────────────────────────────────────┐
│  ✅ 识别完成                          │
├──────────────────────────────────────┤
│                                      │
│  ┌─────────┐                         │
│  │ 拍摄的  │  识别结果：              │
│  │ 照片    │                          │
│  │ 缩略图  │  书名: 三体 ✅            │
│  └─────────┘  作者: 刘慈欣 ✅         │
│               出版社: 重庆出版社 ✅    │
│               ISBN: 978-7-5366... ✅  │
│               价格: 32.00元 ✅        │
│                                      │
│  识别置信度：92%                      │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 书名      [三体            ]   │ │
│  │ 作者      [刘慈欣          ]   │ │
│  │ 出版社    [重庆出版社      ]   │ │
│  │ ISBN      [978-7-5366-9293-0]  │ │
│  │ 定价      [32.00          元]  │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 重新拍照 ] [ 确认并保存 ]         │
│                                      │
└──────────────────────────────────────┘
```

#### 3.4.5 技术实现

**OCR引擎选择：**

| OCR引擎 | 准确率 | 速度 | 成本 | 推荐度 |
|---------|-------|------|------|--------|
| 百度OCR | 95% | 快 | 低（有免费额度） | ⭐⭐⭐⭐⭐ |
| 腾讯OCR | 94% | 快 | 低（有免费额度） | ⭐⭐⭐⭐⭐ |
| 阿里OCR | 93% | 中 | 中 | ⭐⭐⭐⭐ |
| Google Vision API | 96% | 慢 | 高 | ⭐⭐⭐ |
| Tesseract（开源） | 85% | 中 | 免费 | ⭐⭐⭐ |

**识别策略：**

```javascript
async function recognizeBookCover(imageFile) {
    // 1. 图像预处理
    const preprocessedImage = await preprocessImage(imageFile);

    // 2. OCR识别
    const ocrResult = await baiduOCR(preprocessedImage);

    // 3. 信息提取
    const bookInfo = extractBookInfo(ocrResult);

    // 4. 验证与修正
    const validatedInfo = await validateBookInfo(bookInfo);

    return validatedInfo;
}

function extractBookInfo(ocrText) {
    const lines = ocrText.split('\n');
    let info = {
        title: null,
        author: null,
        publisher: null,
        isbn: null,
        price: null
    };

    // 规则1: 标题通常在前几行，字号最大
    info.title = findTitle(lines);

    // 规则2: 作者名通常包含"著"、"编"等关键词
    info.author = findAuthor(lines);

    // 规则3: ISBN格式：978-x-xxxx-xxxx-x
    info.isbn = findISBN(ocrText);

    // 规则4: 价格格式：xx.00元
    info.price = findPrice(ocrText);

    // 规则5: 出版社通常包含"出版社"、"出版集团"
    info.publisher = findPublisher(lines);

    return info;
}
```

---

### 3.5 语音录入

#### 3.5.1 功能说明

用户通过语音说出书名和作者，系统语音识别后自动搜索并录入。

#### 3.5.2 UI设计

```
┌──────────────────────────────────────┐
│  🎤 语音录入          [×]            │
├──────────────────────────────────────┤
│                                      │
│                                      │
│         ┌────────────┐               │
│         │            │               │
│         │     🎤     │               │
│         │            │               │
│         │  点击开始  │               │
│         │  语音录入  │               │
│         │            │               │
│         └────────────┘               │
│                                      │
│                                      │
│  💡 示例说法：                        │
│  • "三体，刘慈欣"                    │
│  • "余华的活着"                      │
│  • "东野圭吾，白夜行"                │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  最近录入：                           │
│  ┌────────────────────────────────┐ │
│  │ ✅ 三体 - 刘慈欣                │ │
│  │ ✅ 活着 - 余华                  │ │
│  │ ✅ 白夜行 - 东野圭吾            │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

#### 3.5.3 识别过程

```
┌──────────────────────────────────────┐
│  🎤 正在录音...       [停止]         │
├──────────────────────────────────────┤
│                                      │
│         ┌────────────┐               │
│         │            │               │
│         │     🔴     │               │
│         │            │               │
│         │ ●●●●●●●●  │               │
│         │            │               │
│         │   3.2秒    │               │
│         │            │               │
│         └────────────┘               │
│                                      │
│  识别中: "三体，刘慈欣"               │
│                                      │
└──────────────────────────────────────┘
```

#### 3.5.4 搜索结果

```
┌──────────────────────────────────────┐
│  🔍 语音识别结果                      │
├──────────────────────────────────────┤
│                                      │
│  您说的是："三体，刘慈欣"             │
│                                      │
│  找到以下书籍：                       │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ ○ 三体                         │ │
│  │   刘慈欣 / 重庆出版社 / 2008年 │ │
│  │   ⭐⭐⭐⭐⭐ 9.3分              │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ ○ 三体Ⅱ·黑暗森林               │ │
│  │   刘慈欣 / 重庆出版社 / 2008年 │ │
│  │   ⭐⭐⭐⭐⭐ 9.3分              │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ ○ 三体Ⅲ·死神永生               │ │
│  │   刘慈欣 / 重庆出版社 / 2010年 │ │
│  │   ⭐⭐⭐⭐⭐ 9.2分              │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 重新录音 ] [ 手工输入 ]           │
│                                      │
└──────────────────────────────────────┘
```

---

## 4. 查重机制

### 4.1 查重策略

```
┌─────────────────────────────────────┐
│           查重检测流程               │
├─────────────────────────────────────┤
│                                     │
│  第1步：ISBN精确匹配                 │
│    ├─ 有ISBN → 查询数据库            │
│    │            ├─ 找到 → 提示重复  │
│    │            └─ 未找到 → 继续    │
│    └─ 无ISBN → 进入第2步             │
│                                     │
│  第2步：书名+作者模糊匹配            │
│    ├─ 相似度 > 90% → 高度疑似重复   │
│    ├─ 相似度 60-90% → 可能重复      │
│    └─ 相似度 < 60% → 通过           │
│                                     │
│  第3步：AI智能判断（可选）           │
│    └─ 综合书名、作者、出版社等信息  │
│       使用AI模型判断是否为同一本书   │
│                                     │
└─────────────────────────────────────┘
```

### 4.2 查重结果处理

#### 4.2.1 精确重复

```
┌──────────────────────────────────────┐
│  ⚠️  发现重复书籍                     │
├──────────────────────────────────────┤
│                                      │
│  《三体》已存在于您的藏书中！         │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 📖 三体                        │ │
│  │    刘慈欣 著                   │ │
│  │    ISBN: 978-7-5366-9293-0     │ │
│  │    重庆出版社 / 2008年1月      │ │
│  │                                │ │
│  │    位置：书房-A01-03-05        │ │
│  │    状态：已读                  │ │
│  │    录入时间：2024-12-15        │ │
│  └────────────────────────────────┘ │
│                                      │
│  如何处理？                           │
│  ┌────────────────────────────────┐ │
│  │ ○ 放弃录入（可能买重了）        │ │
│  │ ● 继续录入（我有多本相同的书）  │ │
│  │ ○ 更新信息（补充原有记录）      │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 取消 ]             [ 确定 ]       │
│                                      │
└──────────────────────────────────────┘
```

#### 4.2.2 可能重复

```
┌──────────────────────────────────────┐
│  💡 发现相似书籍                      │
├──────────────────────────────────────┤
│                                      │
│  您要录入的书籍与以下书籍相似：       │
│                                      │
│  录入中：                             │
│  ┌────────────────────────────────┐ │
│  │ 三体                           │ │
│  │ 刘慈欣 / 重庆出版集团 / 2008   │ │
│  │ ISBN: (无)                     │ │
│  └────────────────────────────────┘ │
│                                      │
│  已存在：                             │
│  ┌────────────────────────────────┐ │
│  │ 三体                           │ │
│  │ 刘慈欣 / 重庆出版社 / 2008-01  │ │
│  │ ISBN: 978-7-5366-9293-0        │ │
│  │ 位置：书房-A01-03-05           │ │
│  └────────────────────────────────┘ │
│                                      │
│  相似度：85%                          │
│                                      │
│  是否为同一本书？                     │
│  ┌────────────────────────────────┐ │
│  │ ○ 是同一本（合并信息）          │ │
│  │ ● 不是（继续录入）              │ │
│  └────────────────────────────────┘ │
│                                      │
│  [ 取消 ]             [ 确定 ]       │
│                                      │
└──────────────────────────────────────┘
```

### 4.3 查重算法

```python
def check_duplicate(new_book, existing_books):
    """
    查重检测
    返回：(is_duplicate, similarity_score, matched_book)
    """

    # 策略1: ISBN精确匹配
    if new_book.isbn:
        for book in existing_books:
            if book.isbn == new_book.isbn:
                return (True, 1.0, book)

    # 策略2: 书名+作者模糊匹配
    for book in existing_books:
        # 计算书名相似度
        title_similarity = calculate_similarity(
            new_book.title, book.title
        )

        # 计算作者相似度
        author_similarity = calculate_similarity(
            new_book.author, book.author
        )

        # 综合相似度（书名权重0.6，作者权重0.4）
        overall_similarity = (
            title_similarity * 0.6 +
            author_similarity * 0.4
        )

        if overall_similarity > 0.9:
            return (True, overall_similarity, book)
        elif overall_similarity > 0.6:
            return (False, overall_similarity, book)  # 可能重复

    # 策略3: 出版社+出版日期辅助判断
    for book in existing_books:
        if (new_book.publisher == book.publisher and
            new_book.publish_date == book.publish_date):
            title_sim = calculate_similarity(
                new_book.title, book.title
            )
            if title_sim > 0.7:
                return (False, 0.75, book)  # 可能重复

    return (False, 0, None)


def calculate_similarity(str1, str2):
    """
    计算字符串相似度（使用编辑距离算法）
    """
    from difflib import SequenceMatcher
    return SequenceMatcher(None, str1, str2).ratio()
```

---

## 5. 数据自动补全

### 5.1 补全策略

| 数据源 | 优先级 | 补全字段 | 成功率 |
|--------|--------|---------|--------|
| 豆瓣读书 | ⭐⭐⭐⭐⭐ | 封面、简介、评分、标签、分类 | 90% |
| 国家图书馆 | ⭐⭐⭐⭐ | 中图法分类、ISBN、标准书目信息 | 75% |
| Google Books | ⭐⭐⭐ | 英文书封面、详情、预览 | 60% |
| 孔夫子旧书网 | ⭐⭐ | 旧书价格参考 | 40% |

### 5.2 补全流程

```
录入基本信息（书名+作者）
          ↓
    并发请求多个API
          ↓
  ┌────────┬────────┬────────┐
  │ 豆瓣   │ 国图   │ Google │
  └────────┴────────┴────────┘
          ↓
    数据合并与优选
          ↓
  ┌────────────────────────┐
  │ 书名    → 豆瓣（置信度高）│
  │ 作者    → 豆瓣          │
  │ 封面    → 豆瓣          │
  │ ISBN    → 国图          │
  │ 出版社  → 国图          │
  │ 简介    → 豆瓣          │
  │ 目录    → Google        │
  │ 中图法  → 国图          │
  └────────────────────────┘
          ↓
    展示给用户确认
```

### 5.3 补全示例

```
┌──────────────────────────────────────┐
│  🔄 正在自动补全书籍信息...           │
├──────────────────────────────────────┤
│                                      │
│  基本信息：                           │
│  书名：三体                           │
│  作者：刘慈欣                         │
│                                      │
│  补全进度：                           │
│  ┌────────────────────────────────┐ │
│  │ ✅ 封面图片    (豆瓣读书)       │ │
│  │ ✅ ISBN        (国家图书馆)     │ │
│  │ ✅ 出版信息    (豆瓣读书)       │ │
│  │ ✅ 内容简介    (豆瓣读书)       │ │
│  │ ✅ 目录信息    (Google Books)   │ │
│  │ ✅ 分类标签    (豆瓣读书)       │ │
│  │ ✅ 读者评分    (豆瓣读书)       │ │
│  │ ⏳ 书评数据    (爬虫抓取中...)  │ │
│  └────────────────────────────────┘ │
│                                      │
│  已补全 7/8 项信息                    │
│                                      │
└──────────────────────────────────────┘
```

---

## 6. 数据库设计

### 6.1 书籍主表

```sql
CREATE TABLE books (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '书籍ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 基本信息
    title VARCHAR(200) NOT NULL COMMENT '书名',
    subtitle VARCHAR(200) COMMENT '副标题',
    original_title VARCHAR(200) COMMENT '原作名',
    author VARCHAR(500) NOT NULL COMMENT '作者，多作者用"/"分隔',
    translator VARCHAR(200) COMMENT '译者',

    -- 出版信息
    isbn VARCHAR(20) COMMENT 'ISBN（可能为空）',
    isbn_10 VARCHAR(10) COMMENT 'ISBN-10',
    publisher VARCHAR(100) COMMENT '出版社',
    publish_date DATE COMMENT '出版日期',
    edition VARCHAR(50) COMMENT '版次',
    printing VARCHAR(50) COMMENT '印次',

    -- 物理属性
    binding ENUM('平装', '精装', '简装', '其他') COMMENT '装帧',
    pages INT COMMENT '页数',
    price DECIMAL(10,2) COMMENT '定价',

    -- 分类与标签
    category_id INT COMMENT '分类ID',
    category_path VARCHAR(200) COMMENT '分类路径：小说>科幻',
    tags JSON COMMENT '标签数组',

    -- 书架位置
    bookshelf_id BIGINT COMMENT '书架ID',
    location_code VARCHAR(50) COMMENT '位置编码：A01-03-05',

    -- 内容信息
    cover_image_url VARCHAR(500) COMMENT '封面图片URL',
    summary TEXT COMMENT '内容简介',
    catalog TEXT COMMENT '目录',
    author_intro TEXT COMMENT '作者简介',

    -- 阅读状态
    reading_status ENUM('unread', 'reading', 'finished', 'abandoned') DEFAULT 'unread',
    rating TINYINT COMMENT '个人评分 1-5星',
    reading_notes TEXT COMMENT '读书笔记',

    -- 购买信息
    purchase_date DATE COMMENT '购买日期',
    purchase_price DECIMAL(10,2) COMMENT '购买价格',
    purchase_channel VARCHAR(100) COMMENT '购买渠道',

    -- 借阅信息
    is_lent BOOLEAN DEFAULT FALSE COMMENT '是否借出',
    lent_to VARCHAR(100) COMMENT '借给谁',
    lent_date DATE COMMENT '借出日期',
    expected_return_date DATE COMMENT '预计归还日期',

    -- 隐私设置
    is_private BOOLEAN DEFAULT FALSE COMMENT '是否私藏',
    is_shared BOOLEAN DEFAULT TRUE COMMENT '是否可分享',

    -- 录入信息
    entry_method ENUM('scan', 'manual', 'import', 'ocr', 'voice') COMMENT '录入方式',
    data_source VARCHAR(50) COMMENT '数据来源：douban/nlc/google',
    is_verified BOOLEAN DEFAULT FALSE COMMENT '是否已核实信息',

    -- 元数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP NULL COMMENT '软删除时间',

    -- 索引
    INDEX idx_user (user_id),
    INDEX idx_isbn (isbn),
    INDEX idx_title (title),
    INDEX idx_author (author(100)),
    INDEX idx_category (category_id),
    INDEX idx_bookshelf (bookshelf_id),
    INDEX idx_status (reading_status),
    INDEX idx_created (created_at),
    FULLTEXT idx_fulltext (title, author, publisher)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='书籍主表';
```

### 6.2 录入日志表

```sql
CREATE TABLE book_entry_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    book_id BIGINT COMMENT '书籍ID（录入成功后填充）',
    entry_method ENUM('scan', 'manual', 'import', 'ocr', 'voice'),

    -- 录入数据
    raw_data JSON COMMENT '原始录入数据',
    isbn VARCHAR(20) COMMENT '扫描的ISBN',
    ocr_image_url VARCHAR(500) COMMENT 'OCR识别的图片URL',
    voice_text VARCHAR(500) COMMENT '语音识别的文本',

    -- 处理过程
    api_calls JSON COMMENT 'API调用记录',
    auto_filled_fields JSON COMMENT '自动补全的字段',
    manual_edited_fields JSON COMMENT '用户手工修改的字段',

    -- 查重结果
    duplicate_check_result JSON COMMENT '查重检测结果',
    is_duplicate BOOLEAN COMMENT '是否重复',

    -- 结果
    status ENUM('success', 'failed', 'duplicate', 'cancelled') COMMENT '录入状态',
    error_message TEXT COMMENT '错误信息',

    -- 时间统计
    started_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    duration_ms INT COMMENT '耗时（毫秒）',

    INDEX idx_user (user_id),
    INDEX idx_book (book_id),
    INDEX idx_method (entry_method),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='书籍录入日志表';
```

### 6.3 导入批次表

```sql
CREATE TABLE import_batches (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT '用户ID',
    batch_no VARCHAR(50) UNIQUE NOT NULL COMMENT '批次号',

    -- 文件信息
    file_name VARCHAR(200) COMMENT '文件名',
    file_size INT COMMENT '文件大小（字节）',
    file_url VARCHAR(500) COMMENT '文件URL',

    -- 导入统计
    total_rows INT COMMENT '总行数',
    success_count INT DEFAULT 0 COMMENT '成功导入数',
    duplicate_count INT DEFAULT 0 COMMENT '重复数',
    error_count INT DEFAULT 0 COMMENT '错误数',

    -- 处理结果
    status ENUM('pending', 'processing', 'completed', 'failed') DEFAULT 'pending',
    error_report JSON COMMENT '错误报告',

    -- 时间
    started_at TIMESTAMP NULL,
    completed_at TIMESTAMP NULL,
    duration_seconds INT COMMENT '耗时（秒）',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user (user_id),
    INDEX idx_batch (batch_no),
    INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='导入批次表';
```

---

## 7. API接口设计

### 7.1 扫码录入

```http
POST /api/v1/books/scan
Authorization: Bearer {token}
Content-Type: application/json

{
  "isbn": "978-7-5366-9293-0",
  "auto_fill": true,
  "check_duplicate": true
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "book_info": {
      "title": "三体",
      "author": "刘慈欣",
      "publisher": "重庆出版社",
      "publish_date": "2008-01",
      "isbn": "978-7-5366-9293-0",
      "cover_image": "https://...",
      "price": 32.00,
      "summary": "...",
      "category_suggestion": {
        "level1": "小说",
        "level2": "科幻",
        "confidence": 0.95
      },
      "bookshelf_suggestion": {
        "bookshelf_id": 5,
        "bookshelf_name": "书房-A01书架",
        "reason": "已有2本同作者书籍"
      }
    },
    "duplicate_check": {
      "is_duplicate": false,
      "similar_books": []
    },
    "data_sources": ["douban", "nlc"],
    "auto_filled_fields": ["cover_image", "summary", "price"]
  }
}
```

### 7.2 手工录入

```http
POST /api/v1/books/manual
Authorization: Bearer {token}
Content-Type: application/json

{
  "title": "三体",
  "author": "刘慈欣",
  "publisher": "重庆出版社",
  "publish_date": "2008-01",
  "isbn": "978-7-5366-9293-0",
  "category_id": 11,
  "bookshelf_id": 5,
  "location_code": "A01-03-05",
  "reading_status": "finished",
  "auto_fill": true
}
```

### 7.3 批量导入

```http
POST /api/v1/books/import/upload
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: my_books.xlsx
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "batch_no": "BATCH20250115001",
    "file_name": "my_books.xlsx",
    "total_rows": 326,
    "preview": [
      {"title": "三体", "author": "刘慈欣", "isbn": "978-7-5366-9293-0"},
      {"title": "活着", "author": "余华", "isbn": "978-7-5080-3916-9"}
    ]
  }
}
```

```http
POST /api/v1/books/import/execute
Authorization: Bearer {token}
Content-Type: application/json

{
  "batch_no": "BATCH20250115001",
  "field_mapping": {
    "col_0": "title",
    "col_1": "author",
    "col_2": "isbn"
  },
  "options": {
    "auto_fill": true,
    "check_duplicate": true,
    "duplicate_strategy": "skip"
  }
}
```

### 7.4 OCR识别

```http
POST /api/v1/books/ocr
Authorization: Bearer {token}
Content-Type: multipart/form-data

image: cover.jpg
ocr_target: cover  // cover | copyright_page | catalog
```

### 7.5 语音识别

```http
POST /api/v1/books/voice
Authorization: Bearer {token}
Content-Type: multipart/form-data

audio: recording.mp3
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "recognized_text": "三体，刘慈欣",
    "parsed_info": {
      "title": "三体",
      "author": "刘慈欣"
    },
    "search_results": [
      {
        "title": "三体",
        "author": "刘慈欣",
        "publisher": "重庆出版社",
        "isbn": "978-7-5366-9293-0"
      }
    ]
  }
}
```

---

## 8. 实施计划

| 阶段 | 任务 | 工期 | 优先级 |
|------|------|------|--------|
| 第1-2周 | 扫码录入功能（P0） | 2周 | P0 |
| 第2-3周 | 手工录入功能（P0） | 1周 | P0 |
| 第3-4周 | 查重机制实现 | 1周 | P0 |
| 第4-5周 | 数据自动补全 | 1周 | P0 |
| 第6-7周 | Excel批量导入（P1） | 2周 | P1 |
| 第7-8周 | OCR拍照识别（P1） | 1周 | P1 |
| 第9周 | 语音录入（P2） | 1周 | P2 |
| 第10周 | 测试与优化 | 1周 | P0 |

---

**文档版本**: v1.0.0
**创建日期**: 2025-01-15
**更新日期**: 2025-01-15
**文档状态**: ✅ 已完成
**维护人**: 产品经理
