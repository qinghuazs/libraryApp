# 标签管理需求文档

## 1. 概述

### 1.1 功能定位

标签管理是书籍分类管理的重要补充，提供更灵活、更个性化的书籍组织方式。与固定的分类体系不同，标签是扁平化、用户自定义的，允许一本书拥有多个标签，满足用户多维度管理藏书的需求。

### 1.2 分类 vs 标签

| 对比维度 | 分类管理 | 标签管理 |
|---------|---------|---------|
| **结构** | 层级结构（一级>二级） | 扁平结构 |
| **数量限制** | 一本书只有1个分类 | 一本书可有多个标签 |
| **管理方式** | 管理员预设 + 可自定义 | 用户完全自定义 |
| **使用场景** | 基础分类、图书馆式管理 | 个性化组织、多维度检索 |
| **示例** | 小说 > 科幻 | #硬科幻 #雨果奖 #三部曲 |

### 1.3 设计原则

- **灵活自由**：用户可自由创建、编辑、删除标签
- **快速关联**：支持快速为书籍添加/移除标签
- **智能推荐**：基于历史数据智能推荐标签
- **可视化管理**：标签云、颜色分组、统计分析
- **多端同步**：标签数据云端同步

---

## 2. 标签分类体系

### 2.1 系统预设标签

为帮助用户快速上手，系统预设常用标签：

| 标签类型 | 标签示例 | 颜色建议 | 说明 |
|---------|---------|---------|------|
| **阅读状态** | #想读 #在读 #读完 #弃读 | 🔵 蓝色 | 阅读进度追踪 |
| **评价标签** | #五星力荐 #值得一读 #一般 #不推荐 | ⭐ 黄色 | 个人评价 |
| **阅读目的** | #专业学习 #休闲阅读 #工作参考 #考试准备 | 🟢 绿色 | 阅读动机 |
| **情绪感受** | #治愈系 #烧脑 #轻松 #感动 #压抑 | 🟡 橙色 | 阅读体验 |
| **主题标签** | #时间管理 #人际关系 #心理成长 #技术提升 | 🟣 紫色 | 内容主题 |
| **获奖标签** | #诺贝尔奖 #雨果奖 #茅盾奖 #鲁迅奖 | 🏆 金色 | 获奖信息 |
| **阅读场景** | #睡前读物 #通勤读物 #旅行必备 #收藏级 | 🔴 红色 | 使用场景 |
| **来源标签** | #自购 #赠送 #借阅 #图书馆 | ⚪ 灰色 | 获取途径 |
| **状态标签** | #已借出 #已归还 #待购买 #已损坏 | 🟤 棕色 | 物理状态 |

### 2.2 标签命名规范

```
标签命名建议：
✅ 推荐：简短有力，2-8个字
   - #硬科幻 #雨果奖 #三部曲

✅ 推荐：使用"#"前缀（可选）
   - #时间管理 或 时间管理

❌ 避免：过长的标签
   - #这是一本非常值得阅读的关于时间管理的书

❌ 避免：重复分类信息
   - #小说 #科幻（已有分类，无需重复）

✅ 推荐：使用中文或英文
   - #硬科幻 #Hard-SciFi

✅ 推荐：有意义的标签
   - #2025阅读计划 #刘慈欣作品 #待写书评
```

---

## 3. 核心功能

### 3.1 标签创建

#### 3.1.1 创建方式

**方式1：录入书籍时创建**

```
┌──────────────────────────────────────┐
│  标签                                 │
├──────────────────────────────────────┤
│                                      │
│  常用标签（点击快速添加）：           │
│  ┌────┬────┬────┬────┬────┐        │
│  │想读│在读│读完│五星│推荐│        │
│  └────┴────┴────┴────┴────┘        │
│                                      │
│  已添加：                             │
│  [#硬科幻 ×] [#雨果奖 ×] [#三部曲 ×] │
│                                      │
│  添加新标签：                         │
│  ┌────────────────────────────────┐ │
│  │ #刘慈欣作品            [添加]   │ │
│  └────────────────────────────────┘ │
│                                      │
│  💡 标签建议（基于书籍信息）：        │
│  [+ 科幻小说] [+ 中国科幻] [+ 太空歌剧]│
│                                      │
└──────────────────────────────────────┘
```

**方式2：标签管理页面创建**

```
┌──────────────────────────────────────┐
│  🏷️ 标签管理         [ + 新建标签 ]   │
├──────────────────────────────────────┤
│                                      │
│  [ + 新建标签 ] 对话框：              │
│  ┌────────────────────────────────┐ │
│  │ 创建新标签                      │ │
│  ├────────────────────────────────┤ │
│  │                                │ │
│  │ 标签名称：*                     │ │
│  │ ┌──────────────────────────┐  │ │
│  │ │ #                        │  │ │
│  │ └──────────────────────────┘  │ │
│  │                                │ │
│  │ 标签颜色：                      │ │
│  │ ┌─┬─┬─┬─┬─┬─┬─┬─┐          │ │
│  │ │🔴│🟠│🟡│🟢│🔵│🟣│🟤│⚫│          │ │
│  │ └─┴─┴─┴─┴─┴─┴─┴─┘          │ │
│  │ 或自定义: [#FF5733]           │ │
│  │                                │ │
│  │ 标签分组：（可选）              │ │
│  │ ┌──────────────────────────┐  │ │
│  │ │ 阅读状态              ▾  │  │ │
│  │ └──────────────────────────┘  │ │
│  │                                │ │
│  │ 标签描述：（可选）              │ │
│  │ ┌──────────────────────────┐  │ │
│  │ │ 用于标记获得雨果奖的作品  │  │ │
│  │ └──────────────────────────┘  │ │
│  │                                │ │
│  │ [ 取消 ]         [ 创建 ]     │ │
│  └────────────────────────────────┘ │
│                                      │
└──────────────────────────────────────┘
```

#### 3.1.2 智能推荐标签

系统根据以下信息自动推荐标签：

```python
def recommend_tags(book):
    """智能推荐标签"""
    recommended_tags = []

    # 规则1: 基于分类推荐
    if book.category == "小说-科幻":
        recommended_tags.extend(["科幻小说", "科幻"])

    # 规则2: 基于作者推荐
    author_tags = get_common_tags_by_author(book.author)
    recommended_tags.extend(author_tags)  # ["刘慈欣作品", "华语科幻"]

    # 规则3: 基于书名关键词
    keywords = extract_keywords(book.title)
    recommended_tags.extend(keywords)  # ["三部曲"]

    # 规则4: 基于豆瓣/外部API的标签
    if book.douban_tags:
        recommended_tags.extend(book.douban_tags[:5])  # 取前5个

    # 规则5: 基于获奖信息
    if "雨果奖" in book.summary:
        recommended_tags.append("雨果奖")

    # 规则6: 基于用户历史（协同过滤）
    similar_books_tags = get_tags_from_similar_books(book)
    recommended_tags.extend(similar_books_tags)

    # 去重并按相关性排序
    return deduplicate_and_rank(recommended_tags)
```

### 3.2 标签编辑

```
┌──────────────────────────────────────┐
│  编辑标签                             │
├──────────────────────────────────────┤
│                                      │
│  标签名称：*                          │
│  ┌────────────────────────────────┐ │
│  │ #雨果奖                        │ │
│  └────────────────────────────────┘ │
│                                      │
│  标签颜色：                           │
│  ● 🟡 黄色  ○ 🔴 红色  ○ 🔵 蓝色   │
│                                      │
│  标签分组：                           │
│  ┌────────────────────────────────┐ │
│  │ 获奖标签              ▾        │ │
│  └────────────────────────────────┘ │
│                                      │
│  使用统计：                           │
│  • 已标记书籍：12 本                  │
│  • 创建时间：2024-12-15               │
│  • 最后使用：2025-01-10               │
│                                      │
│  ⚠️ 修改标签后，所有使用该标签的      │
│     书籍将自动更新。                  │
│                                      │
│  [ 删除标签 ]  [ 取消 ]  [ 保存 ]    │
│                                      │
└──────────────────────────────────────┘
```

### 3.3 标签删除

```
┌──────────────────────────────────────┐
│  ⚠️  删除标签                         │
├──────────────────────────────────────┤
│                                      │
│  确定要删除标签"#雨果奖"吗？          │
│                                      │
│  该标签当前用于 12 本书籍：           │
│  • 三体                               │
│  • 三体Ⅱ·黑暗森林                     │
│  • 银河帝国                           │
│  • ... （还有9本）                    │
│                                      │
│  删除后：                             │
│  ✓ 标签将从所有书籍中移除             │
│  ✓ 相关统计数据将被清除               │
│  ✗ 此操作不可撤销                    │
│                                      │
│  ☑ 我确认要删除该标签                │
│                                      │
│  [ 取消 ]         [ 确认删除 ]       │
│                                      │
└──────────────────────────────────────┘
```

### 3.4 标签合并

当用户创建了语义相似的标签时，支持合并：

```
┌──────────────────────────────────────┐
│  合并标签                             │
├──────────────────────────────────────┤
│                                      │
│  源标签（将被合并）：                 │
│  ┌────────────────────────────────┐ │
│  │ #科幻              ▾           │ │
│  └────────────────────────────────┘ │
│  使用于 8 本书籍                      │
│                                      │
│  ↓ 合并到                             │
│                                      │
│  目标标签（保留）：                   │
│  ┌────────────────────────────────┐ │
│  │ #科幻小说          ▾           │ │
│  └────────────────────────────────┘ │
│  使用于 15 本书籍                     │
│                                      │
│  合并后：                             │
│  • 源标签"#科幻"将被删除              │
│  • 所有使用"#科幻"的书籍将改用        │
│    "#科幻小说"标签                    │
│  • 合并后共 23 本书籍使用该标签       │
│                                      │
│  [ 取消 ]         [ 确认合并 ]       │
│                                      │
└──────────────────────────────────────┘
```

### 3.5 批量管理标签

```
┌──────────────────────────────────────┐
│  批量管理标签                         │
├──────────────────────────────────────┤
│                                      │
│  已选择：23 本书籍                    │
│                                      │
│  批量操作：                           │
│                                      │
│  添加标签：                           │
│  ┌────────────────────────────────┐ │
│  │ 选择或输入标签...       ▾      │ │
│  └────────────────────────────────┘ │
│  常用：[想读] [在读] [读完] [五星]   │
│                                      │
│  移除标签：                           │
│  现有标签（点击移除）：               │
│  [#科幻 ×] [#小说 ×] [#推荐 ×]       │
│                                      │
│  替换标签：                           │
│  将 [#科幻     ▾] 替换为 [#科幻小说▾]│
│                                      │
│  [ 取消 ]         [ 应用 ]           │
│                                      │
└──────────────────────────────────────┘
```

---

## 4. 标签展示与交互

### 4.1 标签云

```
┌──────────────────────────────────────┐
│  🏷️ 我的标签云                       │
├──────────────────────────────────────┤
│                                      │
│  排序：[热度 ▾] [字母 ▾] [时间 ▾]    │
│  过滤：[全部 ▾] [阅读状态] [主题]    │
│                                      │
│    三部曲       科幻小说              │
│        刘慈欣作品    雨果奖           │
│  推荐   在读  读完    想读            │
│      时间管理  心理学                 │
│    人工智能                           │
│  五星力荐    烧脑    轻松阅读         │
│      治愈系  东野圭吾    推理小说     │
│                                      │
│  字体大小 = 使用频率                  │
│  （最大：读完 89本，最小：人工智能 3本）│
│                                      │
│  [ 编辑模式 ]  [ 导出标签 ]          │
│                                      │
└──────────────────────────────────────┘
```

### 4.2 标签列表视图

```
┌──────────────────────────────────────┐
│  🏷️ 标签管理           [ + 新建 ]     │
├──────────────────────────────────────┤
│                                      │
│  🔍 搜索标签...    [ 批量操作 ▾ ]    │
│                                      │
│  分组：[全部] [阅读状态] [主题] ...  │
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 标签  │ 颜色 │ 书籍数 │ 操作    ││
│  ├────────────────────────────────┤ │
│  │ 读完  │ 🔵  │  89   │ 编辑 删除││
│  │ 在读  │ 🟢  │  12   │ 编辑 删除││
│  │ 想读  │ 🟡  │  45   │ 编辑 删除││
│  │ 五星  │ ⭐  │  32   │ 编辑 删除││
│  │ 科幻  │ 🟣  │  28   │ 编辑 删除││
│  │ 雨果奖│ 🏆  │  12   │ 编辑 删除││
│  │ ...   │ ... │  ...  │ ...     ││
│  └────────────────────────────────┘ │
│                                      │
│  总计：67 个标签  已使用：245 本      │
│                                      │
│  [ 导出标签.csv ]  [ 导入标签 ]      │
│                                      │
└──────────────────────────────────────┘
```

### 4.3 标签统计

```
┌──────────────────────────────────────┐
│  📊 标签统计                          │
├──────────────────────────────────────┤
│                                      │
│  使用最多的标签 (Top 10)：            │
│  ┌────────────────────────────────┐ │
│  │ 1. 读完      ████████████ 89   │ │
│  │ 2. 想读      ███████░░░░░ 45   │ │
│  │ 3. 五星      █████░░░░░░░ 32   │ │
│  │ 4. 科幻      ████░░░░░░░░ 28   │ │
│  │ 5. 推理      ███░░░░░░░░░ 23   │ │
│  └────────────────────────────────┘ │
│                                      │
│  最近添加的标签：                     │
│  • #2025阅读计划 (2025-01-15)         │
│  • #人工智能 (2025-01-10)             │
│  • #待写书评 (2025-01-08)             │
│                                      │
│  未使用标签（建议删除）：             │
│  • #测试标签1 (0本)                   │
│  • #临时标签 (0本)                    │
│                                      │
│  标签分布：                           │
│  • 阅读状态类：23个标签，178本书      │
│  • 主题类：18个标签，95本书           │
│  • 情绪类：12个标签，56本书           │
│  • 其他：14个标签，34本书             │
│                                      │
└──────────────────────────────────────┘
```

### 4.4 书籍详情页的标签展示

```
┌──────────────────────────────────────┐
│  📖 三体                              │
├──────────────────────────────────────┤
│                                      │
│  标签：                               │
│  [#读完] [#五星] [#科幻] [#雨果奖]   │
│  [#三部曲] [#刘慈欣作品] [+ 添加]    │
│                                      │
│  💡 点击标签查看相同标签的书籍        │
│                                      │
└──────────────────────────────────────┘
```

---

## 5. 标签检索与筛选

### 5.1 按标签筛选书籍

```
┌──────────────────────────────────────┐
│  📚 我的藏书                          │
├──────────────────────────────────────┤
│                                      │
│  筛选条件：                           │
│                                      │
│  标签（多选）：                       │
│  ☑ #科幻  ☑ #五星  ☐ #在读  ☐ #想读 │
│                                      │
│  逻辑关系：                           │
│  ● 同时满足（AND）  ○ 满足任一（OR） │
│                                      │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━   │
│                                      │
│  找到 12 本书籍（同时包含"科幻"和"五星"）│
│                                      │
│  ┌────────────────────────────────┐ │
│  │ 📖 三体                        │ │
│  │    刘慈欣 / 重庆出版社         │ │
│  │    标签：科幻 五星 雨果奖      │ │
│  └────────────────────────────────┘ │
│  ┌────────────────────────────────┐ │
│  │ 📖 银河帝国                    │ │
│  │    阿西莫夫 / 江苏文艺出版社   │ │
│  │    标签：科幻 五星 经典        │ │
│  └────────────────────────────────┘ │
│  ...                                 │
│                                      │
│  [ 清除筛选 ]  [ 保存为智能书单 ]    │
│                                      │
└──────────────────────────────────────┘
```

### 5.2 标签组合查询

```
高级查询示例：

查询1: 科幻 AND 五星 AND (在读 OR 想读)
结果: 同时满足"科幻"、"五星"，且阅读状态为"在读"或"想读"的书

查询2: (刘慈欣 OR 东野圭吾) AND 五星
结果: 作者标签为"刘慈欣"或"东野圭吾"，且评价为"五星"的书

查询3: 科幻 NOT 在读
结果: 标记为"科幻"但不是"在读"状态的书
```

### 5.3 智能书单（基于标签）

```
┌──────────────────────────────────────┐
│  💡 智能书单                          │
├──────────────────────────────────────┤
│                                      │
│  系统根据您的标签自动生成书单：       │
│                                      │
│  📚 我的五星推荐 (32本)               │
│     标签：#五星                       │
│     [查看] [分享]                     │
│                                      │
│  📖 2025阅读计划 (45本)               │
│     标签：#2025阅读计划 AND #想读     │
│     进度：12/45 (27%)                 │
│     [查看] [分享]                     │
│                                      │
│  🎯 专业学习书籍 (28本)               │
│     标签：#专业学习                   │
│     [查看] [分享]                     │
│                                      │
│  ⭐ 获奖作品收藏 (18本)               │
│     标签：#雨果奖 OR #诺贝尔奖 OR     │
│            #茅盾奖                    │
│     [查看] [分享]                     │
│                                      │
│  [ + 创建新的智能书单 ]               │
│                                      │
└──────────────────────────────────────┘
```

---

## 6. 数据库设计

### 6.1 标签表

```sql
CREATE TABLE tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT '标签ID',
    user_id BIGINT NOT NULL COMMENT '用户ID（0表示系统预设）',
    tag_name VARCHAR(50) NOT NULL COMMENT '标签名称',
    tag_name_normalized VARCHAR(50) COMMENT '标准化标签名（去#，小写）',

    -- 展示属性
    color VARCHAR(7) COMMENT '标签颜色 #FF5733',
    icon VARCHAR(50) COMMENT '标签图标',

    -- 分组
    tag_group VARCHAR(50) COMMENT '标签分组：阅读状态、主题、情绪等',
    tag_type ENUM('system', 'user') DEFAULT 'user' COMMENT '标签类型',

    -- 描述
    description VARCHAR(200) COMMENT '标签描述',

    -- 统计
    usage_count INT DEFAULT 0 COMMENT '使用次数（冗余字段）',

    -- 状态
    is_active BOOLEAN DEFAULT TRUE COMMENT '是否启用',
    is_public BOOLEAN DEFAULT FALSE COMMENT '是否公开（供其他用户使用）',

    -- 元数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    last_used_at TIMESTAMP NULL COMMENT '最后使用时间',

    -- 索引
    UNIQUE KEY uk_user_tag (user_id, tag_name_normalized),
    INDEX idx_user (user_id),
    INDEX idx_group (tag_group),
    INDEX idx_type (tag_type),
    INDEX idx_usage (usage_count)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签表';
```

### 6.2 书籍标签关联表

```sql
CREATE TABLE book_tags (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    book_id BIGINT NOT NULL COMMENT '书籍ID',
    tag_id BIGINT NOT NULL COMMENT '标签ID',
    user_id BIGINT NOT NULL COMMENT '用户ID',

    -- 标签来源
    tag_source ENUM('manual', 'auto', 'import', 'api') DEFAULT 'manual' COMMENT '标签来源',
    confidence_score DECIMAL(3,2) COMMENT '自动标签的置信度 0-1',

    -- 元数据
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    created_by BIGINT COMMENT '创建人（如果是协作标记）',

    -- 索引
    UNIQUE KEY uk_book_tag (book_id, tag_id),
    INDEX idx_book (book_id),
    INDEX idx_tag (tag_id),
    INDEX idx_user (user_id),
    INDEX idx_source (tag_source)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='书籍标签关联表';
```

### 6.3 标签分组表

```sql
CREATE TABLE tag_groups (
    id INT PRIMARY KEY AUTO_INCREMENT,
    group_name VARCHAR(50) NOT NULL COMMENT '分组名称',
    group_code VARCHAR(50) UNIQUE NOT NULL COMMENT '分组编码',
    description TEXT COMMENT '分组描述',
    icon VARCHAR(50) COMMENT '分组图标',
    sort_order INT DEFAULT 0 COMMENT '排序',
    is_system BOOLEAN DEFAULT FALSE COMMENT '是否系统预设',

    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    INDEX idx_code (group_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签分组表';

-- 初始化数据
INSERT INTO tag_groups (group_name, group_code, icon, sort_order, is_system) VALUES
('阅读状态', 'reading_status', '📖', 1, TRUE),
('评价标签', 'rating', '⭐', 2, TRUE),
('阅读目的', 'purpose', '🎯', 3, TRUE),
('情绪感受', 'emotion', '😊', 4, TRUE),
('主题标签', 'topic', '💡', 5, TRUE),
('获奖标签', 'award', '🏆', 6, TRUE),
('阅读场景', 'scene', '📍', 7, TRUE),
('来源标签', 'source', '🔖', 8, TRUE),
('状态标签', 'status', '📌', 9, TRUE),
('自定义', 'custom', '🏷️', 10, FALSE);
```

### 6.4 标签统计表

```sql
CREATE TABLE tag_statistics (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,
    tag_id BIGINT NOT NULL,

    -- 统计数据
    book_count INT DEFAULT 0 COMMENT '书籍数量',
    reading_count INT DEFAULT 0 COMMENT '在读数量',
    finished_count INT DEFAULT 0 COMMENT '读完数量',

    -- 时间分布
    last_7_days_count INT DEFAULT 0 COMMENT '近7天使用次数',
    last_30_days_count INT DEFAULT 0 COMMENT '近30天使用次数',

    -- 更新时间
    last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    UNIQUE KEY uk_user_tag (user_id, tag_id),
    INDEX idx_user (user_id),
    INDEX idx_tag (tag_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='标签统计表';
```

---

## 7. API 接口设计

### 7.1 获取标签列表

```http
GET /api/v1/tags?group={group_code}&sort={field}&order={asc|desc}
Authorization: Bearer {token}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "total": 67,
    "tags": [
      {
        "id": 1,
        "name": "#读完",
        "color": "#4A90E2",
        "group": "阅读状态",
        "usage_count": 89,
        "last_used_at": "2025-01-15 10:30:00"
      },
      {
        "id": 2,
        "name": "#五星",
        "color": "#FFD700",
        "group": "评价标签",
        "usage_count": 32,
        "last_used_at": "2025-01-14 15:20:00"
      }
    ]
  }
}
```

### 7.2 创建标签

```http
POST /api/v1/tags
Authorization: Bearer {token}
Content-Type: application/json

{
  "tag_name": "#雨果奖",
  "color": "#FFD700",
  "tag_group": "award",
  "description": "雨果奖获奖作品"
}
```

### 7.3 批量为书籍添加标签

```http
POST /api/v1/books/tags/batch
Authorization: Bearer {token}
Content-Type: application/json

{
  "book_ids": [123, 456, 789],
  "tag_ids": [1, 2, 3],
  "action": "add"  // add | remove | replace
}
```

### 7.4 按标签查询书籍

```http
GET /api/v1/books?tags=1,2,3&logic=AND
Authorization: Bearer {token}
```

**参数：**
- `tags`: 标签ID列表，逗号分隔
- `logic`: 逻辑关系，`AND`（同时满足）或 `OR`（满足任一）

### 7.5 获取标签推荐

```http
POST /api/v1/tags/recommend
Authorization: Bearer {token}
Content-Type: application/json

{
  "book_id": 123,
  "isbn": "978-7-5366-9293-0",
  "title": "三体",
  "author": "刘慈欣",
  "category": "小说-科幻"
}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "recommended_tags": [
      {
        "tag_name": "#科幻",
        "confidence": 0.95,
        "reason": "基于分类推荐"
      },
      {
        "tag_name": "#雨果奖",
        "confidence": 0.90,
        "reason": "基于获奖信息"
      },
      {
        "tag_name": "#刘慈欣作品",
        "confidence": 0.88,
        "reason": "基于作者推荐"
      }
    ]
  }
}
```

### 7.6 标签统计

```http
GET /api/v1/tags/statistics?period=30d
Authorization: Bearer {token}
```

**响应：**
```json
{
  "code": 200,
  "data": {
    "total_tags": 67,
    "total_usage": 245,
    "top_tags": [
      {"name": "#读完", "count": 89},
      {"name": "#想读", "count": 45},
      {"name": "#五星", "count": 32}
    ],
    "recent_tags": [
      {"name": "#2025阅读计划", "created_at": "2025-01-15"},
      {"name": "#人工智能", "created_at": "2025-01-10"}
    ],
    "unused_tags": [
      {"name": "#测试标签", "count": 0}
    ],
    "group_distribution": {
      "阅读状态": 178,
      "主题": 95,
      "情绪": 56,
      "其他": 34
    }
  }
}
```

### 7.7 合并标签

```http
POST /api/v1/tags/merge
Authorization: Bearer {token}
Content-Type: application/json

{
  "source_tag_id": 10,
  "target_tag_id": 5
}
```

---

## 8. 业务规则

### 8.1 标签约束

1. **标签名称**
   - 长度：2-20个字符
   - 格式：可包含中文、英文、数字、"#"前缀
   - 唯一性：同一用户下标签名不能重复（忽略大小写、"#"前缀）

2. **标签数量**
   - 每个用户最多创建 500 个标签
   - 每本书最多关联 20 个标签
   - 系统预设标签不占用用户配额

3. **标签删除**
   - 删除标签时，自动移除所有书籍的该标签关联
   - 系统预设标签不可删除，仅可隐藏

### 8.2 自动标签规则

```python
# 自动标签触发条件

# 规则1: 阅读状态自动更新
if book.reading_status == 'finished':
    auto_add_tag(book, '#读完')
    auto_remove_tag(book, '#在读')
    auto_remove_tag(book, '#想读')

# 规则2: 评分自动标签
if book.rating == 5:
    auto_add_tag(book, '#五星')
elif book.rating == 4:
    auto_add_tag(book, '#四星')

# 规则3: 借阅状态标签
if book.is_lent:
    auto_add_tag(book, '#已借出')
else:
    auto_remove_tag(book, '#已借出')

# 规则4: 作者系列标签
if book.author == '刘慈欣':
    suggest_tag(book, '#刘慈欣作品')
```

### 8.3 标签查重

```python
def normalize_tag_name(tag_name):
    """标准化标签名称"""
    # 1. 去除首尾空格
    tag = tag_name.strip()

    # 2. 去除"#"前缀
    if tag.startswith('#'):
        tag = tag[1:]

    # 3. 转小写
    tag = tag.lower()

    # 4. 去除特殊字符
    tag = re.sub(r'[^\w\u4e00-\u9fff]', '', tag)

    return tag

# 创建标签时检查
def check_tag_duplicate(user_id, tag_name):
    normalized = normalize_tag_name(tag_name)
    existing = db.query(
        "SELECT * FROM tags WHERE user_id = ? AND tag_name_normalized = ?",
        user_id, normalized
    )

    if existing:
        return {
            "is_duplicate": True,
            "existing_tag": existing[0]
        }

    return {"is_duplicate": False}
```

---

## 9. 用户体验优化

### 9.1 标签输入体验

```
┌──────────────────────────────────────┐
│  添加标签                             │
├──────────────────────────────────────┤
│                                      │
│  ┌────────────────────────────────┐ │
│  │ #                              │ │
│  └────────────────────────────────┘ │
│         ↓ 输入"科"后                  │
│  ┌────────────────────────────────┐ │
│  │ #科▌                           │ │
│  └────────────────────────────────┘ │
│                                      │
│  智能提示：                           │
│  ┌────────────────────────────────┐ │
│  │ ✨ #科幻 (已用于28本)           │ │
│  │ ✨ #科普 (已用于12本)           │ │
│  │ ✨ #科幻小说 (已用于15本)       │ │
│  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━  │ │
│  │ 💡 创建新标签 "#科"             │ │
│  └────────────────────────────────┘ │
│                                      │
│  快速选择（空格键激活）：             │
│  [科幻] [科普] [科学] [科技]          │
│                                      │
└──────────────────────────────────────┘
```

### 9.2 拖拽添加标签

```
书籍列表中拖拽标签到书籍：

┌─────────────┐
│ 标签侧边栏  │
│             │
│ #科幻  ─────┼──→ 拖拽到书籍卡片
│ #五星       │
│ #在读       │
└─────────────┘
        ↓
┌──────────────────────┐
│ 📖 三体              │
│    标签：[#科幻] ← 已添加
└──────────────────────┘
```

### 9.3 快捷键支持

| 快捷键 | 功能 |
|--------|------|
| `Ctrl + T` | 打开标签管理面板 |
| `Ctrl + Shift + T` | 为当前书籍添加标签 |
| `Alt + 1-9` | 快速添加常用标签1-9 |
| `Backspace` | 移除最后添加的标签 |
| `Enter` | 确认标签输入 |
| `Esc` | 关闭标签面板 |

---

## 10. 数据导入导出

### 10.1 导出标签

```
导出格式：CSV / JSON / Excel

CSV 示例：
标签名称,标签颜色,分组,使用次数,创建时间
#读完,#4A90E2,阅读状态,89,2024-12-15
#五星,#FFD700,评价标签,32,2024-12-20
#科幻,#9370DB,主题,28,2025-01-05
```

### 10.2 导入标签

```
支持从以下来源导入：
1. 豆瓣读书标签
2. 微信读书标签
3. Goodreads 标签
4. CSV/Excel 文件

导入时自动：
- 去重（标准化标签名）
- 映射分组
- 关联书籍（如果有ISBN）
```

---

## 11. 实施计划

| 阶段 | 任务 | 工期 | 优先级 |
|------|------|------|--------|
| 第1周 | 数据库表设计与创建 | 1周 | P0 |
| 第2周 | 标签CRUD基础功能 | 1周 | P0 |
| 第3周 | 标签与书籍关联 | 1周 | P0 |
| 第4周 | 智能标签推荐 | 1周 | P1 |
| 第5周 | 标签云可视化 | 1周 | P1 |
| 第6周 | 批量操作、合并功能 | 1周 | P1 |
| 第7周 | 标签统计与分析 | 1周 | P2 |
| 第8周 | 导入导出功能 | 1周 | P2 |
| 第9周 | 测试与优化 | 1周 | P0 |

---

## 12. 测试用例

| 测试项 | 预期结果 |
|--------|---------|
| 创建标签 | 成功创建，自动去重 |
| 标签名重复 | 提示已存在，建议使用现有标签 |
| 为书籍添加标签 | 成功关联，实时更新 |
| 删除标签 | 提示影响范围，确认后删除 |
| 合并标签 | 所有关联书籍迁移到目标标签 |
| 批量添加标签 | 同时为多本书添加标签 |
| 按标签筛选 | 正确返回符合条件的书籍 |
| 标签推荐 | 根据书籍信息推荐相关标签 |
| 标签云展示 | 字体大小正确反映使用频率 |
| 导出标签 | 生成正确格式的文件 |

---

**文档版本**: v1.0.0
**创建日期**: 2025-01-15
**更新日期**: 2025-01-15
**文档状态**: ✅ 已完成
**维护人**: 产品经理
