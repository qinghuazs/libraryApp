# å›¾ä¹¦APPç”¨æˆ·æ¨¡å— - æ•°æ®å®‰å…¨æ·±åº¦åˆ†ææ–‡æ¡£

## æ–‡æ¡£ä¿¡æ¯
- **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
- **åˆ›å»ºæ—¥æœŸ**: 2025-10-14
- **æ€è€ƒæ¨¡å¼**: UltraThinkæ·±åº¦åˆ†æ
- **å®‰å…¨çº§åˆ«**: ä¼ä¸šçº§æ•°æ®å®‰å…¨æ ‡å‡†

---

## 1. ç°æœ‰å®‰å…¨è®¾è®¡è¯„ä¼°

### 1.1 å½“å‰è®¾è®¡çš„å®‰å…¨æªæ–½

âœ… **å·²å®ç°çš„å®‰å…¨åŠŸèƒ½ï¼š**
- å¯†ç ä½¿ç”¨bcryptå“ˆå¸ŒåŠ å¯†
- æ•æ„Ÿå­—æ®µï¼ˆæ‰‹æœºå·ã€èº«ä»½è¯ï¼‰åŠ å¯†å­˜å‚¨
- ç™»å½•å¤±è´¥æ¬¡æ•°é™åˆ¶ï¼ˆ5æ¬¡é”å®š30åˆ†é’Ÿï¼‰
- è½¯åˆ é™¤æœºåˆ¶ï¼ˆæ•°æ®å¯è¿½æº¯ï¼‰
- ç™»å½•æ—¥å¿—è®°å½•ï¼ˆIPã€è®¾å¤‡ã€æ—¶é—´ï¼‰

âš ï¸ **å­˜åœ¨çš„å®‰å…¨éšæ‚£ï¼š**
- ç”¨æˆ·ç¬”è®°å†…å®¹æ˜æ–‡å­˜å‚¨ï¼ˆæ•°æ®åº“æ³„éœ²é£é™©ï¼‰
- æ²¡æœ‰æ•°æ®è®¿é—®å®¡è®¡æ—¥å¿—
- ç¼ºå°‘æ•æ„Ÿæ“ä½œçš„äºŒæ¬¡éªŒè¯
- æ²¡æœ‰æ•°æ®å¯¼å‡ºå’Œæ³¨é”€çš„å®Œæ•´æ–¹æ¡ˆ
- ç¼ºå°‘è®¾å¤‡ä¿¡ä»»æœºåˆ¶

---

## 2. æ·±åº¦å®‰å…¨å¨èƒåˆ†æ

### 2.1 å¨èƒæ¨¡å‹ï¼ˆSTRIDEï¼‰

| å¨èƒç±»å‹ | å…·ä½“åœºæ™¯ | å½“å‰é˜²æŠ¤ | é£é™©ç­‰çº§ |
|---------|---------|---------|---------|
| **S**poofingï¼ˆä¼ªè£…ï¼‰ | æ”»å‡»è€…ä¼ªé€ ç”¨æˆ·èº«ä»½ç™»å½• | å¯†ç éªŒè¯ã€è®¾å¤‡æŒ‡çº¹ | ğŸŸ¡ ä¸­ |
| **T**amperingï¼ˆç¯¡æ”¹ï¼‰ | æ”»å‡»è€…ä¿®æ”¹ä»–äººçš„é˜…è¯»è®°å½• | æƒé™éªŒè¯ã€äº‹åŠ¡å®Œæ•´æ€§ | ğŸŸ¢ ä½ |
| **R**epudiationï¼ˆæŠµèµ–ï¼‰ | ç”¨æˆ·å¦è®¤è‡ªå·±çš„æ“ä½œ | ç™»å½•æ—¥å¿— | ğŸŸ¡ ä¸­ |
| **I**nformation Disclosureï¼ˆä¿¡æ¯æ³„éœ²ï¼‰ | æ•°æ®åº“æ³„éœ²å¯¼è‡´ç¬”è®°å†…å®¹æš´éœ² | âŒ æ— åŠ å¯† | ğŸ”´ é«˜ |
| **D**enial of Serviceï¼ˆæ‹’ç»æœåŠ¡ï¼‰ | æ¶æ„ç”¨æˆ·å¤§é‡è¯·æ±‚æ”»å‡» | é™æµæœºåˆ¶ | ğŸŸ¡ ä¸­ |
| **E**levation of Privilegeï¼ˆæƒé™æå‡ï¼‰ | æ™®é€šç”¨æˆ·è·å–ç®¡ç†å‘˜æƒé™ | æƒé™è¡¨ã€RBAC | ğŸŸ¢ ä½ |

---

## 3. æ•æ„Ÿæ•°æ®åŠ å¯†æ–¹æ¡ˆ

### 3.1 æ•°æ®åˆ†ç±»ä¸åŠ å¯†ç­–ç•¥

| æ•°æ®ç±»å‹ | æ•æ„Ÿçº§åˆ« | åŠ å¯†æ–¹å¼ | ç¤ºä¾‹ |
|---------|---------|---------|------|
| **å¯†ç ** | æé«˜ | bcrypt/argon2ï¼ˆå•å‘å“ˆå¸Œï¼‰ | `$2b$12$...` |
| **èº«ä»½è¯å·** | æé«˜ | AES-256-GCM + å¯†é’¥ç®¡ç† | `3301***********234` |
| **æ‰‹æœºå·** | é«˜ | AES-256-GCM + å¯†é’¥ç®¡ç† | `138****5678` |
| **ç¬”è®°å†…å®¹** | é«˜ | AES-256-GCMï¼ˆç”¨æˆ·ä¸“å±å¯†é’¥ï¼‰ | åŠ å¯†åçš„Blob |
| **é˜…è¯»å†å²** | ä¸­ | å¯é€‰åŠ å¯†ï¼ˆéšç§æ¨¡å¼ï¼‰ | æ˜æ–‡æˆ–åŠ å¯† |
| **é‚®ç®±** | ä¸­ | æ˜æ–‡ + è„±æ•å±•ç¤º | `u***@example.com` |
| **ç”¨æˆ·å** | ä½ | æ˜æ–‡ | æ— éœ€åŠ å¯† |

---

### 3.2 ç¬”è®°å†…å®¹åŠ å¯†æ–¹æ¡ˆè®¾è®¡

#### æ–¹æ¡ˆ1ï¼šç”¨æˆ·ä¸“å±å¯†é’¥ï¼ˆæ¨èï¼‰

**åŸç†ï¼š**
æ¯ä¸ªç”¨æˆ·æ‹¥æœ‰ç‹¬ç«‹çš„åŠ å¯†å¯†é’¥ï¼Œç¬”è®°ä½¿ç”¨ç”¨æˆ·å¯†é’¥åŠ å¯†ã€‚å³ä½¿æ•°æ®åº“æ³„éœ²ï¼Œæ”»å‡»è€…æ— æ³•æ‰¹é‡è§£å¯†ã€‚

**è¡¨ç»“æ„ä¿®æ”¹ï¼š**
```sql
-- 1. ç”¨æˆ·å¯†é’¥è¡¨ï¼ˆåŠ å¯†å¯†é’¥çš„å¯†é’¥ï¼‰
CREATE TABLE user_encryption_keys (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNIQUE NOT NULL,

    -- ç”¨æˆ·æ•°æ®åŠ å¯†å¯†é’¥ï¼ˆDEK - Data Encryption Keyï¼‰
    dek_encrypted BLOB NOT NULL COMMENT 'åŠ å¯†çš„æ•°æ®åŠ å¯†å¯†é’¥',
    dek_key_id VARCHAR(100) NOT NULL COMMENT 'ç”¨äºåŠ å¯†DEKçš„KEK ID',

    -- å¯†é’¥ç‰ˆæœ¬ï¼ˆæ”¯æŒå¯†é’¥è½®æ¢ï¼‰
    key_version INT DEFAULT 1,

    -- å¯†é’¥ç”Ÿæˆä¿¡æ¯
    algorithm VARCHAR(50) DEFAULT 'AES-256-GCM',
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    rotated_at DATETIME COMMENT 'æœ€åè½®æ¢æ—¶é—´',

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_key_version (key_version)
) COMMENT='ç”¨æˆ·åŠ å¯†å¯†é’¥è¡¨';

-- 2. ä¿®æ”¹ç¬”è®°è¡¨
ALTER TABLE user_reading_notes
ADD COLUMN note_content_encrypted BLOB COMMENT 'åŠ å¯†çš„ç¬”è®°å†…å®¹',
ADD COLUMN encryption_key_version INT DEFAULT 1 COMMENT 'åŠ å¯†å¯†é’¥ç‰ˆæœ¬',
ADD COLUMN encryption_iv VARCHAR(32) COMMENT 'åŠ å¯†åˆå§‹åŒ–å‘é‡ï¼ˆIVï¼‰';
```

**åŠ å¯†æ¶æ„å›¾ï¼š**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              å¯†é’¥ç®¡ç†æœåŠ¡ (KMS)                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  KEK (Key Encryption Key - ä¸»å¯†é’¥)       â”‚   â”‚
â”‚  â”‚  å­˜å‚¨åœ¨HSMæˆ–äº‘KMSä¸­                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                 â”‚ åŠ å¯†/è§£å¯†                      â”‚
â”‚                 â†“                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  DEK (Data Encryption Key - æ•°æ®å¯†é’¥)    â”‚   â”‚
â”‚  â”‚  æ¯ä¸ªç”¨æˆ·ä¸€ä¸ªï¼Œå­˜å‚¨åœ¨æ•°æ®åº“ï¼ˆåŠ å¯†åï¼‰     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ åŠ å¯†/è§£å¯†
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   ç”¨æˆ·ç¬”è®°æ˜æ–‡å†…å®¹    â”‚
         â”‚  "è¿™æœ¬ä¹¦è®©æˆ‘æ·±å—å¯å‘" â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚ AES-256-GCMåŠ å¯†
                  â†“
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  åŠ å¯†åçš„Blobæ•°æ®     â”‚
         â”‚  0x8A3F2E1B...       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚
                  â†“ å­˜å‚¨åˆ°MySQL
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ user_reading_notes   â”‚
         â”‚ note_content_encryptedâ”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å®ç°ä»£ç ï¼š**

```python
from cryptography.hazmat.primitives.ciphers import Cipher, algorithms, modes
from cryptography.hazmat.backends import default_backend
from cryptography.hazmat.primitives import hashes
from cryptography.hazmat.primitives.kdf.pbkdf2 import PBKDF2
import os
import base64

class UserDataEncryption:
    """ç”¨æˆ·æ•°æ®åŠ å¯†æœåŠ¡"""

    def __init__(self, kms_client):
        self.kms = kms_client  # å¯†é’¥ç®¡ç†æœåŠ¡å®¢æˆ·ç«¯

    async def create_user_key(self, user_id: int):
        """ä¸ºæ–°ç”¨æˆ·åˆ›å»ºåŠ å¯†å¯†é’¥"""
        # 1. ç”Ÿæˆ256ä½éšæœºå¯†é’¥ï¼ˆDEKï¼‰
        dek = os.urandom(32)  # 32 bytes = 256 bits

        # 2. ä½¿ç”¨KMSä¸»å¯†é’¥åŠ å¯†DEK
        kek_id = 'master-key-v1'
        dek_encrypted = await self.kms.encrypt(
            key_id=kek_id,
            plaintext=dek
        )

        # 3. å­˜å‚¨åŠ å¯†åçš„DEKåˆ°æ•°æ®åº“
        await mysql.execute("""
            INSERT INTO user_encryption_keys
            (user_id, dek_encrypted, dek_key_id, key_version)
            VALUES (%s, %s, %s, 1)
        """, (user_id, dek_encrypted, kek_id))

        return dek

    async def get_user_key(self, user_id: int) -> bytes:
        """è·å–ç”¨æˆ·çš„è§£å¯†å¯†é’¥"""
        # 1. ä»æ•°æ®åº“è¯»å–åŠ å¯†çš„DEK
        key_record = await mysql.fetchone("""
            SELECT dek_encrypted, dek_key_id, key_version
            FROM user_encryption_keys
            WHERE user_id = %s
        """, (user_id,))

        if not key_record:
            raise ValueError(f"No encryption key found for user {user_id}")

        # 2. ä½¿ç”¨KMSè§£å¯†DEK
        dek = await self.kms.decrypt(
            key_id=key_record['dek_key_id'],
            ciphertext=key_record['dek_encrypted']
        )

        # 3. ç¼“å­˜åˆ°Redisï¼ˆTTL: 1å°æ—¶ï¼‰
        redis.setex(
            f'user:dek:{user_id}',
            3600,
            base64.b64encode(dek)
        )

        return dek

    def encrypt_note_content(self, user_id: int, dek: bytes,
                            plaintext: str) -> tuple:
        """åŠ å¯†ç¬”è®°å†…å®¹"""
        # 1. ç”ŸæˆéšæœºIVï¼ˆåˆå§‹åŒ–å‘é‡ï¼‰
        iv = os.urandom(12)  # GCMæ¨¡å¼æ¨è12å­—èŠ‚IV

        # 2. ä½¿ç”¨AES-256-GCMåŠ å¯†
        cipher = Cipher(
            algorithms.AES(dek),
            modes.GCM(iv),
            backend=default_backend()
        )
        encryptor = cipher.encryptor()

        # 3. åŠ å¯†æ•°æ®
        plaintext_bytes = plaintext.encode('utf-8')
        ciphertext = encryptor.update(plaintext_bytes) + encryptor.finalize()

        # 4. è·å–è®¤è¯æ ‡ç­¾ï¼ˆGCMæ¨¡å¼æä¾›ï¼‰
        tag = encryptor.tag

        # 5. è¿”å›ï¼šå¯†æ–‡ã€IVã€è®¤è¯æ ‡ç­¾
        return ciphertext + tag, base64.b64encode(iv).decode()

    def decrypt_note_content(self, user_id: int, dek: bytes,
                            ciphertext_with_tag: bytes, iv_b64: str) -> str:
        """è§£å¯†ç¬”è®°å†…å®¹"""
        # 1. è§£æIV
        iv = base64.b64decode(iv_b64)

        # 2. åˆ†ç¦»å¯†æ–‡å’Œè®¤è¯æ ‡ç­¾ï¼ˆæœ€å16å­—èŠ‚æ˜¯tagï¼‰
        ciphertext = ciphertext_with_tag[:-16]
        tag = ciphertext_with_tag[-16:]

        # 3. ä½¿ç”¨AES-256-GCMè§£å¯†
        cipher = Cipher(
            algorithms.AES(dek),
            modes.GCM(iv, tag),
            backend=default_backend()
        )
        decryptor = cipher.decryptor()

        # 4. è§£å¯†å¹¶éªŒè¯
        try:
            plaintext_bytes = decryptor.update(ciphertext) + decryptor.finalize()
            return plaintext_bytes.decode('utf-8')
        except Exception as e:
            # è§£å¯†å¤±è´¥ï¼ˆå¯èƒ½æ˜¯æ•°æ®è¢«ç¯¡æ”¹ï¼‰
            raise ValueError(f"Failed to decrypt note: {e}")
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
class NoteService:
    """ç¬”è®°æœåŠ¡"""

    def __init__(self):
        self.encryption = UserDataEncryption(kms_client)

    async def create_note(self, user_id: int, book_id: int,
                         note_content: str):
        """åˆ›å»ºåŠ å¯†ç¬”è®°"""
        # 1. è·å–ç”¨æˆ·å¯†é’¥
        dek = await self.encryption.get_user_key(user_id)

        # 2. åŠ å¯†ç¬”è®°å†…å®¹
        ciphertext, iv = self.encryption.encrypt_note_content(
            user_id, dek, note_content
        )

        # 3. å­˜å‚¨åˆ°æ•°æ®åº“
        await mysql.execute("""
            INSERT INTO user_reading_notes
            (user_id, book_id, note_content_encrypted, encryption_iv,
             encryption_key_version, created_at)
            VALUES (%s, %s, %s, %s, 1, NOW())
        """, (user_id, book_id, ciphertext, iv))

    async def get_note_content(self, note_id: int, user_id: int) -> str:
        """è¯»å–å¹¶è§£å¯†ç¬”è®°å†…å®¹"""
        # 1. ä»æ•°æ®åº“è¯»å–åŠ å¯†æ•°æ®
        note = await mysql.fetchone("""
            SELECT note_content_encrypted, encryption_iv, encryption_key_version
            FROM user_reading_notes
            WHERE id = %s AND user_id = %s
        """, (note_id, user_id))

        if not note:
            raise ValueError("Note not found")

        # 2. è·å–ç”¨æˆ·å¯†é’¥
        dek = await self.encryption.get_user_key(user_id)

        # 3. è§£å¯†å†…å®¹
        plaintext = self.encryption.decrypt_note_content(
            user_id,
            dek,
            note['note_content_encrypted'],
            note['encryption_iv']
        )

        return plaintext
```

---

### 3.3 å¯†é’¥è½®æ¢æœºåˆ¶

**ä¸ºä»€ä¹ˆéœ€è¦å¯†é’¥è½®æ¢ï¼Ÿ**
- å®šæœŸæ›´æ¢å¯†é’¥å¯é™ä½å¯†é’¥æ³„éœ²é£é™©
- ç¬¦åˆå®‰å…¨åˆè§„è¦æ±‚ï¼ˆå¦‚PCI DSSè¦æ±‚å®šæœŸè½®æ¢ï¼‰
- é™åˆ¶å•ä¸ªå¯†é’¥çš„ä½¿ç”¨èŒƒå›´

**è½®æ¢ç­–ç•¥ï¼š**
```python
class KeyRotation:
    """å¯†é’¥è½®æ¢æœåŠ¡"""

    async def rotate_user_key(self, user_id: int):
        """è½®æ¢ç”¨æˆ·å¯†é’¥ï¼ˆæ¯å­£åº¦æ‰§è¡Œä¸€æ¬¡ï¼‰"""
        # 1. è·å–æ—§å¯†é’¥
        old_dek = await encryption.get_user_key(user_id)

        # 2. ç”Ÿæˆæ–°å¯†é’¥
        new_dek = os.urandom(32)

        # 3. ä½¿ç”¨KMSåŠ å¯†æ–°å¯†é’¥
        kek_id = 'master-key-v1'
        new_dek_encrypted = await kms.encrypt(
            key_id=kek_id,
            plaintext=new_dek
        )

        # 4. æ›´æ–°å¯†é’¥ç‰ˆæœ¬
        await mysql.execute("""
            UPDATE user_encryption_keys
            SET dek_encrypted = %s,
                key_version = key_version + 1,
                rotated_at = NOW()
            WHERE user_id = %s
        """, (new_dek_encrypted, user_id))

        new_version = await mysql.fetchone("""
            SELECT key_version FROM user_encryption_keys
            WHERE user_id = %s
        """, (user_id,))

        # 5. é‡æ–°åŠ å¯†æ‰€æœ‰ç¬”è®°ï¼ˆåå°ä»»åŠ¡ï¼‰
        await self.re_encrypt_user_notes(
            user_id, old_dek, new_dek, new_version['key_version']
        )

    async def re_encrypt_user_notes(self, user_id: int, old_dek: bytes,
                                    new_dek: bytes, new_version: int):
        """ä½¿ç”¨æ–°å¯†é’¥é‡æ–°åŠ å¯†ç”¨æˆ·çš„æ‰€æœ‰ç¬”è®°"""
        # 1. æŸ¥è¯¢ç”¨æˆ·æ‰€æœ‰ç¬”è®°
        notes = await mysql.fetchall("""
            SELECT id, note_content_encrypted, encryption_iv
            FROM user_reading_notes
            WHERE user_id = %s AND encryption_key_version < %s
        """, (user_id, new_version))

        # 2. é€æ¡é‡æ–°åŠ å¯†
        for note in notes:
            # 2.1 ä½¿ç”¨æ—§å¯†é’¥è§£å¯†
            plaintext = encryption.decrypt_note_content(
                user_id,
                old_dek,
                note['note_content_encrypted'],
                note['encryption_iv']
            )

            # 2.2 ä½¿ç”¨æ–°å¯†é’¥åŠ å¯†
            new_ciphertext, new_iv = encryption.encrypt_note_content(
                user_id,
                new_dek,
                plaintext
            )

            # 2.3 æ›´æ–°æ•°æ®åº“
            await mysql.execute("""
                UPDATE user_reading_notes
                SET note_content_encrypted = %s,
                    encryption_iv = %s,
                    encryption_key_version = %s
                WHERE id = %s
            """, (new_ciphertext, new_iv, new_version, note['id']))

        logger.info(f"Rotated encryption key for user {user_id}, "
                   f"re-encrypted {len(notes)} notes")
```

---

## 4. éšç§ä¿æŠ¤åŠŸèƒ½è®¾è®¡

### 4.1 æ— ç—•é˜…è¯»æ¨¡å¼

**éœ€æ±‚åœºæ™¯ï¼š**
ç”¨æˆ·å¯èƒ½é˜…è¯»ä¸€äº›ä¸å¸Œæœ›è¢«è®°å½•çš„ä¹¦ç±ï¼ˆå¦‚ï¼šæ•æ„Ÿè¯é¢˜ã€ç§äººå†…å®¹ï¼‰ã€‚

**è¡¨ç»“æ„ä¿®æ”¹ï¼š**
```sql
-- ç”¨æˆ·åå¥½è®¾ç½®è¡¨å¢åŠ å­—æ®µ
ALTER TABLE user_preferences
ADD COLUMN incognito_mode BOOLEAN DEFAULT FALSE COMMENT 'æ— ç—•é˜…è¯»æ¨¡å¼ï¼ˆå…¨å±€ï¼‰',
ADD COLUMN history_retention_days INT DEFAULT 365 COMMENT 'å†å²è®°å½•ä¿ç•™å¤©æ•°',
ADD COLUMN auto_cleanup_enabled BOOLEAN DEFAULT FALSE COMMENT 'è‡ªåŠ¨æ¸…ç†å†å²è®°å½•';

-- é˜…è¯»è®°å½•è¡¨å¢åŠ å­—æ®µ
ALTER TABLE user_reading_records
ADD COLUMN is_incognito BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ä¸ºæ— ç—•è®°å½•',
ADD COLUMN auto_delete_at DATETIME COMMENT 'è‡ªåŠ¨åˆ é™¤æ—¶é—´';
```

**å®ç°é€»è¾‘ï¼š**

```python
class IncognitoReadingService:
    """æ— ç—•é˜…è¯»æœåŠ¡"""

    async def start_reading(self, user_id: int, book_id: int,
                           incognito: bool = False):
        """å¼€å§‹é˜…è¯»ï¼ˆæ”¯æŒæ— ç—•æ¨¡å¼ï¼‰"""
        if incognito:
            # æ— ç—•æ¨¡å¼ï¼šåªå­˜å‚¨åœ¨Redisï¼Œ24å°æ—¶åè‡ªåŠ¨è¿‡æœŸ
            redis.setex(
                f'incognito:reading:{user_id}:{book_id}',
                86400,  # 24å°æ—¶
                json.dumps({
                    'start_time': datetime.now().isoformat(),
                    'current_page': 0,
                    'progress': 0
                })
            )
        else:
            # æ™®é€šæ¨¡å¼ï¼šå­˜å‚¨åˆ°æ•°æ®åº“
            await mysql.execute("""
                INSERT INTO user_reading_records
                (user_id, book_id, is_incognito, start_reading_at)
                VALUES (%s, %s, FALSE, NOW())
            """, (user_id, book_id))

    async def get_reading_history(self, user_id: int,
                                  include_incognito: bool = False):
        """è·å–é˜…è¯»å†å²"""
        # 1. ä»MySQLè·å–æ™®é€šè®°å½•
        sql = """
            SELECT * FROM user_reading_records
            WHERE user_id = %s AND is_incognito = FALSE
        """

        history = await mysql.fetchall(sql, (user_id,))

        # 2. å¦‚æœéœ€è¦ï¼Œåˆå¹¶æ— ç—•è®°å½•ï¼ˆä»Redisï¼‰
        if include_incognito:
            pattern = f'incognito:reading:{user_id}:*'
            incognito_keys = redis.keys(pattern)

            for key in incognito_keys:
                data = json.loads(redis.get(key))
                history.append({
                    'book_id': key.split(':')[-1],
                    'is_incognito': True,
                    **data
                })

        return history

    async def auto_cleanup_old_records(self):
        """å®šæ—¶ä»»åŠ¡ï¼šæ¸…ç†è¿‡æœŸçš„é˜…è¯»è®°å½•"""
        # æŸ¥è¯¢æ‰€æœ‰å¯ç”¨è‡ªåŠ¨æ¸…ç†çš„ç”¨æˆ·
        users = await mysql.fetchall("""
            SELECT user_id, history_retention_days
            FROM user_preferences
            WHERE auto_cleanup_enabled = TRUE
        """)

        for user in users:
            retention_days = user['history_retention_days']

            # åˆ é™¤è¶…è¿‡ä¿ç•™æœŸçš„è®°å½•
            await mysql.execute("""
                UPDATE user_reading_records
                SET deleted_at = NOW()
                WHERE user_id = %s
                AND created_at < DATE_SUB(NOW(), INTERVAL %s DAY)
                AND deleted_at IS NULL
            """, (user['user_id'], retention_days))
```

---

### 4.2 æ•°æ®è„±æ•å±•ç¤º

**å‰ç«¯å±•ç¤ºæ—¶è„±æ•ï¼š**

```python
class DataMasking:
    """æ•°æ®è„±æ•å·¥å…·"""

    @staticmethod
    def mask_phone(phone: str) -> str:
        """æ‰‹æœºå·è„±æ•ï¼š138****5678"""
        if not phone or len(phone) < 11:
            return phone
        return phone[:3] + '****' + phone[-4:]

    @staticmethod
    def mask_email(email: str) -> str:
        """é‚®ç®±è„±æ•ï¼šu***@example.com"""
        if not email or '@' not in email:
            return email

        username, domain = email.split('@')

        if len(username) <= 1:
            masked_username = username
        elif len(username) <= 3:
            masked_username = username[0] + '*' + username[-1]
        else:
            masked_username = username[0] + '***' + username[-1]

        return f"{masked_username}@{domain}"

    @staticmethod
    def mask_id_number(id_number: str) -> str:
        """èº«ä»½è¯å·è„±æ•ï¼š3301***********234"""
        if not id_number or len(id_number) < 18:
            return id_number
        return id_number[:4] + '***********' + id_number[-3:]

    @staticmethod
    def mask_real_name(name: str) -> str:
        """çœŸå®å§“åè„±æ•ï¼šå¼ *ä¸‰ã€æ¬§é˜³**"""
        if not name or len(name) < 2:
            return name

        if len(name) == 2:
            return name[0] + '*'
        else:
            return name[0] + '*' * (len(name) - 2) + name[-1]
```

**APIå“åº”è‡ªåŠ¨è„±æ•ï¼š**

```python
from functools import wraps
from flask import jsonify

def mask_sensitive_fields(func):
    """è£…é¥°å™¨ï¼šè‡ªåŠ¨è„±æ•å“åº”ä¸­çš„æ•æ„Ÿå­—æ®µ"""
    @wraps(func)
    async def wrapper(*args, **kwargs):
        result = await func(*args, **kwargs)

        if isinstance(result, dict):
            if 'phone_number' in result:
                result['phone_number'] = DataMasking.mask_phone(
                    result['phone_number']
                )
            if 'email' in result:
                result['email'] = DataMasking.mask_email(result['email'])
            if 'id_number' in result:
                result['id_number'] = DataMasking.mask_id_number(
                    result['id_number']
                )
            if 'real_name' in result:
                result['real_name'] = DataMasking.mask_real_name(
                    result['real_name']
                )

        return jsonify(result)

    return wrapper

# ä½¿ç”¨ç¤ºä¾‹
@app.route('/api/users/me')
@mask_sensitive_fields
async def get_current_user():
    user = await user_service.get_user(user_id)
    return user  # è‡ªåŠ¨è„±æ•åè¿”å›
```

---

## 5. å®‰å…¨å®¡è®¡ç³»ç»Ÿ

### 5.1 æ•°æ®è®¿é—®å®¡è®¡è¡¨

**ä¸ºä»€ä¹ˆéœ€è¦å®¡è®¡ï¼Ÿ**
- è¿½è¸ªæ•æ„Ÿæ•°æ®çš„è®¿é—®è®°å½•
- å‘ç°å¼‚å¸¸è®¿é—®è¡Œä¸º
- æ»¡è¶³åˆè§„è¦æ±‚ï¼ˆGDPRã€SOXã€ç­‰ä¿ï¼‰

**è¡¨ç»“æ„è®¾è®¡ï¼š**

```sql
CREATE TABLE security_audit_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,

    -- æ“ä½œä¸»ä½“
    user_id BIGINT COMMENT 'æ“ä½œç”¨æˆ·ID',
    admin_id BIGINT COMMENT 'ç®¡ç†å‘˜IDï¼ˆå¦‚æœæ˜¯ç®¡ç†å‘˜æ“ä½œï¼‰',
    session_id VARCHAR(100) COMMENT 'ä¼šè¯ID',

    -- æ“ä½œç±»å‹
    action_type VARCHAR(50) NOT NULL COMMENT 'æ“ä½œç±»å‹',
    action_category VARCHAR(50) COMMENT 'æ“ä½œåˆ†ç±»',

    -- æ“ä½œè¯¦æƒ…
    resource_type VARCHAR(50) COMMENT 'èµ„æºç±»å‹ï¼ˆuser/note/bookç­‰ï¼‰',
    resource_id VARCHAR(100) COMMENT 'èµ„æºID',
    operation VARCHAR(50) COMMENT 'æ“ä½œï¼ˆread/write/deleteï¼‰',

    -- æ•æ„Ÿåº¦æ ‡è®°
    sensitivity_level ENUM('public', 'internal', 'confidential', 'secret')
        DEFAULT 'public' COMMENT 'æ•æ„Ÿçº§åˆ«',

    -- æ“ä½œç»“æœ
    status ENUM('success', 'failed', 'blocked') NOT NULL,
    failure_reason VARCHAR(255) COMMENT 'å¤±è´¥åŸå› ',

    -- ç¯å¢ƒä¿¡æ¯
    ip_address VARCHAR(45),
    user_agent TEXT,
    device_id VARCHAR(100),

    -- æ•°æ®å˜æ›´ï¼ˆå¯é€‰ï¼Œæ•æ„Ÿæ“ä½œè®°å½•ï¼‰
    old_value JSON COMMENT 'ä¿®æ”¹å‰çš„å€¼ï¼ˆè„±æ•ï¼‰',
    new_value JSON COMMENT 'ä¿®æ”¹åçš„å€¼ï¼ˆè„±æ•ï¼‰',

    -- æ—¶é—´æˆ³
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    INDEX idx_user_id (user_id),
    INDEX idx_action_type (action_type),
    INDEX idx_created_at (created_at),
    INDEX idx_sensitivity (sensitivity_level),
    INDEX idx_status (status)
) COMMENT='å®‰å…¨å®¡è®¡æ—¥å¿—è¡¨';

-- åˆ†åŒºå»ºè®®ï¼šæŒ‰æœˆåˆ†åŒº
ALTER TABLE security_audit_logs
PARTITION BY RANGE (TO_DAYS(created_at)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    -- è‡ªåŠ¨åˆ›å»ºæ–°åˆ†åŒº
);
```

**å®¡è®¡è®°å½•å®ç°ï¼š**

```python
class SecurityAuditor:
    """å®‰å…¨å®¡è®¡æœåŠ¡"""

    @staticmethod
    async def log_access(user_id: int, action_type: str,
                        resource_type: str, resource_id: str,
                        status: str = 'success',
                        sensitivity: str = 'public',
                        **extra_info):
        """è®°å½•æ•°æ®è®¿é—®æ—¥å¿—"""
        await mysql.execute("""
            INSERT INTO security_audit_logs
            (user_id, action_type, resource_type, resource_id,
             operation, status, sensitivity_level, ip_address,
             user_agent, device_id, created_at)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, NOW())
        """, (
            user_id,
            action_type,
            resource_type,
            resource_id,
            extra_info.get('operation', 'read'),
            status,
            sensitivity,
            extra_info.get('ip_address'),
            extra_info.get('user_agent'),
            extra_info.get('device_id')
        ))

    @staticmethod
    def audit(action_type: str, sensitivity: str = 'public'):
        """è£…é¥°å™¨ï¼šè‡ªåŠ¨è®°å½•å®¡è®¡æ—¥å¿—"""
        def decorator(func):
            @wraps(func)
            async def wrapper(*args, **kwargs):
                user_id = kwargs.get('user_id') or args[0] if args else None
                resource_id = kwargs.get('resource_id', 'unknown')

                try:
                    result = await func(*args, **kwargs)

                    # æˆåŠŸï¼šè®°å½•æ—¥å¿—
                    await SecurityAuditor.log_access(
                        user_id=user_id,
                        action_type=action_type,
                        resource_type=func.__name__,
                        resource_id=str(resource_id),
                        status='success',
                        sensitivity=sensitivity
                    )

                    return result

                except Exception as e:
                    # å¤±è´¥ï¼šè®°å½•æ—¥å¿—
                    await SecurityAuditor.log_access(
                        user_id=user_id,
                        action_type=action_type,
                        resource_type=func.__name__,
                        resource_id=str(resource_id),
                        status='failed',
                        sensitivity=sensitivity,
                        failure_reason=str(e)
                    )
                    raise

            return wrapper
        return decorator
```

**ä½¿ç”¨ç¤ºä¾‹ï¼š**

```python
class UserService:
    """ç”¨æˆ·æœåŠ¡"""

    @SecurityAuditor.audit('view_user_profile', sensitivity='internal')
    async def get_user_profile(self, user_id: int):
        """æŸ¥çœ‹ç”¨æˆ·èµ„æ–™ï¼ˆè‡ªåŠ¨å®¡è®¡ï¼‰"""
        return await mysql.fetchone("""
            SELECT * FROM users WHERE id = %s
        """, (user_id,))

    @SecurityAuditor.audit('update_sensitive_info', sensitivity='confidential')
    async def update_phone_number(self, user_id: int, new_phone: str):
        """æ›´æ–°æ‰‹æœºå·ï¼ˆè‡ªåŠ¨å®¡è®¡ï¼‰"""
        # è®°å½•æ—§å€¼
        old_user = await mysql.fetchone(
            "SELECT phone_number FROM users WHERE id = %s", (user_id,)
        )

        # æ›´æ–°
        await mysql.execute("""
            UPDATE users SET phone_number = %s WHERE id = %s
        """, (new_phone, user_id))

        # å®¡è®¡æ—¥å¿—ä¼šè®°å½•æ“ä½œè¯¦æƒ…
```

---

### 5.2 å¼‚å¸¸è®¿é—®æ£€æµ‹

**å®æ—¶æ£€æµ‹è§„åˆ™ï¼š**

```python
class AnomalyDetector:
    """å¼‚å¸¸è¡Œä¸ºæ£€æµ‹"""

    async def detect_suspicious_activity(self, user_id: int):
        """æ£€æµ‹å¯ç–‘æ´»åŠ¨"""
        # è§„åˆ™1ï¼šçŸ­æ—¶é—´å†…å¤§é‡è®¿é—®ï¼ˆå¯èƒ½æ˜¯çˆ¬è™«ï¼‰
        recent_access_count = await redis.incr(
            f'access_count:{user_id}',
            ex=60  # 1åˆ†é’Ÿå†…
        )

        if recent_access_count > 100:
            await self.alert_suspicious('high_frequency_access', user_id)
            # ä¸´æ—¶å°ç¦
            await self.block_user(user_id, duration_minutes=30)

        # è§„åˆ™2ï¼šå¼‚åœ°ç™»å½•ï¼ˆIPåœ°ç†ä½ç½®çªå˜ï¼‰
        last_ip = await redis.get(f'last_ip:{user_id}')
        current_ip = request.remote_addr

        if last_ip and last_ip != current_ip:
            last_location = await self.get_ip_location(last_ip)
            current_location = await self.get_ip_location(current_ip)

            # å¦‚æœè·ç¦»è¶…è¿‡500å…¬é‡Œï¼Œè§¦å‘é¢„è­¦
            distance = self.calculate_distance(
                last_location, current_location
            )

            if distance > 500:
                await self.alert_suspicious('remote_login', user_id, {
                    'last_location': last_location,
                    'current_location': current_location,
                    'distance_km': distance
                })

                # è¦æ±‚äºŒæ¬¡éªŒè¯
                await self.require_2fa(user_id)

        # è§„åˆ™3ï¼šæ·±å¤œå¼‚å¸¸æ´»è·ƒï¼ˆ02:00-05:00å¤§é‡æ“ä½œï¼‰
        hour = datetime.now().hour
        if 2 <= hour <= 5:
            hourly_actions = await redis.incr(
                f'night_actions:{user_id}:{datetime.now().date()}',
                ex=86400
            )

            if hourly_actions > 50:
                await self.alert_suspicious('night_activity', user_id)

    async def alert_suspicious(self, alert_type: str, user_id: int,
                              details: dict = None):
        """å‘é€å®‰å…¨é¢„è­¦"""
        await mysql.execute("""
            INSERT INTO security_alerts
            (user_id, alert_type, alert_level, details, created_at)
            VALUES (%s, %s, 'warning', %s, NOW())
        """, (user_id, alert_type, json.dumps(details)))

        # å‘é€é€šçŸ¥ç»™å®‰å…¨å›¢é˜Ÿ
        await notification_service.send_security_alert(
            user_id, alert_type, details
        )
```

---

## 6. è®¾å¤‡ä¿¡ä»»æœºåˆ¶

### 6.1 è®¾å¤‡æŒ‡çº¹ä¸ä¿¡ä»»ç®¡ç†

**è¡¨ç»“æ„ï¼š**

```sql
-- ç”¨æˆ·è®¾å¤‡è¡¨å¢åŠ ä¿¡ä»»ç›¸å…³å­—æ®µ
ALTER TABLE user_devices
ADD COLUMN trust_level ENUM('untrusted', 'trusted', 'verified')
    DEFAULT 'untrusted' COMMENT 'ä¿¡ä»»çº§åˆ«',
ADD COLUMN trusted_at DATETIME COMMENT 'æ ‡è®°ä¸ºå—ä¿¡ä»»çš„æ—¶é—´',
ADD COLUMN device_fingerprint VARCHAR(255) COMMENT 'è®¾å¤‡æŒ‡çº¹ï¼ˆå¤šå› å­ï¼‰',
ADD COLUMN risk_score DECIMAL(5, 2) DEFAULT 0.00 COMMENT 'é£é™©è¯„åˆ†ï¼ˆ0-100ï¼‰';
```

**è®¾å¤‡æŒ‡çº¹è®¡ç®—ï¼š**

```python
import hashlib
import json

class DeviceFingerprint:
    """è®¾å¤‡æŒ‡çº¹ç”Ÿæˆ"""

    @staticmethod
    def generate(device_info: dict) -> str:
        """ç”Ÿæˆè®¾å¤‡æŒ‡çº¹"""
        # ç»„åˆå¤šä¸ªè®¾å¤‡ç‰¹å¾
        features = {
            'device_type': device_info.get('device_type'),
            'os_version': device_info.get('os_version'),
            'screen_resolution': device_info.get('screen_resolution'),
            'timezone': device_info.get('timezone'),
            'language': device_info.get('language'),
            'user_agent': device_info.get('user_agent'),
            # ä¸åŒ…å«æ˜“å˜çš„ç‰¹å¾ï¼ˆå¦‚IPã€GPSï¼‰
        }

        # æ’åºååºåˆ—åŒ–ï¼ˆä¿è¯ä¸€è‡´æ€§ï¼‰
        canonical_json = json.dumps(features, sort_keys=True)

        # è®¡ç®—å“ˆå¸Œ
        fingerprint = hashlib.sha256(canonical_json.encode()).hexdigest()

        return fingerprint

    @staticmethod
    async def verify_device(user_id: int, device_id: str,
                           fingerprint: str) -> dict:
        """éªŒè¯è®¾å¤‡"""
        # æŸ¥è¯¢è®¾å¤‡è®°å½•
        device = await mysql.fetchone("""
            SELECT * FROM user_devices
            WHERE user_id = %s AND device_id = %s
        """, (user_id, device_id))

        if not device:
            # æ–°è®¾å¤‡
            return {
                'is_trusted': False,
                'is_new_device': True,
                'require_verification': True
            }

        if device['trust_level'] == 'verified':
            # å·²éªŒè¯è®¾å¤‡
            return {
                'is_trusted': True,
                'is_new_device': False,
                'require_verification': False
            }

        # æŒ‡çº¹åŒ¹é…åº¦æ£€æŸ¥
        if device['device_fingerprint'] == fingerprint:
            return {
                'is_trusted': device['trust_level'] == 'trusted',
                'is_new_device': False,
                'require_verification': False
            }
        else:
            # æŒ‡çº¹ä¸åŒ¹é…ï¼Œå¯èƒ½æ˜¯è®¾å¤‡ä¿¡æ¯å˜æ›´
            return {
                'is_trusted': False,
                'is_new_device': False,
                'require_verification': True,
                'reason': 'fingerprint_mismatch'
            }
```

**æ–°è®¾å¤‡éªŒè¯æµç¨‹ï¼š**

```python
class NewDeviceVerification:
    """æ–°è®¾å¤‡éªŒè¯æœåŠ¡"""

    async def verify_new_device(self, user_id: int, device_id: str,
                               verification_method: str = 'email'):
        """éªŒè¯æ–°è®¾å¤‡"""
        # 1. ç”ŸæˆéªŒè¯ç 
        code = self.generate_verification_code()

        # 2. å­˜å‚¨åˆ°Redisï¼ˆ10åˆ†é’Ÿæœ‰æ•ˆï¼‰
        redis.setex(
            f'device_verify:{user_id}:{device_id}',
            600,
            code
        )

        # 3. å‘é€éªŒè¯ç 
        if verification_method == 'email':
            await email_service.send_device_verification(user_id, code)
        elif verification_method == 'sms':
            await sms_service.send_device_verification(user_id, code)

    async def confirm_device(self, user_id: int, device_id: str, code: str):
        """ç¡®è®¤è®¾å¤‡éªŒè¯"""
        # 1. éªŒè¯ç æ ¡éªŒ
        stored_code = redis.get(f'device_verify:{user_id}:{device_id}')

        if not stored_code or stored_code != code:
            raise ValueError("Invalid verification code")

        # 2. æ ‡è®°è®¾å¤‡ä¸ºå·²éªŒè¯
        await mysql.execute("""
            UPDATE user_devices
            SET trust_level = 'verified',
                trusted_at = NOW()
            WHERE user_id = %s AND device_id = %s
        """, (user_id, device_id))

        # 3. æ¸…ç†éªŒè¯ç 
        redis.delete(f'device_verify:{user_id}:{device_id}')

    @staticmethod
    def generate_verification_code(length: int = 6) -> str:
        """ç”ŸæˆéªŒè¯ç """
        import random
        return ''.join([str(random.randint(0, 9)) for _ in range(length)])
```

---

## 7. æ•°æ®åˆ é™¤ä¸éšç§åˆè§„

### 7.1 GDPR "è¢«é—å¿˜æƒ" å®ç°

**ç”¨æˆ·æ•°æ®å¯¼å‡ºï¼š**

```python
class DataExportService:
    """æ•°æ®å¯¼å‡ºæœåŠ¡ï¼ˆGDPRè¦æ±‚ï¼‰"""

    async def export_user_data(self, user_id: int) -> dict:
        """å¯¼å‡ºç”¨æˆ·æ‰€æœ‰æ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰"""
        # 1. åŸºç¡€ä¿¡æ¯
        user = await mysql.fetchone(
            "SELECT * FROM users WHERE id = %s", (user_id,)
        )
        profile = await mysql.fetchone(
            "SELECT * FROM user_profiles WHERE user_id = %s", (user_id,)
        )

        # 2. é˜…è¯»è®°å½•
        reading_records = await mysql.fetchall(
            "SELECT * FROM user_reading_records WHERE user_id = %s", (user_id,)
        )

        # 3. ç¬”è®°ï¼ˆè§£å¯†åå¯¼å‡ºï¼‰
        notes = await self.export_notes(user_id)

        # 4. ä¹¦å•
        book_lists = await mysql.fetchall(
            "SELECT * FROM user_book_lists WHERE user_id = %s", (user_id,)
        )

        # 5. ç»Ÿè®¡æ•°æ®
        statistics = await mysql.fetchall(
            "SELECT * FROM user_reading_statistics WHERE user_id = %s", (user_id,)
        )

        # 6. ç™»å½•æ—¥å¿—
        login_logs = await mysql.fetchall("""
            SELECT * FROM user_login_logs
            WHERE user_id = %s
            ORDER BY created_at DESC
            LIMIT 100
        """, (user_id,))

        # ç»„è£…å¯¼å‡ºæ•°æ®
        export_data = {
            'user_info': {
                'basic': DataMasking.mask_dict(user),
                'profile': profile
            },
            'reading_data': {
                'records': reading_records,
                'notes': notes,
                'book_lists': book_lists
            },
            'statistics': statistics,
            'activity_logs': login_logs,
            'export_time': datetime.now().isoformat(),
            'export_version': '1.0'
        }

        # ç”ŸæˆJSONæ–‡ä»¶
        export_file = f'/tmp/user_data_{user_id}_{int(time.time())}.json'
        with open(export_file, 'w', encoding='utf-8') as f:
            json.dump(export_data, f, indent=2, ensure_ascii=False)

        return {
            'file_path': export_file,
            'file_size': os.path.getsize(export_file),
            'download_url': await self.upload_to_oss(export_file)
        }

    async def export_notes(self, user_id: int) -> list:
        """å¯¼å‡ºç¬”è®°ï¼ˆè§£å¯†ï¼‰"""
        notes = await mysql.fetchall("""
            SELECT id, book_id, note_type, note_content_encrypted,
                   encryption_iv, created_at
            FROM user_reading_notes
            WHERE user_id = %s
        """, (user_id,))

        # è§£å¯†ç¬”è®°å†…å®¹
        dek = await encryption.get_user_key(user_id)

        decrypted_notes = []
        for note in notes:
            plaintext = encryption.decrypt_note_content(
                user_id,
                dek,
                note['note_content_encrypted'],
                note['encryption_iv']
            )

            decrypted_notes.append({
                'note_id': note['id'],
                'book_id': note['book_id'],
                'note_type': note['note_type'],
                'content': plaintext,
                'created_at': note['created_at'].isoformat()
            })

        return decrypted_notes
```

**ç”¨æˆ·æ•°æ®åˆ é™¤ï¼ˆè´¦æˆ·æ³¨é”€ï¼‰ï¼š**

```python
class AccountDeletionService:
    """è´¦æˆ·æ³¨é”€æœåŠ¡"""

    async def delete_user_account(self, user_id: int,
                                  reason: str = None):
        """åˆ é™¤ç”¨æˆ·è´¦æˆ·ï¼ˆç¬¦åˆGDPRï¼‰"""
        # 1. æ ‡è®°è´¦æˆ·ä¸ºæ³¨é”€çŠ¶æ€
        await mysql.execute("""
            UPDATE users
            SET status = 3, -- æ³¨é”€çŠ¶æ€
                deleted_at = NOW()
            WHERE id = %s
        """, (user_id,))

        # 2. åŒ¿ååŒ–æ•æ„Ÿæ•°æ®ï¼ˆè€Œéç›´æ¥åˆ é™¤ï¼‰
        await self.anonymize_user_data(user_id)

        # 3. åˆ é™¤åŠ å¯†å¯†é’¥ï¼ˆç¬”è®°å°†æ— æ³•è§£å¯†ï¼‰
        await mysql.execute("""
            DELETE FROM user_encryption_keys WHERE user_id = %s
        """, (user_id,))

        # 4. åˆ é™¤Redisç¼“å­˜
        redis.delete(f'user:dek:{user_id}')
        redis.delete(f'reading:session:{user_id}')

        # 5. è®°å½•å®¡è®¡æ—¥å¿—
        await SecurityAuditor.log_access(
            user_id=user_id,
            action_type='delete_account',
            resource_type='user',
            resource_id=str(user_id),
            status='success',
            sensitivity='secret',
            operation='delete'
        )

        # 6. å‘é€ç¡®è®¤é‚®ä»¶
        await email_service.send_account_deletion_confirmation(user_id)

    async def anonymize_user_data(self, user_id: int):
        """åŒ¿ååŒ–ç”¨æˆ·æ•°æ®"""
        anonymous_id = f'deleted_user_{int(time.time())}'

        # åŒ¿ååŒ–åŸºç¡€ä¿¡æ¯
        await mysql.execute("""
            UPDATE users
            SET username = %s,
                phone_number = NULL,
                email = NULL,
                password_hash = 'DELETED'
            WHERE id = %s
        """, (anonymous_id, user_id))

        # åŒ¿ååŒ–è¯¦ç»†èµ„æ–™
        await mysql.execute("""
            UPDATE user_profiles
            SET nickname = %s,
                real_name = NULL,
                avatar_url = NULL,
                bio = 'This account has been deleted'
            WHERE user_id = %s
        """, (anonymous_id, user_id))

        # ä¿ç•™ç»Ÿè®¡æ•°æ®ï¼ˆç”¨äºæ•°æ®åˆ†æï¼Œä½†æ— æ³•å…³è”åˆ°ä¸ªäººï¼‰
        # é˜…è¯»è®°å½•ã€ç¬”è®°ç­‰ä¿ç•™ä½†æ— æ³•è®¿é—®
```

---

## 8. æ€»ç»“ä¸å®‰å…¨æ£€æŸ¥æ¸…å•

### 8.1 å®‰å…¨å®æ–½ä¼˜å…ˆçº§

| å®‰å…¨æªæ–½ | ä¼˜å…ˆçº§ | å®æ–½å¤æ‚åº¦ | é¢„æœŸè€—æ—¶ |
|---------|-------|-----------|---------|
| ç¬”è®°å†…å®¹åŠ å¯† | ğŸ”´ P0 | é«˜ | 3-4å‘¨ |
| æ— ç—•é˜…è¯»æ¨¡å¼ | ğŸŸ¡ P1 | ä½ | 1å‘¨ |
| æ•°æ®è„±æ•å±•ç¤º | ğŸŸ¡ P1 | ä½ | 3å¤© |
| å®‰å…¨å®¡è®¡ç³»ç»Ÿ | ğŸŸ¡ P1 | ä¸­ | 2å‘¨ |
| è®¾å¤‡ä¿¡ä»»æœºåˆ¶ | ğŸŸ¢ P2 | ä¸­ | 2å‘¨ |
| å¼‚å¸¸æ£€æµ‹å‘Šè­¦ | ğŸŸ¢ P2 | ä¸­ | 2å‘¨ |
| GDPRåˆè§„åŠŸèƒ½ | ğŸŸ¡ P1 | ä¸­ | 2å‘¨ |

### 8.2 å®‰å…¨æ£€æŸ¥æ¸…å•

**æ•°æ®ä¿æŠ¤ï¼š**
- [ ] å¯†ç ä½¿ç”¨bcrypt/argon2åŠ å¯†
- [ ] æ•æ„Ÿå­—æ®µï¼ˆæ‰‹æœºå·ã€èº«ä»½è¯ï¼‰åŠ å¯†å­˜å‚¨
- [ ] ç¬”è®°å†…å®¹åŠ å¯†
- [ ] å®šæœŸå¯†é’¥è½®æ¢æœºåˆ¶
- [ ] æ•°æ®ä¼ è¾“ä½¿ç”¨HTTPS/TLS 1.3

**è®¿é—®æ§åˆ¶ï¼š**
- [ ] åŸºäºè§’è‰²çš„æƒé™æ§åˆ¶ï¼ˆRBACï¼‰
- [ ] æœ€å°æƒé™åŸåˆ™
- [ ] ä¼šè¯è¶…æ—¶è®¾ç½®ï¼ˆ2å°æ—¶ï¼‰
- [ ] è®¾å¤‡ä¿¡ä»»éªŒè¯
- [ ] å¼‚åœ°ç™»å½•äºŒæ¬¡éªŒè¯

**å®¡è®¡ä¸ç›‘æ§ï¼š**
- [ ] æ•æ„Ÿæ“ä½œå®¡è®¡æ—¥å¿—
- [ ] å¼‚å¸¸è®¿é—®æ£€æµ‹
- [ ] å®æ—¶å®‰å…¨å‘Šè­¦
- [ ] æ—¥å¿—ä¿ç•™è‡³å°‘180å¤©

**éšç§åˆè§„ï¼š**
- [ ] ç”¨æˆ·æ•°æ®å¯¼å‡ºåŠŸèƒ½
- [ ] è´¦æˆ·æ³¨é”€ä¸æ•°æ®åŒ¿ååŒ–
- [ ] éšç§æ”¿ç­–ä¸ç”¨æˆ·åŒæ„
- [ ] æ•°æ®ä¿ç•™æœŸé™ç®¡ç†

**åº”æ€¥å“åº”ï¼š**
- [ ] æ•°æ®æ³„éœ²å“åº”é¢„æ¡ˆ
- [ ] å®‰å…¨äº‹ä»¶å‡çº§æµç¨‹
- [ ] å®šæœŸå®‰å…¨æ¼”ç»ƒ
- [ ] æ¼æ´ä¿®å¤SLAï¼ˆ24å°æ—¶å†…ï¼‰

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2025-10-14
**ä¸‹ä¸€æ­¥**: æŸ¥çœ‹ã€Š03-ç”¨æˆ·ä½“éªŒä¼˜åŒ–æ–‡æ¡£ã€‹
