# å¾®ä¹¦åŒ…ç”¨æˆ·æ¨¡å—è¯¦ç»†éœ€æ±‚æ–‡æ¡£ï¼ˆUltraThinkæ·±åº¦åˆ†æç‰ˆï¼‰

> **æ–‡æ¡£ç‰ˆæœ¬**: V2.0ï¼ˆUltraThinkæ·±åº¦åˆ†æç‰ˆï¼‰
> **åˆ›å»ºæ—¶é—´**: 2025-10-15
> **åˆ†ææ¨¡å¼**: UltraThink å…¨æ–¹ä½éœ€æ±‚æ•´ç†
> **é€‚ç”¨èŒƒå›´**: å¾®ä¹¦åŒ…APPç”¨æˆ·æ¨¡å—ï¼ˆç§»åŠ¨ç«¯ + Webç®¡ç†ç«¯ï¼‰
> **æ ¸å¿ƒç›®æ ‡**: æä¾›å®Œæ•´ã€å¯è½åœ°ã€é«˜è´¨é‡çš„ç”¨æˆ·æ¨¡å—å®æ–½æ–¹æ¡ˆ

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è¿°ä¸å®šä½](#1-æ¦‚è¿°ä¸å®šä½)
2. [æ ¸å¿ƒä»·å€¼ä¸»å¼ ](#2-æ ¸å¿ƒä»·å€¼ä¸»å¼ )
3. [ç”¨æˆ·è§’è‰²ä¸æƒé™ä½“ç³»](#3-ç”¨æˆ·è§’è‰²ä¸æƒé™ä½“ç³»)
4. [åŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡](#4-åŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡)
5. [æ•°æ®åº“æ¶æ„è®¾è®¡](#5-æ•°æ®åº“æ¶æ„è®¾è®¡)
6. [ä¸šåŠ¡æµç¨‹ä¸äº¤äº’](#6-ä¸šåŠ¡æµç¨‹ä¸äº¤äº’)
7. [å®‰å…¨ä¸éšç§ä¿æŠ¤](#7-å®‰å…¨ä¸éšç§ä¿æŠ¤)
8. [è·¨è®¾å¤‡åŒæ­¥æ–¹æ¡ˆ](#8-è·¨è®¾å¤‡åŒæ­¥æ–¹æ¡ˆ)
9. [æˆå°±ä¸æ¿€åŠ±ä½“ç³»](#9-æˆå°±ä¸æ¿€åŠ±ä½“ç³»)
10. [ç¤¾äº¤äº’åŠ¨è®¾è®¡](#10-ç¤¾äº¤äº’åŠ¨è®¾è®¡)
11. [APIæ¥å£è®¾è®¡](#11-apiæ¥å£è®¾è®¡)
12. [æ€§èƒ½ä¸æ‰©å±•æ€§](#12-æ€§èƒ½ä¸æ‰©å±•æ€§)
13. [æµ‹è¯•éªŒæ”¶æ ‡å‡†](#13-æµ‹è¯•éªŒæ”¶æ ‡å‡†)
14. [å®æ–½è·¯çº¿å›¾](#14-å®æ–½è·¯çº¿å›¾)

---

## 1. æ¦‚è¿°ä¸å®šä½

### 1.1 ç”¨æˆ·æ¨¡å—åœ¨æ•´ä½“æ¶æ„ä¸­çš„ä½ç½®

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        å¾®ä¹¦åŒ…åº”ç”¨ç³»ç»Ÿ                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ç”¨æˆ·æ¨¡å—      â”‚  â”‚  ä¹¦ç±æ¨¡å—      â”‚  â”‚  é˜…è¯»æ¨¡å—      â”‚   â”‚
â”‚  â”‚  (æœ¬æ–‡æ¡£)      â”‚  â”‚                â”‚  â”‚                â”‚   â”‚
â”‚  â”‚                â”‚  â”‚  - å®ä½“ä¹¦      â”‚  â”‚  - ç”µå­ä¹¦      â”‚   â”‚
â”‚  â”‚  - æ³¨å†Œç™»å½•    â”‚  â”‚  - ç”µå­ä¹¦      â”‚  â”‚  - é˜…è¯»è®°å½•    â”‚   â”‚
â”‚  â”‚  - ä¸ªäººèµ„æ–™    â”‚  â”‚  - ä¹¦å•        â”‚  â”‚  - ç¬”è®°ä¹¦ç­¾    â”‚   â”‚
â”‚  â”‚  - æˆå°±ä½“ç³»    â”‚  â”‚  - å€Ÿé˜…ç®¡ç†    â”‚  â”‚  - è¿›åº¦åŒæ­¥    â”‚   â”‚
â”‚  â”‚  - ç¤¾äº¤å…³ç³»    â”‚  â”‚                â”‚  â”‚                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                   â”‚                   â”‚           â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚                               â”‚                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚              å…¬å…±æœåŠ¡å±‚ (è®¤è¯/æƒé™/å­˜å‚¨/é€šçŸ¥)              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.2 æ ¸å¿ƒè®¾è®¡åŸåˆ™

1. **å®‰å…¨ç¬¬ä¸€**: ç”¨æˆ·æ•°æ®ä¿æŠ¤ã€éšç§å®‰å…¨ã€é˜²åˆ·é˜²æ”»å‡»
2. **ä½“éªŒä¼˜å…ˆ**: æµç•…æ³¨å†Œã€å¿«é€Ÿç™»å½•ã€è·¨è®¾å¤‡æ— ç¼åŒæ­¥
3. **æ¿€åŠ±å¯¼å‘**: æˆå°±ä½“ç³»ã€ç­‰çº§å‹‹ç« ã€ç¤¾äº¤äº’åŠ¨é©±åŠ¨ç”¨æˆ·æ´»è·ƒ
4. **æ‰©å±•æ€§å¼º**: æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•ã€å¤šè®¾å¤‡ç®¡ç†ã€æƒé™ç»†ç²’åº¦æ§åˆ¶
5. **æ•°æ®é©±åŠ¨**: å®Œæ•´çš„ç”¨æˆ·è¡Œä¸ºåˆ†æã€é˜…è¯»ä¹ æƒ¯è¿½è¸ª

---

## 2. æ ¸å¿ƒä»·å€¼ä¸»å¼ 

### 2.1 å¯¹ç”¨æˆ·çš„ä»·å€¼

| ç”¨æˆ·è§’è‰² | æ ¸å¿ƒéœ€æ±‚ | è§£å†³æ–¹æ¡ˆ | ä»·å€¼ç‚¹ |
|---------|---------|---------|--------|
| é˜…è¯»çˆ±å¥½è€… | ç®¡ç†ä¸ªäººè—ä¹¦ã€è®°å½•é˜…è¯»è¿›åº¦ | å¤šè®¾å¤‡åŒæ­¥ã€äº‘ç«¯å­˜å‚¨ | éšæ—¶éšåœ°è®¿é—®ä¹¦æ¶ |
| çŸ¥è¯†å·¥ä½œè€… | åšç¬”è®°ã€æ•´ç†çŸ¥è¯† | ç¬”è®°é«˜äº®ã€AIé—®ç­” | é«˜æ•ˆçŸ¥è¯†ç®¡ç† |
| ç¤¾äº¤å‹è¯»è€… | åˆ†äº«ä¹¦è¯„ã€äº¤æµå¿ƒå¾— | ç¤¾åŒºäº’åŠ¨ã€ä¹¦å•åˆ†äº« | æ‰¾åˆ°åŒå¥½ã€æ‰©å¤§å½±å“åŠ› |
| ç›®æ ‡å¯¼å‘å‹ | å®Œæˆé˜…è¯»è®¡åˆ’ã€è·å¾—æˆå°± | ç›®æ ‡è®¾å®šã€æˆå°±å¾½ç«  | æŒç»­æ¿€åŠ±ã€å¯è§†åŒ–æˆé•¿ |

### 2.2 å¯¹ä¸šåŠ¡çš„ä»·å€¼

- **ç”¨æˆ·å¢é•¿**: ä½é—¨æ§›æ³¨å†Œã€ç¤¾äº¤è£‚å˜
- **ç”¨æˆ·ç•™å­˜**: æˆå°±ä½“ç³»ã€ç¤¾äº¤å…³ç³»ã€è·¨è®¾å¤‡ç²˜æ€§
- **å•†ä¸šå˜ç°**: ä¼šå‘˜ä½“ç³»ã€å¢å€¼æœåŠ¡ã€æ•°æ®èµ„äº§
- **æ•°æ®ä»·å€¼**: é˜…è¯»åå¥½ã€ç”¨æˆ·ç”»åƒã€æ¨èä¼˜åŒ–

---

## 3. ç”¨æˆ·è§’è‰²ä¸æƒé™ä½“ç³»

### 3.1 è§’è‰²å®šä¹‰

```sql
-- ç”¨æˆ·è§’è‰²æšä¸¾
ENUM role:
  - 'user'        -- æ™®é€šç”¨æˆ·
  - 'vip'         -- VIPä¼šå‘˜
  - 'admin'       -- ç®¡ç†å‘˜
  - 'super_admin' -- è¶…çº§ç®¡ç†å‘˜
```

### 3.2 æƒé™çŸ©é˜µ

| åŠŸèƒ½/æ“ä½œ | æ™®é€šç”¨æˆ· | VIPç”¨æˆ· | ç®¡ç†å‘˜ | è¶…çº§ç®¡ç†å‘˜ |
|----------|---------|---------|--------|-----------|
| æ³¨å†Œç™»å½• | âœ… | âœ… | âœ… | âœ… |
| ä¸ªäººèµ„æ–™ç¼–è¾‘ | âœ… | âœ… | âœ… | âœ… |
| ä¹¦ç±å½•å…¥ï¼ˆæ‰«ç /æ‰‹åŠ¨ï¼‰ | âœ… é™åˆ¶50æœ¬/æœˆ | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ |
| ç”µå­ä¹¦ä¸Šä¼  | âœ… é™åˆ¶5æœ¬/æœˆ | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ |
| åˆ›å»ºä¹¦å• | âœ… æœ€å¤š10ä¸ª | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ |
| åˆ›å»ºç¾¤ç»„ | âœ… æœ€å¤š3ä¸ª | âœ… æœ€å¤š20ä¸ª | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ |
| ç¦»çº¿ä¸‹è½½ | âœ… æœ€å¤š5æœ¬ | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ |
| AIé—®ç­” | âœ… 10æ¬¡/å¤© | âœ… 100æ¬¡/å¤© | âœ… æ— é™åˆ¶ | âœ… æ— é™åˆ¶ |
| å‘å¸ƒä¹¦è¯„ | âœ… | âœ… | âœ… | âœ… |
| æŸ¥çœ‹ä»–äººç§è— | âŒ | âŒ | âŒ | âŒ |
| åˆ é™¤ä»–äººè¯„è®º | âŒ | âŒ | âœ… | âœ… |
| ç®¡ç†è½®æ’­å›¾ | âŒ | âŒ | âœ… | âœ… |
| ç”¨æˆ·å°ç¦ | âŒ | âŒ | âœ… | âœ… |
| ç³»ç»Ÿé…ç½® | âŒ | âŒ | âŒ | âœ… |

### 3.3 ä¼šå‘˜ç­‰çº§ä½“ç³»

```
Level 0: æ™®é€šä¼šå‘˜ (0-99 XP)
  - åŸºç¡€åŠŸèƒ½
  - å¹¿å‘Šæ”¯æŒ

Level 1: é“œç‰Œä¼šå‘˜ (100-299 XP)
  - åŸºç¡€åŠŸèƒ½
  - æ— å¹¿å‘Š
  - 9æŠ˜è´­ä¹¦

Level 2: é“¶ç‰Œä¼šå‘˜ (300-699 XP)
  - Level 1æƒç›Š
  - ä¼˜å…ˆå®¢æœ
  - 8æŠ˜è´­ä¹¦
  - é«˜çº§ç»Ÿè®¡æŠ¥è¡¨

Level 3: é‡‘ç‰Œä¼šå‘˜ (700-1499 XP)
  - Level 2æƒç›Š
  - ä¸“å±æ´»åŠ¨
  - 7æŠ˜è´­ä¹¦
  - AIé«˜çº§åŠŸèƒ½

Level 4: é’»çŸ³ä¼šå‘˜ (1500+ XP)
  - å…¨éƒ¨æƒç›Š
  - å®šåˆ¶æœåŠ¡
  - 6æŠ˜è´­ä¹¦
  - ä¼˜å…ˆä½“éªŒæ–°åŠŸèƒ½
```

---

## 4. åŠŸèƒ½æ¨¡å—è¯¦ç»†è®¾è®¡

### 4.1 æ³¨å†Œä¸ç™»å½•

#### 4.1.1 æ³¨å†Œæ–¹å¼

**æ–¹å¼ä¸€: æ‰‹æœºå· + éªŒè¯ç æ³¨å†Œ**

```
ç”¨æˆ·æ“ä½œæµç¨‹:
1. è¾“å…¥æ‰‹æœºå·
2. ç‚¹å‡»"è·å–éªŒè¯ç "
3. è¾“å…¥éªŒè¯ç 
4. è‡ªåŠ¨å®Œæˆæ³¨å†Œå¹¶ç™»å½•
5. (å¯é€‰) å®Œå–„ä¸ªäººä¿¡æ¯
```

**éªŒè¯ç è§„åˆ™:**
- 6ä½æ•°å­—
- æœ‰æ•ˆæœŸ: 5åˆ†é’Ÿ
- å•ä¸ªæ‰‹æœºå·: 1æ¬¡/60ç§’, 5æ¬¡/å¤©
- å•ä¸ªIP: 10æ¬¡/å°æ—¶, 50æ¬¡/å¤©
- éªŒè¯ç å†…å®¹æ¨¡æ¿: "ã€å¾®ä¹¦åŒ…ã€‘æ‚¨çš„éªŒè¯ç æ˜¯{code},5åˆ†é’Ÿå†…æœ‰æ•ˆ,è¯·å‹¿æ³„éœ²"

**æ–¹å¼äºŒ: æ‰‹æœºå· + å¯†ç æ³¨å†Œ**

```
ç”¨æˆ·æ“ä½œæµç¨‹:
1. è¾“å…¥æ‰‹æœºå·
2. è®¾ç½®å¯†ç  (6-16ä½,å«å­—æ¯å’Œæ•°å­—)
3. ç‚¹å‡»"æ³¨å†Œ"
4. è‡ªåŠ¨å®Œæˆæ³¨å†Œå¹¶ç™»å½•
```

**å¯†ç è§„åˆ™:**
- é•¿åº¦: 6-16ä½
- å¿…é¡»åŒ…å«: å­—æ¯ + æ•°å­—
- å¯é€‰åŒ…å«: ç‰¹æ®Šå­—ç¬¦(!@#$%^&*)
- ä¸èƒ½æ˜¯çº¯æ•°å­—æˆ–çº¯å­—æ¯
- ä¸èƒ½åŒ…å«æ‰‹æœºå·
- å®æ—¶å¯†ç å¼ºåº¦æç¤º (å¼±/ä¸­/å¼º)

**æ–¹å¼ä¸‰: ç¬¬ä¸‰æ–¹å¿«æ·ç™»å½•**

æ”¯æŒå¹³å°:
- å¾®ä¿¡
- QQ
- Apple ID (iOS)
- æ”¯ä»˜å®

æµç¨‹:
```
1. ç‚¹å‡»ç¬¬ä¸‰æ–¹ç™»å½•æŒ‰é’®
2. è·³è½¬ç¬¬ä¸‰æ–¹æˆæƒé¡µ
3. ç”¨æˆ·æˆæƒ
4. è·å–ç”¨æˆ·ä¿¡æ¯ (openid, unionid, æ˜µç§°, å¤´åƒ)
5. æ£€æŸ¥æ˜¯å¦å·²ç»‘å®šè´¦å·
   - å·²ç»‘å®š: ç›´æ¥ç™»å½•
   - æœªç»‘å®š: åˆ›å»ºæ–°è´¦å·æˆ–ç»‘å®šç°æœ‰æ‰‹æœºå·
```

#### 4.1.2 ç™»å½•æ–¹å¼

**æ–¹å¼ä¸€: æ‰‹æœºå· + éªŒè¯ç ç™»å½•**
- é€‚ç”¨åœºæ™¯: å¿˜è®°å¯†ç ã€å¿«æ·ç™»å½•
- å®‰å…¨æ€§: é«˜

**æ–¹å¼äºŒ: æ‰‹æœºå· + å¯†ç ç™»å½•**
- é€‚ç”¨åœºæ™¯: å¸¸è§„ç™»å½•
- è®°ä½å¯†ç åŠŸèƒ½ (7å¤©å…ç™»å½•)

**æ–¹å¼ä¸‰: ç¬¬ä¸‰æ–¹ç™»å½•**
- ä¸€é”®ç™»å½•,æ— éœ€è¾“å…¥æ‰‹æœºå·å¯†ç 

#### 4.1.3 å¼‚å¸¸å¤„ç†

| å¼‚å¸¸åœºæ™¯ | é”™è¯¯æç¤º | å¤„ç†æ–¹å¼ |
|---------|---------|---------|
| æ‰‹æœºå·å·²æ³¨å†Œ | "è¯¥æ‰‹æœºå·å·²ç»‘å®šè´¦å·,å¯ç›´æ¥ç™»å½•" | è·³è½¬ç™»å½•é¡µ |
| éªŒè¯ç é”™è¯¯ | "éªŒè¯ç æ— æ•ˆæˆ–å·²è¿‡æœŸ" | é‡æ–°è·å– |
| éªŒè¯ç å‘é€è¿‡é¢‘ç¹ | "æ“ä½œè¿‡äºé¢‘ç¹,è¯·60ç§’åå†è¯•" | å€’è®¡æ—¶ç­‰å¾… |
| å¯†ç æ ¼å¼é”™è¯¯ | "å¯†ç éœ€åŒ…å«æ•°å­—å’Œå­—æ¯,é•¿åº¦6-16ä½" | å®æ—¶æç¤º |
| å¯†ç é”™è¯¯ | "å¯†ç é”™è¯¯,è¿˜å¯å°è¯•{n}æ¬¡" | è®°å½•å¤±è´¥æ¬¡æ•° |
| è¿ç»­å¯†ç é”™è¯¯5æ¬¡ | "è´¦æˆ·å·²é”å®š30åˆ†é’Ÿ,è¯·ç¨åå†è¯•" | é”å®šè´¦æˆ· |
| è´¦æˆ·å·²å†»ç»“ | "è´¦æˆ·å·²è¢«å†»ç»“,è¯·è”ç³»å®¢æœ" | æ˜¾ç¤ºå®¢æœè”ç³»æ–¹å¼ |
| ç½‘ç»œå¼‚å¸¸ | "ç½‘ç»œè¿æ¥å¤±è´¥,è¯·æ£€æŸ¥ç½‘ç»œ" | é‡è¯•æŒ‰é’® |

#### 4.1.4 é¦–æ¬¡ç™»å½•å¼•å¯¼

```
é¦–æ¬¡ç™»å½•å¼¹çª—:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    å®Œå–„ä¸ªäººä¿¡æ¯ (å¯è·³è¿‡)     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                            â”‚
â”‚   [å¤´åƒä¸Šä¼ åŒºåŸŸ]            â”‚
â”‚   ç‚¹å‡»ä¸Šä¼ æˆ–æ‹ç…§            â”‚
â”‚                            â”‚
â”‚   æ˜µç§°: [_____________]    â”‚
â”‚                            â”‚
â”‚   æ€§åˆ«: â—‹ ç”·  â—‹ å¥³  â—‹ ä¿å¯†  â”‚
â”‚                            â”‚
â”‚   ä¸ªæ€§ç­¾å:                 â”‚
â”‚   [____________________]   â”‚
â”‚   [____________________]   â”‚
â”‚                            â”‚
â”‚   [ç¨åå†è¯´]    [å®Œæˆ]      â”‚
â”‚                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¤´åƒä¸Šä¼ åŠŸèƒ½:**
- æ”¯æŒæ ¼å¼: JPG, PNG, GIF
- å¤§å°é™åˆ¶: â‰¤ 5MB
- è£å‰ªæ¯”ä¾‹: 1:1æ­£æ–¹å½¢
- å®æ—¶é¢„è§ˆ
- æ”¯æŒç›¸æœºæ‹ç…§å’Œç›¸å†Œé€‰æ‹©

### 4.2 ä¸ªäººä¿¡æ¯ç®¡ç†

#### 4.2.1 ä¸ªäººèµ„æ–™

**åŸºç¡€ä¿¡æ¯:**
- ç”¨æˆ·å (ä¸å¯ä¿®æ”¹,å”¯ä¸€æ ‡è¯†)
- æ˜µç§° (å¯ä¿®æ”¹,2-20å­—ç¬¦)
- å¤´åƒ (å¯ä¿®æ”¹)
- æ€§åˆ« (ç”·/å¥³/ä¿å¯†)
- ç”Ÿæ—¥ (å¯é€‰)
- åœ°ç†ä½ç½® (å›½å®¶/çœä»½/åŸå¸‚)
- ä¸ªæ€§ç­¾å (æœ€å¤š100å­—)

**ç¤¾äº¤ä¿¡æ¯ (å¯é€‰):**
- å¾®ä¿¡å·
- QQå·
- å¾®åšè´¦å·

**ç»Ÿè®¡æ•°æ® (åªè¯»):**
- ç²‰ä¸æ•°
- å…³æ³¨æ•°
- å·²è¯»å›¾ä¹¦æ•°
- ç´¯è®¡é˜…è¯»å¤©æ•°
- ç´¯è®¡é˜…è¯»æ—¶é•¿
- å‘è¡¨ä¹¦è¯„æ•°
- åˆ›å»ºä¹¦å•æ•°
- é˜…è¯»ç§¯åˆ†
- è´¦æˆ·ä½™é¢

#### 4.2.2 è´¦å·ä¸å®‰å…¨

**æ‰‹æœºå·ç®¡ç†:**
- æŸ¥çœ‹å·²ç»‘å®šæ‰‹æœºå· (è„±æ•æ˜¾ç¤º: 138****5678)
- æ›´æ¢æ‰‹æœºå· (éœ€éªŒè¯åŸæ‰‹æœºå·)
- ç»‘å®š/è§£ç»‘ç¬¬ä¸‰æ–¹è´¦å·

**å¯†ç ç®¡ç†:**
- ä¿®æ”¹å¯†ç  (éœ€éªŒè¯åŸå¯†ç æˆ–éªŒè¯ç )
- å¿˜è®°å¯†ç  (é€šè¿‡æ‰‹æœºéªŒè¯ç é‡ç½®)

**è®¾å¤‡ç®¡ç†:**
- æŸ¥çœ‹å½“å‰ç™»å½•è®¾å¤‡åˆ—è¡¨
- è¿œç¨‹ç™»å‡ºå…¶ä»–è®¾å¤‡
- æ ‡è®°å—ä¿¡ä»»è®¾å¤‡

**ç™»å½•å†å²:**
- æœ€è¿‘30å¤©ç™»å½•è®°å½•
- æ˜¾ç¤º: æ—¶é—´ã€è®¾å¤‡ã€IPã€åœ°ç†ä½ç½®
- å¼‚å¸¸ç™»å½•æé†’

#### 4.2.3 éšç§è®¾ç½®

```
éšç§æ§åˆ¶é¢æ¿:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ä¸ªäººèµ„æ–™å¯è§æ€§                      â”‚
â”‚  â˜‘ å…è®¸å…¶ä»–ç”¨æˆ·æŸ¥çœ‹æˆ‘çš„ä¸ªäººèµ„æ–™       â”‚
â”‚  â˜‘ å…è®¸å…¶ä»–ç”¨æˆ·åœ¨æœç´¢ä¸­æ‰¾åˆ°æˆ‘         â”‚
â”‚                                    â”‚
â”‚  åŠ¨æ€ä¸å†…å®¹                          â”‚
â”‚  â˜‘ å…è®¸å…¶ä»–ç”¨æˆ·æŸ¥çœ‹æˆ‘çš„é˜…è¯»åŠ¨æ€       â”‚
â”‚  â˜ å…è®¸å…¶ä»–ç”¨æˆ·æŸ¥çœ‹æˆ‘çš„ä¹¦æ¶          â”‚
â”‚  â˜‘ å…è®¸å…¶ä»–ç”¨æˆ·æŸ¥çœ‹æˆ‘çš„ä¹¦å•          â”‚
â”‚                                    â”‚
â”‚  ç¤¾äº¤äº’åŠ¨                           â”‚
â”‚  â˜‘ å…è®¸ä»»ä½•äººå‘æˆ‘å‘é€å¥½å‹è¯·æ±‚         â”‚
â”‚  â˜ ä»…å…è®¸å¥½å‹æŸ¥çœ‹æˆ‘çš„ä¹¦è¯„            â”‚
â”‚  â˜‘ å…è®¸ä»–äºº@æˆ‘                       â”‚
â”‚                                    â”‚
â”‚  æ•°æ®ä¸æ¨è                          â”‚
â”‚  â˜‘ å…è®¸åŸºäºæˆ‘çš„é˜…è¯»ä¹ æƒ¯æ¨èå†…å®¹       â”‚
â”‚  â˜ å…è®¸åœ¨æ¨èä¸­å±•ç¤ºæˆ‘çš„æ´»åŠ¨          â”‚
â”‚                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 4.2.4 åå¥½è®¾ç½®

**é˜…è¯»åå¥½:**
- å­—ä½“å¤§å° (12-30px, é»˜è®¤16px)
- å­—ä½“æ ·å¼ (ç³»ç»Ÿé»˜è®¤/å®‹ä½“/é»‘ä½“/æ¥·ä½“)
- è¡Œé—´è· (1.0-2.5, é»˜è®¤1.5)
- ç¿»é¡µæ¨¡å¼ (æ»šåŠ¨/ä»¿çœŸç¿»é¡µ/æ»‘åŠ¨)
- é˜…è¯»èƒŒæ™¯ (ç™½è‰²/æŠ¤çœ¼ç»¿/å¤œé—´æ¨¡å¼)
- è‡ªåŠ¨ä¿å­˜ä¹¦ç­¾ (å¼€/å…³)
- å±å¹•å¸¸äº® (å¼€/å…³)

**é€šçŸ¥è®¾ç½®:**
- ç³»ç»Ÿé€šçŸ¥ (å¼€/å…³)
- é‚®ä»¶é€šçŸ¥ (å¼€/å…³)
- çŸ­ä¿¡é€šçŸ¥ (å¼€/å…³)
- æ¨é€é€šçŸ¥ (å¼€/å…³)
- æ¶ˆæ¯å…æ‰“æ‰°æ—¶æ®µè®¾ç½®

**è¯­è¨€ä¸åœ°åŒº:**
- è¯­è¨€åå¥½ (ä¸­æ–‡ç®€ä½“/ä¸­æ–‡ç¹ä½“/English)
- æ—¶åŒºè®¾ç½® (è‡ªåŠ¨æ£€æµ‹/æ‰‹åŠ¨é€‰æ‹©)

### 4.3 æˆå°±ä¸ç­‰çº§ä½“ç³»

#### 4.3.1 ç»éªŒå€¼(XP)è·å–è§„åˆ™

| è¡Œä¸º | è·å¾—XP | é¢‘ç‡é™åˆ¶ | è¯´æ˜ |
|-----|--------|---------|------|
| å®Œæˆæ³¨å†Œ | +20 | ä¸€æ¬¡æ€§ | æ–°ç”¨æˆ·å¥–åŠ± |
| å®Œå–„ä¸ªäººèµ„æ–™ | +10 | ä¸€æ¬¡æ€§ | ä¸Šä¼ å¤´åƒ+å¡«å†™æ˜µç§° |
| å®Œæˆä¸€æœ¬ä¹¦ | +50 | æ— é™åˆ¶ | é˜…è¯»è¿›åº¦è¾¾100% |
| å‘è¡¨ä¹¦è¯„ (â‰¥50å­—) | +10 | 10æ¬¡/å¤© | æœ‰æ•ˆå†…å®¹ |
| ä¹¦è¯„è¢«ç‚¹èµ | +2 | æ— é™åˆ¶ | æ¯ä¸ªèµ |
| åˆ›å»ºä¹¦å• | +15 | 5æ¬¡/å¤© | è‡³å°‘åŒ…å«5æœ¬ä¹¦ |
| ä¹¦å•è¢«æ”¶è— | +5 | æ— é™åˆ¶ | æ¯æ¬¡æ”¶è— |
| è¿ç»­é˜…è¯»7å¤© | +30 | æ— é™åˆ¶ | æ¯ä¸ªå‘¨æœŸ |
| è¿ç»­é˜…è¯»30å¤© | +150 | æ— é™åˆ¶ | æ¯ä¸ªå‘¨æœŸ |
| é‚€è¯·å¥½å‹æ³¨å†Œ | +25 | æ— é™åˆ¶ | å¥½å‹å®Œæˆé¦–æ¬¡é˜…è¯» |
| å‚ä¸è¯é¢˜è®¨è®º | +5 | 10æ¬¡/å¤© | æœ‰æ•ˆå›å¤ |
| ä¸Šä¼ ç”µå­ä¹¦ | +8 | 5æ¬¡/å¤© | å®Œæ•´ä¹¦ç± |

#### 4.3.2 æˆå°±å¾½ç« ç³»ç»Ÿ

**é˜…è¯»ç±»æˆå°±:**

| æˆå°±åç§° | è§£é”æ¡ä»¶ | å¾½ç« å›¾æ ‡ | å¥–åŠ±XP |
|---------|---------|---------|--------|
| åˆå‡ºèŒ…åº | å®Œæˆç¬¬1æœ¬ä¹¦ | ğŸŒ± | +20 |
| æ¸å…¥ä½³å¢ƒ | å®Œæˆç¬¬10æœ¬ä¹¦ | ğŸ“š | +50 |
| é˜…è¯»è¾¾äºº | å®Œæˆç¬¬50æœ¬ä¹¦ | ğŸ“– | +100 |
| é˜…è¯»å¤§å¸ˆ | å®Œæˆç¬¬100æœ¬ä¹¦ | ğŸ† | +200 |
| é˜…è¯»ç‹‚äºº | å®Œæˆç¬¬500æœ¬ä¹¦ | ğŸ‘‘ | +500 |

**æ—¶é•¿ç±»æˆå°±:**

| æˆå°±åç§° | è§£é”æ¡ä»¶ | å¾½ç« å›¾æ ‡ | å¥–åŠ±XP |
|---------|---------|---------|--------|
| åˆè¯†æ—¶å…‰ | ç´¯è®¡é˜…è¯»1å°æ—¶ | â±ï¸ | +10 |
| æ—¶å…‰æ—…äºº | ç´¯è®¡é˜…è¯»10å°æ—¶ | â° | +30 |
| æ—¶å…‰è¡Œè€… | ç´¯è®¡é˜…è¯»100å°æ—¶ | âŒš | +100 |
| æ—¶å…‰å®ˆæŠ¤è€… | ç´¯è®¡é˜…è¯»1000å°æ—¶ | ğŸ• | +300 |

**åšæŒç±»æˆå°±:**

| æˆå°±åç§° | è§£é”æ¡ä»¶ | å¾½ç« å›¾æ ‡ | å¥–åŠ±XP |
|---------|---------|---------|--------|
| åˆå¿ƒä¸æ”¹ | è¿ç»­é˜…è¯»3å¤© | ğŸ”¥ | +15 |
| æŒä¹‹ä»¥æ’ | è¿ç»­é˜…è¯»7å¤© | ğŸŒŸ | +30 |
| é“æµæˆé’ˆ | è¿ç»­é˜…è¯»30å¤© | â­ | +150 |
| ç™¾æŠ˜ä¸æŒ  | è¿ç»­é˜…è¯»100å¤© | ğŸ’« | +500 |
| æ’å¿ƒæ°¸å›º | è¿ç»­é˜…è¯»365å¤© | ğŸ… | +2000 |

**ç¤¾äº¤ç±»æˆå°±:**

| æˆå°±åç§° | è§£é”æ¡ä»¶ | å¾½ç« å›¾æ ‡ | å¥–åŠ±XP |
|---------|---------|---------|--------|
| ä¹¦è¯„æ–°äºº | å‘è¡¨ç¬¬1æ¡ä¹¦è¯„ | âœï¸ | +10 |
| ä¹¦è¯„è¾¾äºº | å‘è¡¨ç¬¬10æ¡ä¹¦è¯„ | ğŸ“ | +30 |
| æ„è§é¢†è¢– | ä¹¦è¯„è·èµ100æ¬¡ | ğŸ’¬ | +100 |
| ä¹¦å•ä¸“å®¶ | åˆ›å»º10ä¸ªä¹¦å• | ğŸ“‹ | +50 |
| åˆ†äº«ä¹‹æ˜Ÿ | ä¹¦å•è¢«æ”¶è—100æ¬¡ | â­ | +150 |
| ç¤¾äº¤è¾¾äºº | æ‹¥æœ‰50ä¸ªç²‰ä¸ | ğŸ‘¥ | +100 |

#### 4.3.3 ç­‰çº§ç§°å·

```
Level 0 (0-99 XP): ä¹¦ç«¥
Level 1 (100-299 XP): ä¹¦è™«
Level 2 (300-699 XP): ä¹¦å‹
Level 3 (700-1499 XP): ä¹¦è¿·
Level 4 (1500-2999 XP): ä¹¦ç—´
Level 5 (3000-5999 XP): ä¹¦è¯„å®¶
Level 6 (6000-9999 XP): é˜…è¯»è¾¾äºº
Level 7 (10000-19999 XP): é˜…è¯»å¤§å¸ˆ
Level 8 (20000-39999 XP): æ–‡å­¦åšå£«
Level 9 (40000-79999 XP): çŸ¥è¯†å¯¼å¸ˆ
Level 10 (80000+ XP): æ™ºæ…§è´¤è€…
```

**ç­‰çº§æƒç›Š:**

| ç­‰çº§ | ä¹¦æ¶å®¹é‡ | ç¦»çº¿ä¸‹è½½ | AIé—®ç­” | ä¸“å±æ ‡è¯† | å…¶ä»–æƒç›Š |
|-----|---------|---------|--------|---------|---------|
| 0-1 | 100æœ¬ | 3æœ¬ | 5æ¬¡/å¤© | æ—  | åŸºç¡€åŠŸèƒ½ |
| 2-3 | 300æœ¬ | 5æœ¬ | 10æ¬¡/å¤© | é“œç‰Œæ ‡è¯† | å»å¹¿å‘Š |
| 4-5 | 500æœ¬ | 10æœ¬ | 20æ¬¡/å¤© | é“¶ç‰Œæ ‡è¯† | ä¼˜å…ˆå®¢æœ |
| 6-7 | 1000æœ¬ | 20æœ¬ | 50æ¬¡/å¤© | é‡‘ç‰Œæ ‡è¯† | é«˜çº§ç»Ÿè®¡ |
| 8-9 | 3000æœ¬ | 50æœ¬ | 100æ¬¡/å¤© | é’»çŸ³æ ‡è¯† | ä¸“å±æ´»åŠ¨ |
| 10+ | æ— é™åˆ¶ | æ— é™åˆ¶ | æ— é™åˆ¶ | ç‹å† æ ‡è¯† | å®šåˆ¶æœåŠ¡ |

### 4.4 ç¤¾äº¤å…³ç³»ç®¡ç†

#### 4.4.1 å¥½å‹ç³»ç»Ÿ

**æ·»åŠ å¥½å‹æ–¹å¼:**
1. æœç´¢ç”¨æˆ·å/æ‰‹æœºå·
2. æ‰«æäºŒç»´ç 
3. ä»é€šè®¯å½•å¯¼å…¥
4. æ¨èå¥½å‹ (å¯èƒ½è®¤è¯†çš„äºº)
5. ç¾¤ç»„æˆå‘˜åˆ—è¡¨

**å¥½å‹è¯·æ±‚æµç¨‹:**
```
ç”¨æˆ·A â†’ å‘é€å¥½å‹è¯·æ±‚ (é™„å¸¦éªŒè¯æ¶ˆæ¯)
       â†“
ç”¨æˆ·B â† æ”¶åˆ°è¯·æ±‚é€šçŸ¥
       â†“
       é€‰æ‹©: [æ¥å—] [æ‹’ç»] [å¿½ç•¥]
       â†“
[æ¥å—] â†’ æˆä¸ºå¥½å‹,åŒå‘å…³æ³¨
[æ‹’ç»] â†’ é€šçŸ¥A "å¯¹æ–¹æ‹’ç»äº†ä½ çš„å¥½å‹è¯·æ±‚"
[å¿½ç•¥] â†’ ä¸åšå¤„ç†,è¯·æ±‚ä¿ç•™
```

**å¥½å‹ç®¡ç†åŠŸèƒ½:**
- å¥½å‹åˆ—è¡¨ (æŒ‰æœ€è¿‘èŠå¤©/å­—æ¯æ’åº)
- å¥½å‹åˆ†ç»„ (è‡ªå®šä¹‰æ ‡ç­¾)
- ç‰¹åˆ«å…³æ³¨ (ç½®é¡¶æ˜¾ç¤º)
- å¥½å‹å¤‡æ³¨ (ä»…è‡ªå·±å¯è§)
- åˆ é™¤å¥½å‹
- æ‹‰é»‘ç”¨æˆ·

#### 4.4.2 å…³æ³¨ç³»ç»Ÿ

**å…³æ³¨ vs å¥½å‹çš„åŒºåˆ«:**
- å…³æ³¨: å•å‘å…³ç³»,å¯çœ‹åˆ°å¯¹æ–¹å…¬å¼€åŠ¨æ€
- å¥½å‹: åŒå‘å…³ç³»,å¯ç§ä¿¡äº’åŠ¨

**å…³æ³¨åŠŸèƒ½:**
- å…³æ³¨ç”¨æˆ·
- å–æ¶ˆå…³æ³¨
- æŸ¥çœ‹å…³æ³¨åˆ—è¡¨
- æŸ¥çœ‹ç²‰ä¸åˆ—è¡¨
- äº’ç›¸å…³æ³¨ (äº’ç²‰)

#### 4.4.3 å±è”½ä¸ä¸¾æŠ¥

**å±è”½åŠŸèƒ½:**
- å±è”½ç”¨æˆ· (å¯¹æ–¹æ— æ³•æŸ¥çœ‹ä½ çš„åŠ¨æ€ã€è¯„è®º)
- å±è”½åˆ—è¡¨ç®¡ç†
- è§£é™¤å±è”½

**ä¸¾æŠ¥åŠŸèƒ½:**
- ä¸¾æŠ¥ç†ç”±: åƒåœ¾å¹¿å‘Š/æ¶æ„è¾±éª‚/è‰²æƒ…ä½ä¿—/ä¾µçŠ¯éšç§/å…¶ä»–
- æäº¤è¯æ® (æˆªå›¾)
- ä¸¾æŠ¥å¤„ç†æµç¨‹: å®¡æ ¸ â†’ è­¦å‘Š/å°ç¦/æ°¸ä¹…å°å·
- ä¸¾æŠ¥åé¦ˆé€šçŸ¥

---

## 5. æ•°æ®åº“æ¶æ„è®¾è®¡

### 5.1 æ ¸å¿ƒè¡¨ç»“æ„

#### 5.1.1 ç”¨æˆ·åŸºç¡€ä¿¡æ¯è¡¨ (users)

```sql
CREATE TABLE users (
    -- ä¸»é”®å’Œæ ‡è¯†
    id BIGINT PRIMARY KEY AUTO_INCREMENT COMMENT 'ç”¨æˆ·ID',
    uuid VARCHAR(36) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·UUID,å…¨å±€å”¯ä¸€',
    username VARCHAR(50) UNIQUE NOT NULL COMMENT 'ç”¨æˆ·å',

    -- è®¤è¯ä¿¡æ¯
    password_hash VARCHAR(255) COMMENT 'bcryptå¯†ç å“ˆå¸Œ',
    phone_number VARCHAR(20) UNIQUE COMMENT 'æ‰‹æœºå·(AES-256åŠ å¯†)',
    phone_verified BOOLEAN DEFAULT FALSE COMMENT 'æ‰‹æœºå·å·²éªŒè¯',
    email VARCHAR(100) UNIQUE COMMENT 'é‚®ç®±',
    email_verified BOOLEAN DEFAULT FALSE COMMENT 'é‚®ç®±å·²éªŒè¯',

    -- è´¦æˆ·çŠ¶æ€
    status TINYINT DEFAULT 1 COMMENT '1-æ­£å¸¸ 2-å†»ç»“ 3-æ³¨é”€ 4-å¾…æ¿€æ´»',
    is_verified BOOLEAN DEFAULT FALSE COMMENT 'å®åè®¤è¯',

    -- è§’è‰²å’Œç­‰çº§
    role ENUM('user', 'admin', 'super_admin', 'vip') DEFAULT 'user',
    member_level TINYINT DEFAULT 0 COMMENT 'ä¼šå‘˜ç­‰çº§0-4',
    member_expire_at DATETIME COMMENT 'ä¼šå‘˜åˆ°æœŸæ—¶é—´',

    -- æˆå°±ç³»ç»Ÿ
    xp INT DEFAULT 0 COMMENT 'ç»éªŒå€¼',
    level TINYINT DEFAULT 0 COMMENT 'ç”¨æˆ·ç­‰çº§0-10',

    -- å®‰å…¨ä¿¡æ¯
    failed_login_attempts INT DEFAULT 0 COMMENT 'è¿ç»­ç™»å½•å¤±è´¥æ¬¡æ•°',
    locked_until DATETIME COMMENT 'è´¦æˆ·é”å®šæˆªæ­¢æ—¶é—´',
    last_login_at DATETIME COMMENT 'æœ€åç™»å½•æ—¶é—´',
    last_login_ip VARCHAR(45) COMMENT 'æœ€åç™»å½•IP',

    -- æ—¶é—´æˆ³
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    deleted_at DATETIME COMMENT 'è½¯åˆ é™¤æ—¶é—´',

    -- ç´¢å¼•
    INDEX idx_username (username),
    INDEX idx_phone (phone_number),
    INDEX idx_email (email),
    INDEX idx_status (status),
    INDEX idx_level (level),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='ç”¨æˆ·åŸºç¡€è¡¨';
```

#### 5.1.2 ç”¨æˆ·è¯¦ç»†èµ„æ–™è¡¨ (user_profiles)

```sql
CREATE TABLE user_profiles (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNIQUE NOT NULL,

    -- ä¸ªäººä¿¡æ¯
    nickname VARCHAR(50) COMMENT 'æ˜µç§°',
    real_name VARCHAR(50) COMMENT 'çœŸå®å§“å(åŠ å¯†)',
    avatar_url VARCHAR(255) COMMENT 'å¤´åƒURL',
    gender TINYINT COMMENT '0-æœªçŸ¥ 1-ç”· 2-å¥³',
    birthday DATE COMMENT 'ç”Ÿæ—¥',

    -- åœ°ç†ä½ç½®
    country VARCHAR(50) COMMENT 'å›½å®¶',
    province VARCHAR(50) COMMENT 'çœä»½',
    city VARCHAR(50) COMMENT 'åŸå¸‚',

    -- ä¸ªäººæè¿°
    bio TEXT COMMENT 'ä¸ªäººç®€ä»‹',
    signature VARCHAR(255) COMMENT 'ä¸ªæ€§ç­¾å',

    -- ç¤¾äº¤è´¦å·
    wechat VARCHAR(50) COMMENT 'å¾®ä¿¡å·',
    qq VARCHAR(20) COMMENT 'QQå·',
    weibo VARCHAR(50) COMMENT 'å¾®åš',

    -- ç»Ÿè®¡æ•°æ®
    followers_count INT DEFAULT 0 COMMENT 'ç²‰ä¸æ•°',
    following_count INT DEFAULT 0 COMMENT 'å…³æ³¨æ•°',
    books_read_count INT DEFAULT 0 COMMENT 'å·²è¯»ä¹¦ç±æ•°',
    reading_days INT DEFAULT 0 COMMENT 'ç´¯è®¡é˜…è¯»å¤©æ•°',
    reading_minutes INT DEFAULT 0 COMMENT 'ç´¯è®¡é˜…è¯»åˆ†é’Ÿæ•°',
    reviews_count INT DEFAULT 0 COMMENT 'ä¹¦è¯„æ•°',
    book_lists_count INT DEFAULT 0 COMMENT 'ä¹¦å•æ•°',
    points INT DEFAULT 0 COMMENT 'ç§¯åˆ†',
    balance DECIMAL(10, 2) DEFAULT 0.00 COMMENT 'ä½™é¢',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_nickname (nickname),
    INDEX idx_city (city)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.3 ç¬¬ä¸‰æ–¹ç™»å½•ç»‘å®šè¡¨ (user_oauth_bindings)

```sql
CREATE TABLE user_oauth_bindings (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,

    -- ç¬¬ä¸‰æ–¹å¹³å°
    provider VARCHAR(20) NOT NULL COMMENT 'wechat/qq/apple/google/alipay',
    provider_user_id VARCHAR(100) NOT NULL COMMENT 'ç¬¬ä¸‰æ–¹ç”¨æˆ·ID',
    openid VARCHAR(100) COMMENT 'OpenID',
    unionid VARCHAR(100) COMMENT 'UnionID',

    -- ç¬¬ä¸‰æ–¹ç”¨æˆ·ä¿¡æ¯
    provider_nickname VARCHAR(100) COMMENT 'ç¬¬ä¸‰æ–¹æ˜µç§°',
    provider_avatar VARCHAR(255) COMMENT 'ç¬¬ä¸‰æ–¹å¤´åƒ',

    -- è®¿é—®ä»¤ç‰Œ
    access_token TEXT COMMENT 'è®¿é—®ä»¤ç‰Œ(åŠ å¯†)',
    refresh_token TEXT COMMENT 'åˆ·æ–°ä»¤ç‰Œ(åŠ å¯†)',
    expires_at DATETIME COMMENT 'ä»¤ç‰Œè¿‡æœŸæ—¶é—´',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_provider_openid (provider, openid),
    INDEX idx_user_id (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.4 ç”¨æˆ·è®¾å¤‡è¡¨ (user_devices)

```sql
CREATE TABLE user_devices (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,

    -- è®¾å¤‡ä¿¡æ¯
    device_id VARCHAR(100) UNIQUE NOT NULL COMMENT 'è®¾å¤‡å”¯ä¸€æ ‡è¯†',
    device_name VARCHAR(100) COMMENT 'è®¾å¤‡åç§°',
    device_type VARCHAR(20) COMMENT 'ios/android/web/desktop',
    os_version VARCHAR(50) COMMENT 'æ“ä½œç³»ç»Ÿç‰ˆæœ¬',
    app_version VARCHAR(20) COMMENT 'APPç‰ˆæœ¬',

    -- è®¾å¤‡è¯¦æƒ…
    brand VARCHAR(50) COMMENT 'è®¾å¤‡å“ç‰Œ',
    model VARCHAR(50) COMMENT 'è®¾å¤‡å‹å·',

    -- ä»¤ç‰Œ
    push_token VARCHAR(255) COMMENT 'æ¨é€ä»¤ç‰Œ',
    refresh_token VARCHAR(255) UNIQUE COMMENT 'åˆ·æ–°ä»¤ç‰Œ',

    -- ç™»å½•ä¿¡æ¯
    last_active_at DATETIME COMMENT 'æœ€åæ´»è·ƒæ—¶é—´',
    last_ip VARCHAR(45) COMMENT 'æœ€åIP',
    login_count INT DEFAULT 1 COMMENT 'ç™»å½•æ¬¡æ•°',

    -- çŠ¶æ€
    is_active BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦æ´»è·ƒ',
    is_trusted BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å—ä¿¡ä»»',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_device_id (device_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.5 ç”¨æˆ·åå¥½è®¾ç½®è¡¨ (user_preferences)

```sql
CREATE TABLE user_preferences (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT UNIQUE NOT NULL,

    -- åŸºç¡€è®¾ç½®
    language VARCHAR(10) DEFAULT 'zh-CN',
    timezone VARCHAR(50) DEFAULT 'Asia/Shanghai',
    theme VARCHAR(20) DEFAULT 'light' COMMENT 'light/dark/auto',

    -- é€šçŸ¥è®¾ç½®
    notification_enabled BOOLEAN DEFAULT TRUE,
    email_notification BOOLEAN DEFAULT TRUE,
    sms_notification BOOLEAN DEFAULT FALSE,
    push_notification BOOLEAN DEFAULT TRUE,

    -- éšç§è®¾ç½®
    profile_visible BOOLEAN DEFAULT TRUE COMMENT 'èµ„æ–™å…¬å¼€',
    show_online_status BOOLEAN DEFAULT TRUE COMMENT 'æ˜¾ç¤ºåœ¨çº¿çŠ¶æ€',
    allow_search BOOLEAN DEFAULT TRUE COMMENT 'å…è®¸è¢«æœç´¢',
    allow_friend_request BOOLEAN DEFAULT TRUE COMMENT 'å…è®¸å¥½å‹è¯·æ±‚',

    -- é˜…è¯»åå¥½
    font_size TINYINT DEFAULT 16 COMMENT 'å­—ä½“å¤§å°',
    font_family VARCHAR(50) DEFAULT 'system',
    line_spacing DECIMAL(3, 1) DEFAULT 1.5 COMMENT 'è¡Œé—´è·',
    page_mode VARCHAR(20) DEFAULT 'scroll' COMMENT 'scroll/flip/slide',
    reading_background VARCHAR(20) DEFAULT 'white',
    auto_bookmark BOOLEAN DEFAULT TRUE,
    reading_reminder BOOLEAN DEFAULT FALSE,
    preferred_genres JSON COMMENT 'åå¥½åˆ†ç±»',

    -- æ‰©å±•è®¾ç½®
    extra_settings JSON,

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.6 æˆå°±è®°å½•è¡¨ (user_achievements)

```sql
CREATE TABLE user_achievements (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,

    -- æˆå°±ä¿¡æ¯
    achievement_code VARCHAR(50) NOT NULL COMMENT 'æˆå°±ä»£ç ',
    achievement_name VARCHAR(100) COMMENT 'æˆå°±åç§°',
    achievement_description TEXT COMMENT 'æˆå°±æè¿°',
    badge_icon_url VARCHAR(255) COMMENT 'å¾½ç« å›¾æ ‡',

    -- æˆå°±ç­‰çº§
    achievement_level TINYINT DEFAULT 1,
    achievement_points INT DEFAULT 0 COMMENT 'è·å¾—ç§¯åˆ†',

    -- è§¦å‘æ–¹å¼
    trigger_type VARCHAR(50) COMMENT 'read_books/reviews/streak',
    trigger_value INT COMMENT 'è§¦å‘æ•°å€¼',

    unlocked_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_achievement (user_id, achievement_code),
    INDEX idx_user_id (user_id),
    INDEX idx_achievement_code (achievement_code)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.7 ç»éªŒå€¼è®°å½•è¡¨ (user_xp_logs)

```sql
CREATE TABLE user_xp_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,

    -- è¡Œä¸ºä¿¡æ¯
    action_type VARCHAR(50) NOT NULL COMMENT 'complete_book/review/streak',
    action_description VARCHAR(255) COMMENT 'è¡Œä¸ºæè¿°',

    -- XPå˜åŒ–
    xp_delta INT NOT NULL COMMENT 'XPå˜åŒ–é‡(å¯ä¸ºè´Ÿ)',
    xp_before INT NOT NULL COMMENT 'å˜åŒ–å‰XP',
    xp_after INT NOT NULL COMMENT 'å˜åŒ–åXP',

    -- ç­‰çº§å˜åŒ–
    level_before TINYINT COMMENT 'å˜åŒ–å‰ç­‰çº§',
    level_after TINYINT COMMENT 'å˜åŒ–åç­‰çº§',

    -- å…³è”èµ„æº
    resource_type VARCHAR(50) COMMENT 'book/review/booklist',
    resource_id BIGINT COMMENT 'èµ„æºID',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_action_type (action_type),
    INDEX idx_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.8 ç”¨æˆ·å…³ç³»è¡¨ (user_relationships)

```sql
CREATE TABLE user_relationships (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·A',
    target_user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·B',

    -- å…³ç³»ç±»å‹
    relationship_type ENUM('follow', 'friend', 'block') NOT NULL,

    -- å¥½å‹è¯·æ±‚
    request_message VARCHAR(255) COMMENT 'å¥½å‹è¯·æ±‚æ¶ˆæ¯',
    request_status ENUM('pending', 'accepted', 'rejected') DEFAULT 'pending',

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (target_user_id) REFERENCES users(id) ON DELETE CASCADE,
    UNIQUE KEY uk_user_relationship (user_id, target_user_id, relationship_type),
    INDEX idx_user_id (user_id),
    INDEX idx_target_user_id (target_user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

#### 5.1.9 ç™»å½•æ—¥å¿—è¡¨ (user_login_logs)

```sql
CREATE TABLE user_login_logs (
    id BIGINT PRIMARY KEY AUTO_INCREMENT,
    user_id BIGINT NOT NULL,

    -- ç™»å½•ä¿¡æ¯
    login_type ENUM('password', 'sms', 'email', 'oauth', 'qrcode') NOT NULL,
    login_status ENUM('success', 'failed', 'blocked') NOT NULL,
    fail_reason VARCHAR(255) COMMENT 'å¤±è´¥åŸå› ',

    -- è®¾å¤‡å’Œç½‘ç»œ
    device_id VARCHAR(100),
    device_type VARCHAR(20),
    ip_address VARCHAR(45),
    location VARCHAR(100) COMMENT 'åœ°ç†ä½ç½®',
    user_agent TEXT,

    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,

    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_created_at (created_at),
    INDEX idx_ip_address (ip_address)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 5.2 æ•°æ®åŠ å¯†ç­–ç•¥

#### 5.2.1 æ•æ„Ÿå­—æ®µåŠ å¯†

```python
# ä½¿ç”¨AES-256-GCMåŠ å¯†æ•æ„Ÿæ•°æ®

from cryptography.hazmat.primitives.ciphers.aead import AESGCM
import os
import base64

class DataEncryption:
    """æ•°æ®åŠ å¯†æœåŠ¡"""

    def __init__(self, master_key: bytes):
        self.master_key = master_key
        self.aesgcm = AESGCM(master_key)

    def encrypt_phone_number(self, phone: str) -> dict:
        """åŠ å¯†æ‰‹æœºå·"""
        # ç”ŸæˆéšæœºIV(12å­—èŠ‚)
        iv = os.urandom(12)

        # åŠ å¯†
        ciphertext = self.aesgcm.encrypt(iv, phone.encode(), None)

        return {
            'encrypted': base64.b64encode(ciphertext).decode(),
            'iv': base64.b64encode(iv).decode()
        }

    def decrypt_phone_number(self, encrypted: str, iv: str) -> str:
        """è§£å¯†æ‰‹æœºå·"""
        ciphertext = base64.b64decode(encrypted)
        iv_bytes = base64.b64decode(iv)

        plaintext = self.aesgcm.decrypt(iv_bytes, ciphertext, None)
        return plaintext.decode()

# å¯†ç å“ˆå¸Œ
import bcrypt

def hash_password(password: str) -> str:
    """ä½¿ç”¨bcryptå“ˆå¸Œå¯†ç """
    salt = bcrypt.gensalt(rounds=12)
    hashed = bcrypt.hashpw(password.encode(), salt)
    return hashed.decode()

def verify_password(password: str, hashed: str) -> bool:
    """éªŒè¯å¯†ç """
    return bcrypt.checkpw(password.encode(), hashed.encode())
```

---

## 6. ä¸šåŠ¡æµç¨‹ä¸äº¤äº’

### 6.1 æ³¨å†Œæµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·æ³¨å†Œå®Œæ•´æµç¨‹                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·                    å‰ç«¯                    åç«¯                    ç¬¬ä¸‰æ–¹
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚  1.é€‰æ‹©æ³¨å†Œæ–¹å¼       â”‚                      â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚  [æ–¹å¼A: æ‰‹æœºå·+éªŒè¯ç ]                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚  2.è¾“å…¥æ‰‹æœºå·         â”‚                      â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
 â”‚                      â”‚  3.è¯·æ±‚éªŒè¯ç          â”‚                      â”‚
 â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                      â”‚                      â”‚  4.å‘é€çŸ­ä¿¡          â”‚
 â”‚                      â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                      â”‚  5.éªŒè¯ç å·²å‘é€       â”‚                      â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
 â”‚  6.å€’è®¡æ—¶60ç§’         â”‚                      â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚  7.è¾“å…¥éªŒè¯ç          â”‚                      â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
 â”‚                      â”‚  8.æäº¤æ³¨å†Œ          â”‚                      â”‚
 â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                      â”‚                      â”‚  9.æ ¡éªŒéªŒè¯ç          â”‚
 â”‚                      â”‚                      â”‚  10.åˆ›å»ºç”¨æˆ·          â”‚
 â”‚                      â”‚                      â”‚  11.ç”Ÿæˆtoken        â”‚
 â”‚                      â”‚  12.æ³¨å†ŒæˆåŠŸ          â”‚                      â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
 â”‚  13.è·³è½¬é¦–æ¬¡å¼•å¯¼é¡µ     â”‚                      â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚  14.å®Œå–„ä¸ªäººä¿¡æ¯       â”‚                      â”‚                      â”‚
 â”‚  (ä¸Šä¼ å¤´åƒ/æ˜µç§°)       â”‚                      â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
 â”‚                      â”‚  15.æ›´æ–°ç”¨æˆ·èµ„æ–™      â”‚                      â”‚
 â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                      â”‚  16.å®Œæˆ              â”‚                      â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
 â”‚  17.è¿›å…¥é¦–é¡µ          â”‚                      â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                      â”‚
```

### 6.2 ç™»å½•æµç¨‹å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       ç”¨æˆ·ç™»å½•æµç¨‹                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·                    å‰ç«¯                    åç«¯                    ç¼“å­˜
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚  1.è¾“å…¥æ‰‹æœºå·+å¯†ç      â”‚                      â”‚                      â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚                      â”‚
 â”‚                      â”‚  2.æäº¤ç™»å½•          â”‚                      â”‚
 â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
 â”‚                      â”‚                      â”‚  3.æŸ¥è¯¢ç”¨æˆ·           â”‚
 â”‚                      â”‚                      â”‚  (by phone)          â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚  4.éªŒè¯å¯†ç            â”‚
 â”‚                      â”‚                      â”‚  (bcrypt.verify)     â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚  5.æ£€æŸ¥è´¦æˆ·çŠ¶æ€       â”‚
 â”‚                      â”‚                      â”‚  (status=1æ­£å¸¸)      â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚  6.æ£€æŸ¥å¤±è´¥æ¬¡æ•°       â”‚
 â”‚                      â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                      â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
 â”‚                      â”‚                      â”‚  (Redis: login_fail) â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚                      â”‚  7.ç”Ÿæˆtoken         â”‚
 â”‚                      â”‚                      â”‚  8.è®°å½•ç™»å½•æ—¥å¿—       â”‚
 â”‚                      â”‚                      â”‚  9.æ›´æ–°è®¾å¤‡è¡¨         â”‚
 â”‚                      â”‚                      â”‚  10.æ¸…é™¤å¤±è´¥æ¬¡æ•°      â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚                      â”‚  11.è¿”å›token+ç”¨æˆ·ä¿¡æ¯â”‚                      â”‚
 â”‚                      â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
 â”‚                      â”‚                      â”‚                      â”‚
 â”‚  12.ä¿å­˜tokenåˆ°æœ¬åœ°   â”‚                      â”‚                      â”‚
 â”‚  13.è·³è½¬é¦–é¡µ          â”‚                      â”‚                      â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚                      â”‚
```

### 6.3 è·¨è®¾å¤‡åŒæ­¥æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   è·¨è®¾å¤‡å®æ—¶åŒæ­¥æµç¨‹                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®¾å¤‡A(iPhone)         åç«¯åŒæ­¥æœåŠ¡              è®¾å¤‡B(iPad)
     â”‚                      â”‚                      â”‚
     â”‚  1.ç”¨æˆ·åœ¨è®¾å¤‡Aé˜…è¯»    â”‚                      â”‚
     â”‚  (ç¿»åˆ°ç¬¬50é¡µ)         â”‚                      â”‚
     â”‚                      â”‚                      â”‚
     â”‚  2.ä¸ŠæŠ¥è¿›åº¦æ›´æ–°       â”‚                      â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                      â”‚
     â”‚  {book_id: 123,      â”‚                      â”‚
     â”‚   page: 50,          â”‚                      â”‚
     â”‚   progress: 45%}     â”‚                      â”‚
     â”‚                      â”‚                      â”‚
     â”‚                      â”‚  3.ä¿å­˜åˆ°æ•°æ®åº“        â”‚
     â”‚                      â”‚  4.æ›´æ–°Redisç¼“å­˜      â”‚
     â”‚                      â”‚  5.æ£€æŸ¥è¯¥ç”¨æˆ·çš„å…¶ä»–è®¾å¤‡â”‚
     â”‚                      â”‚                      â”‚
     â”‚                      â”‚  6.æ¨é€åŒæ­¥æ¶ˆæ¯       â”‚
     â”‚                      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
     â”‚                      â”‚  (WebSocket)         â”‚
     â”‚                      â”‚                      â”‚
     â”‚                      â”‚                      â”‚  7.æ”¶åˆ°åŒæ­¥æ¶ˆæ¯
     â”‚                      â”‚                      â”‚  8.æ›´æ–°æœ¬åœ°è¿›åº¦
     â”‚                      â”‚                      â”‚  9.åˆ·æ–°UIæ˜¾ç¤º
     â”‚                      â”‚                      â”‚
     â”‚  10.è¿”å›åŒæ­¥æˆåŠŸ      â”‚                      â”‚
     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
```

### 6.4 æˆå°±è§£é”æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     æˆå°±è§£é”æµç¨‹                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ç”¨æˆ·æ“ä½œ             è§¦å‘äº‹ä»¶             æˆå°±æ£€æµ‹              é€šçŸ¥æœåŠ¡
   â”‚                    â”‚                    â”‚                    â”‚
   â”‚  å®Œæˆä¸€æœ¬ä¹¦         â”‚                    â”‚                    â”‚
   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚
   â”‚                    â”‚  1.è®°å½•é˜…è¯»å®Œæˆ     â”‚                    â”‚
   â”‚                    â”‚  2.æ›´æ–°ç»Ÿè®¡æ•°æ®     â”‚                    â”‚
   â”‚                    â”‚                    â”‚                    â”‚
   â”‚                    â”‚  3.è§¦å‘æˆå°±æ£€æµ‹     â”‚                    â”‚
   â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚
   â”‚                    â”‚                    â”‚  4.æŸ¥è¯¢ç”¨æˆ·å·²è¯»æ•°   â”‚
   â”‚                    â”‚                    â”‚  5.åŒ¹é…æˆå°±è§„åˆ™     â”‚
   â”‚                    â”‚                    â”‚                    â”‚
   â”‚                    â”‚                    â”‚  [è§„åˆ™: å®Œæˆ1æœ¬ä¹¦]  â”‚
   â”‚                    â”‚                    â”‚  -> è§£é”"åˆå‡ºèŒ…åº"  â”‚
   â”‚                    â”‚                    â”‚                    â”‚
   â”‚                    â”‚                    â”‚  6.æ’å…¥æˆå°±è®°å½•     â”‚
   â”‚                    â”‚                    â”‚  7.å¢åŠ XP          â”‚
   â”‚                    â”‚                    â”‚  8.æ£€æŸ¥ç­‰çº§æå‡     â”‚
   â”‚                    â”‚                    â”‚                    â”‚
   â”‚                    â”‚                    â”‚  9.å‘é€é€šçŸ¥         â”‚
   â”‚                    â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
   â”‚                    â”‚                    â”‚                    â”‚
   â”‚                    â”‚                    â”‚                    â”‚  10.æ¨é€æ¶ˆæ¯
   â”‚  æ”¶åˆ°æˆå°±é€šçŸ¥        â”‚                    â”‚                    â”‚  "æ­å–œè§£é”æˆå°±"
   â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
   â”‚                    â”‚                    â”‚                    â”‚
   â”‚  [å¼¹çª—å±•ç¤ºå¾½ç« ]     â”‚                    â”‚                    â”‚
```

---

## 7. å®‰å…¨ä¸éšç§ä¿æŠ¤

### 7.1 å¯†ç å®‰å…¨ç­–ç•¥

**å¯†ç å¼ºåº¦è¦æ±‚:**
- æœ€å°‘6ä½,æœ€å¤š16ä½
- å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­—
- æ¨èåŒ…å«ç‰¹æ®Šå­—ç¬¦
- ä¸èƒ½æ˜¯çº¯æ•°å­—æˆ–çº¯å­—æ¯
- ä¸èƒ½åŒ…å«æ‰‹æœºå·

**å¯†ç å­˜å‚¨:**
```python
# ä½¿ç”¨bcrypt,è‡ªåŠ¨åŠ ç›
import bcrypt

def hash_password(password: str) -> str:
    # cost factor = 12
    salt = bcrypt.gensalt(rounds=12)
    return bcrypt.hashpw(password.encode(), salt).decode()
```

**å¯†ç ç­–ç•¥:**
- 90å¤©æé†’ä¿®æ”¹å¯†ç 
- ç¦æ­¢ä½¿ç”¨æœ€è¿‘5æ¬¡ä½¿ç”¨è¿‡çš„å¯†ç 
- è¿ç»­5æ¬¡ç™»å½•å¤±è´¥é”å®š30åˆ†é’Ÿ

### 7.2 éªŒè¯ç å®‰å…¨

**éªŒè¯ç è§„åˆ™:**
- 6ä½æ•°å­—
- æœ‰æ•ˆæœŸ5åˆ†é’Ÿ
- åŒä¸€æ‰‹æœºå·: 1æ¬¡/60ç§’, 5æ¬¡/å¤©
- åŒä¸€IP: 10æ¬¡/å°æ—¶, 50æ¬¡/å¤©

**é˜²åˆ·ç­–ç•¥:**
```python
import redis
from datetime import timedelta

class SMSRateLimiter:
    """çŸ­ä¿¡å‘é€é¢‘ç‡é™åˆ¶"""

    def __init__(self, redis_client):
        self.redis = redis_client

    def check_phone_limit(self, phone: str) -> bool:
        """æ£€æŸ¥æ‰‹æœºå·é™åˆ¶"""
        # 60ç§’é™åˆ¶
        key_60s = f'sms:phone:60s:{phone}'
        if self.redis.exists(key_60s):
            return False

        # 24å°æ—¶é™åˆ¶(5æ¬¡)
        key_24h = f'sms:phone:24h:{phone}'
        count = self.redis.get(key_24h) or 0
        if int(count) >= 5:
            return False

        return True

    def record_phone_send(self, phone: str):
        """è®°å½•å‘é€"""
        # 60ç§’key
        key_60s = f'sms:phone:60s:{phone}'
        self.redis.setex(key_60s, 60, 1)

        # 24å°æ—¶è®¡æ•°
        key_24h = f'sms:phone:24h:{phone}'
        self.redis.incr(key_24h)
        self.redis.expire(key_24h, 86400)

    def check_ip_limit(self, ip: str) -> bool:
        """æ£€æŸ¥IPé™åˆ¶"""
        # 1å°æ—¶é™åˆ¶(10æ¬¡)
        key_1h = f'sms:ip:1h:{ip}'
        count_1h = self.redis.get(key_1h) or 0
        if int(count_1h) >= 10:
            return False

        # 24å°æ—¶é™åˆ¶(50æ¬¡)
        key_24h = f'sms:ip:24h:{ip}'
        count_24h = self.redis.get(key_24h) or 0
        if int(count_24h) >= 50:
            return False

        return True
```

### 7.3 æ•æ„Ÿæ•°æ®ä¿æŠ¤

**æ•°æ®è„±æ•:**
```python
def mask_phone(phone: str) -> str:
    """æ‰‹æœºå·è„±æ•: 138****5678"""
    if len(phone) == 11:
        return phone[:3] + '****' + phone[7:]
    return phone

def mask_email(email: str) -> str:
    """é‚®ç®±è„±æ•: u***@example.com"""
    username, domain = email.split('@')
    if len(username) <= 1:
        masked_username = username
    else:
        masked_username = username[0] + '***'
    return f'{masked_username}@{domain}'

def mask_id_card(id_card: str) -> str:
    """èº«ä»½è¯è„±æ•: 3301**********1234"""
    if len(id_card) == 18:
        return id_card[:4] + '**********' + id_card[14:]
    return id_card
```

### 7.4 æƒé™æ§åˆ¶

```python
from functools import wraps
from flask import request, jsonify

def require_auth(f):
    """éœ€è¦ç™»å½•"""
    @wraps(f)
    def decorated_function(*args, **kwargs):
        token = request.headers.get('Authorization')
        if not token:
            return jsonify({'error': 'Unauthorized'}), 401

        user = verify_token(token)
        if not user:
            return jsonify({'error': 'Invalid token'}), 401

        return f(user, *args, **kwargs)
    return decorated_function

def require_role(role: str):
    """éœ€è¦ç‰¹å®šè§’è‰²"""
    def decorator(f):
        @wraps(f)
        def decorated_function(user, *args, **kwargs):
            if user.role != role and user.role != 'super_admin':
                return jsonify({'error': 'Forbidden'}), 403
            return f(user, *args, **kwargs)
        return decorated_function
    return decorator

# ä½¿ç”¨ç¤ºä¾‹
@app.route('/admin/users')
@require_auth
@require_role('admin')
def admin_users(user):
    # åªæœ‰adminå’Œsuper_adminå¯ä»¥è®¿é—®
    pass
```

---

## 8. è·¨è®¾å¤‡åŒæ­¥æ–¹æ¡ˆ

### 8.1 WebSocketå®æ—¶åŒæ­¥

```python
import asyncio
import websockets
import json

class SyncGateway:
    """åŒæ­¥ç½‘å…³"""

    def __init__(self):
        self.connections = {}  # {user_id: {device_id: websocket}}

    async def handle_connection(self, websocket, user_id, device_id):
        """å¤„ç†å®¢æˆ·ç«¯è¿æ¥"""
        # æ³¨å†Œè¿æ¥
        if user_id not in self.connections:
            self.connections[user_id] = {}
        self.connections[user_id][device_id] = websocket

        try:
            # å‘é€åˆå§‹åŒæ­¥æ•°æ®
            await self.send_initial_sync(websocket, user_id, device_id)

            # æŒç»­ç›‘å¬æ¶ˆæ¯
            async for message in websocket:
                await self.handle_message(user_id, device_id, json.loads(message))

        except websockets.ConnectionClosed:
            pass
        finally:
            # ç§»é™¤è¿æ¥
            if user_id in self.connections:
                self.connections[user_id].pop(device_id, None)

    async def handle_message(self, user_id, device_id, message):
        """å¤„ç†åŒæ­¥æ¶ˆæ¯"""
        msg_type = message['type']

        if msg_type == 'sync_progress':
            # åŒæ­¥é˜…è¯»è¿›åº¦
            await self.sync_reading_progress(user_id, device_id, message)

        elif msg_type == 'sync_bookmark':
            # åŒæ­¥ä¹¦ç­¾
            await self.sync_bookmark(user_id, device_id, message)

        elif msg_type == 'sync_note':
            # åŒæ­¥ç¬”è®°
            await self.sync_note(user_id, device_id, message)

    async def broadcast(self, user_id, source_device_id, message):
        """å¹¿æ’­åˆ°ç”¨æˆ·çš„å…¶ä»–è®¾å¤‡"""
        if user_id not in self.connections:
            return

        for device_id, ws in self.connections[user_id].items():
            if device_id != source_device_id:
                await ws.send(json.dumps(message))
```

### 8.2 å†²çªè§£å†³ç­–ç•¥

**ç­–ç•¥1: æœ€æ–°å†™å…¥ä¼˜å…ˆ (Last-Write-Wins)**

é€‚ç”¨äº:
- é˜…è¯»è¿›åº¦
- ç”¨æˆ·åå¥½è®¾ç½®

```python
def resolve_latest_wins(data_a, data_b):
    """æœ€æ–°æ—¶é—´æˆ³çš„æ•°æ®è·èƒœ"""
    if data_a['timestamp'] > data_b['timestamp']:
        return data_a
    else:
        return data_b
```

**ç­–ç•¥2: åˆå¹¶ (Merge)**

é€‚ç”¨äº:
- ä¹¦ç­¾åˆ—è¡¨
- ç¬”è®°åˆ—è¡¨

```python
def resolve_merge(data_a, data_b, merge_type):
    """åˆå¹¶ä¸¤è¾¹çš„æ•°æ®"""
    if merge_type == 'bookmark':
        # åˆå¹¶ä¹¦ç­¾,å»é‡
        bookmarks = data_a['bookmarks'] + data_b['bookmarks']
        unique_bookmarks = {b['id']: b for b in bookmarks}.values()
        return {'bookmarks': list(unique_bookmarks)}
```

---

## 9. æˆå°±ä¸æ¿€åŠ±ä½“ç³»

### 9.1 æˆå°±ç³»ç»Ÿå®ç°

```python
class AchievementSystem:
    """æˆå°±ç³»ç»Ÿ"""

    # æˆå°±å®šä¹‰
    ACHIEVEMENTS = {
        'first_book': {
            'name': 'åˆå‡ºèŒ…åº',
            'description': 'å®Œæˆç¬¬1æœ¬ä¹¦',
            'icon': 'ğŸŒ±',
            'xp': 20,
            'trigger': 'complete_book',
            'threshold': 1
        },
        'ten_books': {
            'name': 'æ¸å…¥ä½³å¢ƒ',
            'description': 'å®Œæˆç¬¬10æœ¬ä¹¦',
            'icon': 'ğŸ“š',
            'xp': 50,
            'trigger': 'complete_book',
            'threshold': 10
        },
        'streak_7': {
            'name': 'æŒä¹‹ä»¥æ’',
            'description': 'è¿ç»­é˜…è¯»7å¤©',
            'icon': 'ğŸŒŸ',
            'xp': 30,
            'trigger': 'reading_streak',
            'threshold': 7
        }
    }

    async def check_achievements(self, user_id: int, trigger: str, value: int):
        """æ£€æŸ¥æ˜¯å¦è§£é”æˆå°±"""
        unlocked = []

        for code, achievement in self.ACHIEVEMENTS.items():
            if achievement['trigger'] == trigger:
                # æ£€æŸ¥æ˜¯å¦å·²è§£é”
                existing = await db.fetchone("""
                    SELECT id FROM user_achievements
                    WHERE user_id = %s AND achievement_code = %s
                """, (user_id, code))

                if not existing and value >= achievement['threshold']:
                    # è§£é”æˆå°±
                    await self.unlock_achievement(user_id, code, achievement)
                    unlocked.append(achievement)

        return unlocked

    async def unlock_achievement(self, user_id: int, code: str, achievement: dict):
        """è§£é”æˆå°±"""
        # 1. æ’å…¥æˆå°±è®°å½•
        await db.execute("""
            INSERT INTO user_achievements
            (user_id, achievement_code, achievement_name, achievement_description,
             badge_icon_url, achievement_points, trigger_type, trigger_value, unlocked_at)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, NOW())
        """, (
            user_id, code, achievement['name'], achievement['description'],
            achievement['icon'], achievement['xp'],
            achievement['trigger'], achievement['threshold']
        ))

        # 2. å¢åŠ ç”¨æˆ·XP
        await self.add_xp(user_id, achievement['xp'], f"è§£é”æˆå°±: {achievement['name']}")

        # 3. æ¨é€é€šçŸ¥
        await notification.send_push(
            user_id,
            title=f"ğŸ‰ è§£é”æ–°æˆå°±: {achievement['name']}",
            body=achievement['description']
        )
```

---

## 10. ç¤¾äº¤äº’åŠ¨è®¾è®¡

### 10.1 å¥½å‹ç³»ç»Ÿ

```python
class FriendshipService:
    """å¥½å‹æœåŠ¡"""

    async def send_friend_request(self, from_user_id: int, to_user_id: int, message: str = None):
        """å‘é€å¥½å‹è¯·æ±‚"""
        # 1. æ£€æŸ¥æ˜¯å¦å·²ç»æ˜¯å¥½å‹
        existing = await db.fetchone("""
            SELECT id FROM user_relationships
            WHERE user_id = %s AND target_user_id = %s
            AND relationship_type = 'friend'
        """, (from_user_id, to_user_id))

        if existing:
            raise ValueError("Already friends")

        # 2. åˆ›å»ºå¥½å‹è¯·æ±‚
        await db.execute("""
            INSERT INTO user_relationships
            (user_id, target_user_id, relationship_type, request_message, request_status)
            VALUES (%s, %s, 'friend', %s, 'pending')
        """, (from_user_id, to_user_id, message))

        # 3. æ¨é€é€šçŸ¥
        from_user = await self.get_user(from_user_id)
        await notification.send_push(
            to_user_id,
            title="æ–°çš„å¥½å‹è¯·æ±‚",
            body=f"{from_user.nickname} è¯·æ±‚æ·»åŠ ä½ ä¸ºå¥½å‹"
        )

    async def accept_friend_request(self, user_id: int, request_id: int):
        """æ¥å—å¥½å‹è¯·æ±‚"""
        # 1. æ›´æ–°è¯·æ±‚çŠ¶æ€
        await db.execute("""
            UPDATE user_relationships
            SET request_status = 'accepted', updated_at = NOW()
            WHERE id = %s AND target_user_id = %s
        """, (request_id, user_id))

        # 2. åˆ›å»ºåå‘å…³ç³»(åŒå‘å¥½å‹)
        request = await db.fetchone("""
            SELECT user_id, target_user_id FROM user_relationships WHERE id = %s
        """, (request_id,))

        await db.execute("""
            INSERT INTO user_relationships
            (user_id, target_user_id, relationship_type, request_status)
            VALUES (%s, %s, 'friend', 'accepted')
        """, (request['target_user_id'], request['user_id']))
```

---

## 11. APIæ¥å£è®¾è®¡

### 11.1 è®¤è¯ç›¸å…³æ¥å£

#### POST /api/v1/auth/send-otp
å‘é€éªŒè¯ç 

**è¯·æ±‚:**
```json
{
  "phone_number": "13800138000",
  "purpose": "register" // register | login | reset_password
}
```

**å“åº”:**
```json
{
  "code": 200,
  "message": "éªŒè¯ç å·²å‘é€",
  "data": {
    "expires_in": 300, // 5åˆ†é’Ÿ
    "retry_after": 60  // 60ç§’åå¯é‡è¯•
  }
}
```

#### POST /api/v1/auth/register
æ³¨å†Œ

**è¯·æ±‚:**
```json
{
  "phone_number": "13800138000",
  "verification_code": "123456",
  "password": "abc123" // å¯é€‰
}
```

**å“åº”:**
```json
{
  "code": 200,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "user_id": 12345,
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "refresh_token": "...",
    "expires_in": 7200,
    "is_new_user": true
  }
}
```

#### POST /api/v1/auth/login
ç™»å½•

**è¯·æ±‚:**
```json
{
  "phone_number": "13800138000",
  "login_type": "password", // password | otp
  "password": "abc123",     // login_type=passwordæ—¶å¿…éœ€
  "verification_code": "123456", // login_type=otpæ—¶å¿…éœ€
  "device_id": "device_xxx"
}
```

**å“åº”:**
```json
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "user_id": 12345,
    "token": "...",
    "refresh_token": "...",
    "user": {
      "id": 12345,
      "username": "user123",
      "nickname": "ä¹¦è™«",
      "avatar_url": "...",
      "level": 3,
      "xp": 850
    }
  }
}
```

### 11.2 ç”¨æˆ·ç›¸å…³æ¥å£

#### GET /api/v1/users/me
è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯

**å“åº”:**
```json
{
  "code": 200,
  "data": {
    "id": 12345,
    "username": "user123",
    "nickname": "ä¹¦è™«",
    "avatar_url": "...",
    "phone_number": "138****5678",
    "level": 3,
    "xp": 850,
    "member_level": 2,
    "profile": {
      "gender": 1,
      "birthday": "1990-01-01",
      "city": "ä¸Šæµ·",
      "bio": "çƒ­çˆ±é˜…è¯»"
    },
    "stats": {
      "followers_count": 120,
      "following_count": 80,
      "books_read_count": 45,
      "reading_days": 230,
      "reading_minutes": 12500
    }
  }
}
```

#### PUT /api/v1/users/profile
æ›´æ–°ä¸ªäººèµ„æ–™

**è¯·æ±‚:**
```json
{
  "nickname": "æ–°æ˜µç§°",
  "bio": "ä¸ªäººç®€ä»‹",
  "city": "ä¸Šæµ·",
  "avatar_url": "..."
}
```

---

## 12. æ€§èƒ½ä¸æ‰©å±•æ€§

### 12.1 ç¼“å­˜ç­–ç•¥

```python
import redis
import json

class UserCache:
    """ç”¨æˆ·ç¼“å­˜æœåŠ¡"""

    def __init__(self, redis_client):
        self.redis = redis_client

    async def get_user(self, user_id: int):
        """è·å–ç”¨æˆ·ä¿¡æ¯(ä¼˜å…ˆä»ç¼“å­˜)"""
        # 1. å°è¯•ä»ç¼“å­˜è·å–
        cache_key = f'user:{user_id}'
        cached = self.redis.get(cache_key)

        if cached:
            return json.loads(cached)

        # 2. ä»æ•°æ®åº“æŸ¥è¯¢
        user = await db.fetch_user(user_id)

        # 3. å†™å…¥ç¼“å­˜(TTL: 1å°æ—¶)
        self.redis.setex(cache_key, 3600, json.dumps(user))

        return user

    async def invalidate_user(self, user_id: int):
        """æ¸…é™¤ç”¨æˆ·ç¼“å­˜"""
        cache_key = f'user:{user_id}'
        self.redis.delete(cache_key)
```

### 12.2 æ•°æ®åº“ä¼˜åŒ–

**ç´¢å¼•ç­–ç•¥:**
```sql
-- é«˜é¢‘æŸ¥è¯¢å­—æ®µå»ºç«‹ç´¢å¼•
CREATE INDEX idx_username ON users(username);
CREATE INDEX idx_phone ON users(phone_number);
CREATE INDEX idx_user_level ON users(level);

-- è”åˆç´¢å¼•
CREATE INDEX idx_user_status_level ON users(status, level);

-- å¤–é”®ç´¢å¼•
CREATE INDEX idx_profile_user_id ON user_profiles(user_id);
```

**åˆ†è¡¨ç­–ç•¥:**
```sql
-- ç™»å½•æ—¥å¿—æŒ‰æœˆåˆ†è¡¨
CREATE TABLE user_login_logs_202510 LIKE user_login_logs;
CREATE TABLE user_login_logs_202511 LIKE user_login_logs;

-- XPè®°å½•æŒ‰ç”¨æˆ·IDèŒƒå›´åˆ†è¡¨
CREATE TABLE user_xp_logs_0 LIKE user_xp_logs; -- user_id: 0-999999
CREATE TABLE user_xp_logs_1 LIKE user_xp_logs; -- user_id: 1000000-1999999
```

---

## 13. æµ‹è¯•éªŒæ”¶æ ‡å‡†

### 13.1 åŠŸèƒ½æµ‹è¯•

| æµ‹è¯•é¡¹ | éªŒæ”¶æ ‡å‡† | ä¼˜å…ˆçº§ |
|-------|---------|--------|
| æ‰‹æœºå·æ³¨å†Œ | éªŒè¯ç æ­£ç¡®å‘é€,æ³¨å†ŒæˆåŠŸåˆ›å»ºç”¨æˆ· | P0 |
| å¯†ç ç™»å½• | å¯†ç éªŒè¯æ­£ç¡®,ç™»å½•æˆåŠŸè¿”å›token | P0 |
| ä¸ªäººèµ„æ–™ç¼–è¾‘ | ä¿®æ”¹ç”Ÿæ•ˆå¹¶å®æ—¶æ›´æ–° | P0 |
| å¤´åƒä¸Šä¼  | æ”¯æŒè£å‰ª,ä¸Šä¼ æˆåŠŸ | P1 |
| XPå¢åŠ  | å®Œæˆä¹¦ç±åXPæ­£ç¡®å¢åŠ  | P0 |
| æˆå°±è§£é” | è§¦å‘æ¡ä»¶åæˆå°±æ­£å¸¸è§£é” | P1 |
| è·¨è®¾å¤‡åŒæ­¥ | 5ç§’å†…åŒæ­¥åˆ°å…¶ä»–è®¾å¤‡ | P0 |
| å¥½å‹è¯·æ±‚ | è¯·æ±‚å‘é€,æ¥å—/æ‹’ç»æ­£å¸¸ | P1 |

### 13.2 æ€§èƒ½æµ‹è¯•

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | æµ‹é‡æ–¹æ³• |
|-----|-------|---------|
| æ³¨å†Œæ¥å£å“åº”æ—¶é—´ | â‰¤ 1500ms | å¹¶å‘100 |
| ç™»å½•æ¥å£å“åº”æ—¶é—´ | â‰¤ 800ms | å¹¶å‘200 |
| ç”¨æˆ·ä¿¡æ¯æŸ¥è¯¢ | â‰¤ 200ms | å¹¶å‘500 |
| è·¨è®¾å¤‡åŒæ­¥å»¶è¿Ÿ | â‰¤ 5s | WebSocket |
| æ•°æ®åº“è¿æ¥æ±  | æœ€å°‘10,æœ€å¤§100 | é…ç½® |

### 13.3 å®‰å…¨æµ‹è¯•

| æµ‹è¯•é¡¹ | éªŒæ”¶æ ‡å‡† |
|-------|---------|
| SQLæ³¨å…¥ | æ‰€æœ‰è¾“å…¥å‚æ•°åŒ–æŸ¥è¯¢,æ— SQLæ³¨å…¥æ¼æ´ |
| XSSæ”»å‡» | æ‰€æœ‰ç”¨æˆ·è¾“å…¥è½¬ä¹‰,æ— XSSæ¼æ´ |
| CSRFé˜²æŠ¤ | TokenéªŒè¯,æ— CSRFæ¼æ´ |
| å¯†ç å¼ºåº¦ | å¼±å¯†ç è¢«æ‹’ç» |
| éªŒè¯ç é˜²åˆ· | é¢‘ç‡é™åˆ¶ç”Ÿæ•ˆ |
| æ•æ„Ÿæ•°æ®åŠ å¯† | æ‰‹æœºå·/èº«ä»½è¯åŠ å¯†å­˜å‚¨ |

---

## 14. å®æ–½è·¯çº¿å›¾

### Phase 1: åŸºç¡€åŠŸèƒ½ (2-3å‘¨)

**Week 1:**
- âœ… æ•°æ®åº“è¡¨è®¾è®¡ä¸åˆ›å»º
- âœ… ç”¨æˆ·æ³¨å†Œ(æ‰‹æœºå·+éªŒè¯ç )
- âœ… ç”¨æˆ·ç™»å½•(å¯†ç /éªŒè¯ç )
- âœ… åŸºç¡€ä¸ªäººèµ„æ–™ç®¡ç†

**Week 2:**
- âœ… ç¬¬ä¸‰æ–¹ç™»å½•(å¾®ä¿¡/QQ)
- âœ… å¤´åƒä¸Šä¼ ä¸è£å‰ª
- âœ… è®¾å¤‡ç®¡ç†
- âœ… ç™»å½•æ—¥å¿—

**Week 3:**
- âœ… å¯†ç ä¿®æ”¹/é‡ç½®
- âœ… éšç§è®¾ç½®
- âœ… åå¥½è®¾ç½®
- âœ… å•å…ƒæµ‹è¯•

### Phase 2: æˆå°±ä¸ç¤¾äº¤ (2-3å‘¨)

**Week 4:**
- âœ… XPç³»ç»Ÿ
- âœ… ç­‰çº§ç³»ç»Ÿ
- âœ… æˆå°±ç³»ç»ŸåŸºç¡€æ¡†æ¶

**Week 5:**
- âœ… å¥½å‹ç³»ç»Ÿ
- âœ… å…³æ³¨ç³»ç»Ÿ
- âœ… ä¸¾æŠ¥å±è”½

**Week 6:**
- âœ… æˆå°±è‡ªåŠ¨è§£é”
- âœ… æ¨é€é€šçŸ¥é›†æˆ
- âœ… é›†æˆæµ‹è¯•

### Phase 3: è·¨è®¾å¤‡åŒæ­¥ (2å‘¨)

**Week 7:**
- âœ… WebSocketåŒæ­¥æœåŠ¡
- âœ… é˜…è¯»è¿›åº¦åŒæ­¥
- âœ… ä¹¦ç­¾åŒæ­¥

**Week 8:**
- âœ… å†²çªæ£€æµ‹ä¸è§£å†³
- âœ… ç¦»çº¿æ•°æ®åˆå¹¶
- âœ… æ€§èƒ½ä¼˜åŒ–

### Phase 4: ä¼˜åŒ–ä¸ä¸Šçº¿ (1-2å‘¨)

**Week 9:**
- âœ… æ€§èƒ½æµ‹è¯•ä¸ä¼˜åŒ–
- âœ… å®‰å…¨åŠ å›º
- âœ… æ–‡æ¡£å®Œå–„

**Week 10:**
- âœ… ç°åº¦å‘å¸ƒ
- âœ… ç›‘æ§ä¸å‘Šè­¦
- âœ… æ­£å¼ä¸Šçº¿

---

## 15. é™„å½•

### 15.1 é”™è¯¯ç å®šä¹‰

| é”™è¯¯ç  | è¯´æ˜ | HTTPçŠ¶æ€ç  |
|-------|------|-----------|
| 1001 | æ‰‹æœºå·å·²æ³¨å†Œ | 400 |
| 1002 | éªŒè¯ç é”™è¯¯ | 400 |
| 1003 | éªŒè¯ç å·²è¿‡æœŸ | 400 |
| 1004 | å¯†ç æ ¼å¼é”™è¯¯ | 400 |
| 1005 | ç”¨æˆ·åå·²å­˜åœ¨ | 400 |
| 2001 | ç”¨æˆ·ä¸å­˜åœ¨ | 404 |
| 2002 | å¯†ç é”™è¯¯ | 401 |
| 2003 | è´¦æˆ·å·²å†»ç»“ | 403 |
| 2004 | è´¦æˆ·å·²é”å®š | 403 |
| 3001 | Tokenæ— æ•ˆ | 401 |
| 3002 | Tokenå·²è¿‡æœŸ | 401 |
| 4001 | æƒé™ä¸è¶³ | 403 |
| 5001 | æœåŠ¡å™¨é”™è¯¯ | 500 |

### 15.2 ç¯å¢ƒå˜é‡é…ç½®

```bash
# æ•°æ®åº“
DB_HOST=localhost
DB_PORT=3306
DB_NAME=library_app
DB_USER=root
DB_PASSWORD=xxxxx

# Redis
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_PASSWORD=xxxxx

# JWT
JWT_SECRET_KEY=your-secret-key
JWT_EXPIRATION=7200  # 2å°æ—¶

# çŸ­ä¿¡æœåŠ¡
SMS_PROVIDER=aliyun
SMS_ACCESS_KEY=xxxxx
SMS_ACCESS_SECRET=xxxxx

# å¯¹è±¡å­˜å‚¨
OSS_ENDPOINT=oss-cn-shanghai.aliyuncs.com
OSS_BUCKET=library-app
OSS_ACCESS_KEY=xxxxx
OSS_ACCESS_SECRET=xxxxx

# åŠ å¯†
ENCRYPTION_MASTER_KEY=32-byte-hex-key
```

---

## ğŸ“ æ€»ç»“

æœ¬æ–‡æ¡£æä¾›äº†å¾®ä¹¦åŒ…ç”¨æˆ·æ¨¡å—çš„å®Œæ•´è®¾è®¡æ–¹æ¡ˆ,æ¶µç›–:
- âœ… å®Œæ•´çš„åŠŸèƒ½éœ€æ±‚ä¸ä¸šåŠ¡æµç¨‹
- âœ… è¯¦ç»†çš„æ•°æ®åº“è®¾è®¡(9å¼ æ ¸å¿ƒè¡¨)
- âœ… å®‰å…¨ä¸éšç§ä¿æŠ¤æ–¹æ¡ˆ
- âœ… è·¨è®¾å¤‡åŒæ­¥æ¶æ„
- âœ… æˆå°±ä¸æ¿€åŠ±ä½“ç³»
- âœ… APIæ¥å£è®¾è®¡
- âœ… æµ‹è¯•éªŒæ”¶æ ‡å‡†
- âœ… å®æ–½è·¯çº¿å›¾

**ä¸‹ä¸€æ­¥è¡ŒåŠ¨:**
1. Reviewæœ¬æ–‡æ¡£,ç¡®è®¤éœ€æ±‚ä¸è®¾è®¡
2. æ­å»ºå¼€å‘ç¯å¢ƒ
3. æŒ‰Phase 1å¼€å§‹å¼€å‘
4. å®šæœŸè¿›è¡Œä»£ç å®¡æŸ¥å’Œæµ‹è¯•

---

**æ–‡æ¡£ç»´æŠ¤:**
- åˆ›å»ºäºº: Claude (UltraThink Mode)
- æœ€åæ›´æ–°: 2025-10-15
- ç‰ˆæœ¬: V2.0
